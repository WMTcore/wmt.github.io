<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="WMTcore" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="不扯犊子 -NOT ALONE">
<meta property="og:type" content="website">
<meta property="og:title" content="大碗拉面">
<meta property="og:url" content="http://www.wmtcore.com/page/2/index.html">
<meta property="og:site_name" content="大碗拉面">
<meta property="og:description" content="不扯犊子 -NOT ALONE">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="大碗拉面">
<meta name="twitter:description" content="不扯犊子 -NOT ALONE">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> 大碗拉面 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?8fc1dcdaa63dc57073d1f217ba27dc7d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">大碗拉面</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
      
        <li class="menu-item menu-item-search">
          <a href="#" class="st-search-show-outputs">
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', '1zo1-KPbS2sqsk4pXnSQ','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">

    

    
    
      
      

      
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/05/nginx-负载均衡和反向代理的基本配置/" itemprop="url">
                  nginx 负载均衡和反向代理的基本配置
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-07-05T17:47:22+08:00" content="2016-07-05">
              2016-07-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/nginx/" itemprop="url" rel="index">
                    <span itemprop="name">nginx</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/05/nginx-负载均衡和反向代理的基本配置/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/05/nginx-负载均衡和反向代理的基本配置/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="u8D1F_u8F7D_u5747_u8861"><a href="#u8D1F_u8F7D_u5747_u8861" class="headerlink" title="负载均衡"></a>负载均衡</h3><ul>
<li>此处指的是选择一种策略，尽量把请求均匀的分布到每一个上游服务器</li>
</ul>
<h4 id="upstream"><a href="#upstream" class="headerlink" title="upstream"></a>upstream</h4><ul>
<li>配置块 http</li>
<li>语法 upstream name{}</li>
<li>定义一个上游服务器的集群，便于反向代理的proxy_pass使用</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">upstream</span> backend &#123;</div><div class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:5566</span> weight=<span class="number">1</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">30s</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="section">server</span> &#123;</div><div class="line">    <span class="attribute">location</span> / &#123;</div><div class="line">        <span class="attribute">proxy_pass</span> http://backend; <span class="comment">#backend指上游服务器</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="server"><a href="#server" class="headerlink" title="server"></a>server</h5><ul>
<li>配置块 upstream</li>
<li>语法 server names[parameters]</li>
<li>指定一台上游服务器的名字 可以是域名，ip，UNIX句柄</li>
</ul>
<table>
<thead>
<tr>
<th>parameters</th>
<th>定义</th>
</tr>
</thead>
<tbody>
<tr>
<td>weight=number</td>
<td>上游服务器转发的权重 默认1</td>
</tr>
<tr>
<td>max_fails=number</td>
<td>在fail_timeout时间内，如果向上游服务器转发失败次数超过number,就认为该服务器在此时间段里不可用，默认1 设为0就不检查失败次数</td>
</tr>
<tr>
<td>fail_timeout=time</td>
<td>用于优化反向代理功能，与连接、读取、响应超时无关，默认10秒</td>
</tr>
<tr>
<td>down</td>
<td>永久下线服务器，只在使用ip_hash有效</td>
</tr>
<tr>
<td>backup</td>
<td>在使用ip_hash时无效 表示上游服务器只是备份服务器，只有在所有非备份上游服务器失效后，才会指向备份</td>
</tr>
</tbody>
</table>
<h5 id="ip_hash"><a href="#ip_hash" class="headerlink" title="ip_hash"></a>ip_hash</h5><ul>
<li>配置块 upstream</li>
<li>语法 ip_hash;</li>
<li>将单个用户的请求固定到某个上游服务器</li>
</ul>
<p>先根据客户端的ip地址计算一个key,将可以按照upstream集群的上游服务器数量进行取模，再根据取模的结果把请求地址转发到相应的上游服务器,不能与weight同时使用，<strong>在标识上游服务器不可用时，要用down不能直接删除，确保转发策略一贯性</strong></p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">upstream <span class="keyword">backend </span>&#123;</div><div class="line"> 	ip_hash<span class="comment">;</span></div><div class="line">    server <span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">5566</span> weight=<span class="number">1</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">30</span>s<span class="comment">;</span></div><div class="line">    server <span class="keyword">backend </span>down<span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="u8BB0_u5F55_u65E5_u5FD7_u65F6_u652F_u6301_u7684_u53D8_u91CF"><a href="#u8BB0_u5F55_u65E5_u5FD7_u65F6_u652F_u6301_u7684_u53D8_u91CF" class="headerlink" title="记录日志时支持的变量"></a>记录日志时支持的变量</h4><table>
<thead>
<tr>
<th>变量名</th>
<th>定义</th>
</tr>
</thead>
<tbody>
<tr>
<td>$upstream_addr</td>
<td>处理请求的上游服务器地址</td>
</tr>
<tr>
<td>$upstream_cache_status</td>
<td>表示是否命中缓存，取值范围：MISS、EXPIRED、UPDATING、SATLE、HIT</td>
</tr>
<tr>
<td>$upstream_status</td>
<td>上游服务器返回的响应中HTTP响应码</td>
</tr>
<tr>
<td>$upstream_response_time</td>
<td>上游服务器响应时间，精度毫秒</td>
</tr>
<tr>
<td>$upstream<em>http</em>$HEADER</td>
<td>http头部，如upstream_http_host</td>
</tr>
</tbody>
</table>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">log_format</span> timing <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] <span class="variable">$request</span> '</span></div><div class="line">	<span class="string">'upstream_response_time <span class="variable">$upstream_response_time</span> '</span></div><div class="line">	<span class="string">'msec <span class="variable">$msec</span> request_time <span class="variable">$request_time</span>'</span>;</div><div class="line"></div><div class="line"><span class="attribute">log_format</span> up_head <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] <span class="variable">$request</span> '</span></div><div class="line">	<span class="string">'upstream_http_content_type <span class="variable">$upstream_http_content_type</span>'</span></div></pre></td></tr></table></figure>
<h3 id="u53CD_u5411_u4EE3_u7406_u914D_u7F6E"><a href="#u53CD_u5411_u4EE3_u7406_u914D_u7F6E" class="headerlink" title="反向代理配置"></a>反向代理配置</h3><h4 id="proxy_pass"><a href="#proxy_pass" class="headerlink" title="proxy_pass"></a>proxy_pass</h4><ul>
<li>语法：proxy_pass URL;</li>
<li>配置块 location、if</li>
</ul>
<p>将当前请求反向代理到URL参数指定的服务器上，URL可以是主机名或ip地址</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">proxy_pass http://localhost:<span class="number">3000</span>/uri/;</div><div class="line"></div><div class="line">可以加上负载均衡 使用upstream</div><div class="line">upstream backend <span class="meta">&#123;...&#125;</span></div><div class="line">server &#123;location / &#123;</div><div class="line">            proxy_pass http://backend; <span class="comment">#backend指上游服务器</span></div><div class="line">        &#125;&#125;</div><div class="line"></div><div class="line">可以把httpz转换成https</div><div class="line">proxy_pass https://<span class="number">192</span>.<span class="number">168</span>.<span class="number">0</span>.<span class="number">1</span>/;</div><div class="line"></div><div class="line">若需要转发host头部</div><div class="line">proxy_set_header <span class="type">Host</span> $host;</div></pre></td></tr></table></figure>
<h4 id="proxy_method"><a href="#proxy_method" class="headerlink" title="proxy_method"></a>proxy_method</h4><ul>
<li>语法：proxy_method method;</li>
<li>配置块 http、server、location</li>
</ul>
<p>转发时的协议方法名<br>proxy_method POST; 客户端的GET请求也会被转发成POST</p>
<h4 id="proxy_hide_header"><a href="#proxy_hide_header" class="headerlink" title="proxy_hide_header"></a>proxy_hide_header</h4><ul>
<li>语法：proxy_hide_header the_header;</li>
<li>配置块 http、server、location</li>
</ul>
<p>Nginx会将上游服务器的响应转发给客户端，但默认不会转发以下HTTP头部字段：Date、Server、X-Pad和X-Accel-*.使用proxy_hide_header可以指定哪些不能转发</p>
<p>proxy_hide_header Cache-Control;</p>
<h4 id="proxy_pass_header"><a href="#proxy_pass_header" class="headerlink" title="proxy_pass_header"></a>proxy_pass_header</h4><ul>
<li>语法：proxy_pass_header the_header;</li>
<li>配置块 http、server、location</li>
</ul>
<p>将原来禁止转发的header设为转发</p>
<h4 id="proxy_pass_request_body"><a href="#proxy_pass_request_body" class="headerlink" title="proxy_pass_request_body"></a>proxy_pass_request_body</h4><ul>
<li>语法：proxy_pass_request_body on|off;</li>
<li>默认 on;</li>
<li>配置块 http、server、location<br>是否向上游转发http body</li>
</ul>
<h4 id="proxy_pass_request_headers"><a href="#proxy_pass_request_headers" class="headerlink" title="proxy_pass_request_headers"></a>proxy_pass_request_headers</h4><ul>
<li>语法：proxy_pass_request_headers on|off;</li>
<li>默认 on;</li>
<li>配置块 http、server、location<br>是否向上游转发http header</li>
</ul>
<h4 id="prxoy_redirect"><a href="#prxoy_redirect" class="headerlink" title="prxoy_redirect"></a>prxoy_redirect</h4><ul>
<li>语法：prxoy_redirect [default|off|redirect rep|replacement]];</li>
<li>默认 default;</li>
<li>配置块 http、server、location</li>
</ul>
<p>当上游返回响应是重定向或刷新请求（301，302),proxy_redirect 可以重设HTTP头部的location或refresh字段。</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">proxy_redirect <span class="symbol">http:</span>/<span class="regexp">/localhost:8000/two</span><span class="regexp">/ http:/</span><span class="regexp">/frontend/one</span><span class="regexp">/;</span></div><div class="line"></div><div class="line">对location字段的URI是http:/<span class="regexp">/localhost:8000/two</span><span class="regexp">/some/uri</span>.实际转发给客户端的是<span class="symbol">http:</span>/<span class="regexp">/frontend/one</span><span class="regexp">/;</span></div><div class="line"></div><div class="line">可以使用ngx-http-core-module提供的变量来设置</div><div class="line"></div><div class="line">proxy_redirect http:/<span class="regexp">/localhost:8000/</span> <span class="symbol">http:</span>/<span class="regexp">/$host:$server_port/</span>;</div><div class="line"></div><div class="line">可以省略replacement参数的主机名部分，这时会用虚拟主机名称填充</div><div class="line">proxy_redirect <span class="symbol">http:</span>/<span class="regexp">/localhost:8000/two</span><span class="regexp">/ /one</span><span class="regexp">/;</span></div><div class="line"></div><div class="line">使用default参数时，会按照proxy_pass配置项和所属的location配置项重组</div><div class="line"></div><div class="line">location /one<span class="regexp">/ &#123;</span></div><div class="line">  proxy_pass http:/<span class="regexp">/upstream:port/two</span><span class="regexp">/;</span></div><div class="line">  proxy_redirect default;</div><div class="line">&#125;</div><div class="line">等于</div><div class="line">location /one<span class="regexp">/ &#123;</span></div><div class="line">	proxy_pass http:/<span class="regexp">/upstream:port/two</span><span class="regexp">/;</span></div><div class="line">	proxy_redirect http:/<span class="regexp">/upstream:port/two</span><span class="regexp">/ /one</span><span class="regexp">/;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="proxy_next_upstream"><a href="#proxy_next_upstream" class="headerlink" title="proxy_next_upstream"></a>proxy_next_upstream</h4><ul>
<li>语法：proxy_next_upstream [error|timeout|invalid_header|http_500|http_502|http_503|http_504|http_404|off];</li>
<li>默认 error timeout;</li>
<li>配置块 http、server、location</li>
</ul>
<p>当向一台上游转发请求出错时，继续换一台处理<br>（invaild_header 上游响应不合法）</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/01/pm2介绍/" itemprop="url">
                  pm2
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-07-01T15:15:27+08:00" content="2016-07-01">
              2016-07-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index">
                    <span itemprop="name">nodejs</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/01/pm2介绍/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/01/pm2介绍/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <ul>
<li>pm2 是一个带有负载均衡功能的Node应用的进程管理器</li>
<li>内建负载均衡（使用Node cluster 集群模块）</li>
<li>后台运行</li>
<li>0秒停机重载，热升级</li>
<li>具有Ubuntu和CentOS 的启动脚本</li>
<li>停止不稳定的进程（避免无限循环）</li>
<li>控制台检测</li>
<li>提供 HTTP API</li>
<li>远程控制和实时的接口API ( Nodejs 模块,允许和PM2进程管理器交互 )</li>
<li><a href="https://github.com/Unitech/pm2" target="_blank">github</a></li>
</ul>
<table>
<thead>
<tr>
<th>command</th>
<th>explain</th>
</tr>
</thead>
<tbody>
<tr>
<td>$ npm install pm2 -g</td>
<td># Install PM2</td>
</tr>
<tr>
<td>$ pm2 start app.js</td>
<td># Start, Daemonize and auto restart application</td>
</tr>
<tr>
<td>$ pm2 start app.js -i 4</td>
<td># Start 4 instances of application in cluster mode it will load balance network queries to each app</td>
</tr>
<tr>
<td><strong>$ pm2 start app.js –name=”api”</strong></td>
<td># Start application and name it “api”</td>
</tr>
<tr>
<td>$ pm2 start app.js –watch</td>
<td># Restart application on file change</td>
</tr>
<tr>
<td>$ pm2 start script.sh</td>
<td># Start bash script</td>
</tr>
<tr>
<td>$ pm2 list</td>
<td># List all processes started with PM2</td>
</tr>
<tr>
<td><strong>$ pm2 monit</strong></td>
<td># Display memory and cpu usage of each app</td>
</tr>
<tr>
<td>$ pm2 show [app-name]</td>
<td># Show all informations about application</td>
</tr>
<tr>
<td><strong>$ pm2 logs</strong></td>
<td># Display logs of all apps</td>
</tr>
<tr>
<td>$ pm2 logs [app-name]</td>
<td># Display logs for a specific app</td>
</tr>
<tr>
<td>$ pm2 flush</td>
<td></td>
</tr>
<tr>
<td><strong>$ pm2 stop all</strong></td>
<td># Stop all apps</td>
</tr>
<tr>
<td>$ pm2 stop 0</td>
<td># Stop process with id 0</td>
</tr>
<tr>
<td><strong>$ pm2 restart all</strong></td>
<td># Restart all apps</td>
</tr>
<tr>
<td><strong>$ pm2 reload all</strong></td>
<td># Reload all apps in cluster mode</td>
</tr>
<tr>
<td>$ pm2 gracefulReload all</td>
<td># Graceful reload all apps in cluster mode</td>
</tr>
<tr>
<td>$ pm2 delete all</td>
<td># Kill and delete all apps</td>
</tr>
<tr>
<td>$ pm2 delete 0</td>
<td># Delete app with id 0</td>
</tr>
<tr>
<td>$ pm2 scale api 10</td>
<td># Scale app with name api to 10 instances</td>
</tr>
<tr>
<td>$ pm2 reset [app-name]</td>
<td># Reset number of restart for [app-name]</td>
</tr>
<tr>
<td>$ pm2 startup</td>
<td># Generate a startup script to respawn PM2 on boot</td>
</tr>
<tr>
<td>$ pm2 save</td>
<td># Save current process list</td>
</tr>
<tr>
<td>$ pm2 resurrect</td>
<td># Restore previously save processes</td>
</tr>
<tr>
<td>$ pm2 update</td>
<td># Save processes, kill PM2 and restore processes</td>
</tr>
<tr>
<td>$ pm2 generate</td>
<td># Generate a sample json configuration file</td>
</tr>
<tr>
<td>$ pm2 deploy app.json prod setup</td>
<td># Setup “prod” remote server</td>
</tr>
<tr>
<td>$ pm2 deploy app.json prod</td>
<td># Update “prod” remote server</td>
</tr>
<tr>
<td>$ pm2 deploy app.json prod revert 2</td>
<td># Revert “prod” remote server by 2</td>
</tr>
<tr>
<td>$ pm2 module:generate [name]</td>
<td># Generate sample module with name [name]</td>
</tr>
<tr>
<td>$ pm2 install pm2-logrotate</td>
<td># Install module (here a log rotation system)</td>
</tr>
<tr>
<td>$ pm2 uninstall pm2-logrotate</td>
<td># Uninstall module</td>
</tr>
<tr>
<td>$ pm2 publish</td>
<td># Increment version, git push and npm publish</td>
</tr>
</tbody>
</table>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/08/redux-学习笔记（1）/" itemprop="url">
                  redux 学习笔记（1）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-06-08T10:24:46+08:00" content="2016-06-08">
              2016-06-08
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/前端/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/06/08/redux-学习笔记（1）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/06/08/redux-学习笔记（1）/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="redux_u7684_u4F5C_u7528"><a href="#redux_u7684_u4F5C_u7528" class="headerlink" title="redux的作用"></a>redux的作用</h3><p><img src="/../picture/redux流程.png" alt="Smaller icon"></p>
<p>Redux 主要分为三个部分 Action、Reducer、及 Store</p>
<h4 id="action"><a href="#action" class="headerlink" title="action"></a>action</h4><ul>
<li>action用来传递操作 State 的信息,以 Javascript Plain Object 的形式存在，形如</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attribute">type</span>: <span class="string">'ADD_FILM'</span>,</div><div class="line">  name: <span class="string">'Mission: Impossible'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>type 属性是必要的，用来表达处理 state 数据的方式，其他属性任意，建议简单</p>
<p>但为了方便组织，可以创建函数来生产 action，即Action Creator</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">function</span> <span class="title">addFilm</span>(name) &#123;</div><div class="line">  <span class="keyword">return</span> <span class="type">&#123;</span> <span class="keyword">type</span>: <span class="symbol">'ADD_FILM</span>', name: name &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Reducer"><a href="#Reducer" class="headerlink" title="Reducer"></a>Reducer</h4><ul>
<li>处理action传达需要操作的信息</li>
<li>通过传入旧的 state 和指示操作的 action 来更新 state</li>
</ul>
<p>Reducer 根据传入的<strong> action.type</strong> 来匹配 case 进行不同的 state 更新</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">function films(<span class="keyword">state</span> = initialState, action) &#123;</div><div class="line">  switch (action.type) &#123;</div><div class="line"> </div><div class="line">  case 'ADD_FILM':</div><div class="line">    // 更新 <span class="keyword">state</span> 中的 films 字段</div><div class="line">    return [&#123;</div><div class="line">      id: <span class="keyword">state</span>.films.reduce((<span class="keyword">max</span>Id, film) =&gt; Math.<span class="keyword">max</span>(film.id, <span class="keyword">max</span>Id), -<span class="number">1</span>) + <span class="number">1</span>,</div><div class="line">      name: action.name</div><div class="line">    &#125;, ...<span class="keyword">state</span>];</div><div class="line"> </div><div class="line">  case 'DELETE_FILM':</div><div class="line">    return <span class="keyword">state</span>.films.filter(film =&gt;</div><div class="line">        film.id !== action.id</div><div class="line">    );</div><div class="line"> </div><div class="line">  case 'SHOW_ALL_FILM':</div><div class="line">    return Object.assign(&#123;&#125;, <span class="keyword">state</span>, &#123;</div><div class="line">        visibilityFilter: action.filter</div><div class="line">      &#125;);</div><div class="line"> //不要修改 <span class="keyword">state</span>。 使用 Object.assign() 新建了一个副本</div><div class="line">  <span class="keyword">default</span>:</div><div class="line">    return <span class="keyword">state</span>;</div><div class="line">    //在 <span class="keyword">default</span> 情况下返回旧的 <span class="keyword">state</span>。遇到未知的 action 时，一定要返回旧的 <span class="keyword">state</span>。</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>当 action.type变多时，可以按照功能拆分，在通过组合函数合并</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">function rootReducer(<span class="keyword">state</span> = &#123;&#125;, action) &#123;</div><div class="line">  return &#123;</div><div class="line">    films: filmReducer(<span class="keyword">state</span>.films, action),</div><div class="line">    filter: filterReducer(<span class="keyword">state</span>.filter, action)</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line"> // rootReducer 将不同部分的 <span class="keyword">state</span> 传给对应的 reducer 处理，最终合并所有 reducer 的返回值，组成整个<span class="keyword">state</span>。</div><div class="line"> </div><div class="line"> //使用Redux 提供的 combineReducers() 方法</div><div class="line">import &#123; combineReducers &#125; <span class="keyword">from</span> 'redux'</div><div class="line"></div><div class="line">var rootReducer = combineReducers(&#123;</div><div class="line">    films: filmReducer,</div><div class="line">    filter: filterReducer</div><div class="line">  &#125;);</div><div class="line">  </div><div class="line"> //combineReducers() 将调用一系列 reducer，并根据对应的 key 来筛选出 <span class="keyword">state</span> 中的一部分数据给相应的 reducer，这样也意味着每一个小的 reducer 将只能处理 <span class="keyword">state</span> 的一部分数据</div></pre></td></tr></table></figure>
<h4 id="Store"><a href="#Store" class="headerlink" title="Store"></a>Store</h4><ul>
<li>衔接action和reducer</li>
</ul>
<p>Store 是单一的,维护着一个全局的 State，并且根<strong>据 Action 来进行事件分发处理 State</strong>,Store 是一个把 Action 和 Reducer 结合起来的对象。</p>
<p>生成store</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123;createStore &#125; <span class="keyword">from</span> <span class="string">'redux'</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> store = createStore(rootReducer);</div></pre></td></tr></table></figure>
<p>store 对象可以简单的理解为如下形式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">reducer, initialState</span>) </span>&#123;</div><div class="line">    <span class="comment">//闭包私有变量 </span></div><div class="line">    <span class="keyword">var</span> currentReducer = reducer;</div><div class="line">    <span class="keyword">var</span> currentState = initialState;</div><div class="line">    <span class="keyword">var</span> listeners = [];</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getState</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="keyword">return</span> currentState;</div><div class="line">    &#125;    </div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">listener</span>) </span>&#123;</div><div class="line">      listeners.push(listener);</div><div class="line">      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">unsubscribe</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> index = listeners.indexOf(listener);</div><div class="line">        listeners.splice(index, <span class="number">1</span>);</div><div class="line">      &#125;;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">action</span>) </span>&#123;</div><div class="line">        currentState = currentReducer(currentState, action);</div><div class="line">        listeners.slice().forEach(<span class="function"><span class="params">listener</span> =&gt;</span> listener());</div><div class="line">        <span class="keyword">return</span> action;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//返回一个包含可访问闭包变量的公有方法</span></div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">      dispatch,</div><div class="line">      subscribe,</div><div class="line">      getState</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>store.getState() 用来获取 state 数据。<br>store.subscribe(listener) 用于注册监听函数。每当 state 数据更新时，将会触发监听函数。<br>store.dispatch(action) 是用于将一个 action 对象发送给 reducer 进行处理</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">store</span><span class="selector-class">.dispatch</span>(&#123;</div><div class="line">  <span class="attribute">type</span>: <span class="string">'ADD_FILM'</span>,</div><div class="line">  name: <span class="string">'Mission: Impossible'</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h4><ul>
<li>Connect 组件主要为 React 组件提供 store 中的部分 state 数据 及 dispatch 方法</li>
</ul>
<p>通过<strong>import { connect } from ‘react-redux’</strong>将state的值和action绑定到组件的props上</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">import &#123; connect &#125; <span class="keyword">from</span> 'react-redux'</div><div class="line">import Counter <span class="keyword">from</span> '../components/Counter' //一个组件</div><div class="line">import * as CounterActions <span class="keyword">from</span> '../actions/counter'</div><div class="line"></div><div class="line">//将<span class="keyword">state</span>.counter绑定到props的counter</div><div class="line">// <span class="keyword">state</span> 将由 store 提供</div><div class="line">function mapStateToProps(<span class="keyword">state</span>) &#123;</div><div class="line">  return &#123;</div><div class="line">    counter: <span class="keyword">state</span>.counter</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//将action的所有方法绑定到props上</div><div class="line">function mapDispatchToProps(dispatch) &#123;</div><div class="line">  return bindActionCreators(CounterActions, dispatch)</div><div class="line">&#125;</div><div class="line"></div><div class="line">//通过react-redux提供的connect方法将我们需要的<span class="keyword">state</span>中的数据和actions中的方法绑定到props上</div><div class="line">export <span class="keyword">default</span> connect(mapStateToProps, CounterActions)(Counter)</div></pre></td></tr></table></figure>
<h4 id="saga"><a href="#saga" class="headerlink" title="saga"></a>saga</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123;</div><div class="line">  takeEvery</div><div class="line">&#125; <span class="keyword">from</span> <span class="string">'redux-saga'</span></div><div class="line"><span class="keyword">import</span> &#123;</div><div class="line">  call,</div><div class="line">  put,</div><div class="line">  fork,</div><div class="line">  take,</div><div class="line">  cancel</div><div class="line">&#125; <span class="keyword">from</span> <span class="string">'redux-saga/effects'</span></div><div class="line"><span class="keyword">import</span> &#123;</div><div class="line">  GET_LOGINED_REQUEST,</div><div class="line">  LOGIN_REQUEST</div><div class="line">&#125; <span class="keyword">from</span> <span class="string">'./login.js'</span></div><div class="line"><span class="keyword">import</span> &#123;</div><div class="line">  loginAPI,</div><div class="line">  loginedAPI</div><div class="line">&#125; <span class="keyword">from</span> <span class="string">'../../../api'</span></div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span>* <span class="title">watchRequestLogined</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">yield</span> takeEvery(GET_LOGINED_REQUEST, queryFlow)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span>* <span class="title">queryFlow</span>(<span class="params">action</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> task = <span class="keyword">yield</span> fork(logined)</div><div class="line">  <span class="keyword">yield</span> take(LOGIN_CANCEL)</div><div class="line">  <span class="keyword">yield</span> cancel(task)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span>* <span class="title">logined</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">const</span> response = <span class="keyword">yield</span> call(loginedAPI)</div><div class="line">    <span class="keyword">yield</span> put(&#123;</div><div class="line">      <span class="attr">type</span>: LOGIN_SUCCESS,</div><div class="line">      response</div><div class="line">    &#125;)</div><div class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</div><div class="line">    <span class="keyword">yield</span> put(&#123;</div><div class="line">      <span class="attr">type</span>: LOGIN_CANCEL,</div><div class="line">      error</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span>* <span class="title">watchRequestLogin</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">yield</span> takeEvery(LOGIN_REQUEST, loginFlow)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span>* <span class="title">authorize</span>(<span class="params">&#123;account, password&#125;</span>)</span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">const</span> response = <span class="keyword">yield</span> call(loginAPI, &#123;</div><div class="line">      account,</div><div class="line">      password</div><div class="line">    &#125;)</div><div class="line">    <span class="keyword">yield</span> put(&#123;</div><div class="line">      <span class="attr">type</span>: LOGIN_SUCCESS,</div><div class="line">      response</div><div class="line">    &#125;)</div><div class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</div><div class="line">    <span class="keyword">yield</span> put(&#123;</div><div class="line">      <span class="attr">type</span>: LOGIN_ERROR,</div><div class="line">      error</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span>* <span class="title">loginFlow</span>(<span class="params">action</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> &#123; account, password &#125; = action.payload</div><div class="line">  <span class="keyword">const</span> task = <span class="keyword">yield</span> fork(authorize, &#123; account, password &#125;)</div><div class="line">  <span class="keyword">yield</span> take(LOGIN_CANCEL)</div><div class="line">  <span class="keyword">yield</span> cancel(task)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/01/Flux/" itemprop="url">
                  Flux
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-06-01T16:03:51+08:00" content="2016-06-01">
              2016-06-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/前端/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/06/01/Flux/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/06/01/Flux/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="u7B80_u4ECB"><a href="#u7B80_u4ECB" class="headerlink" title="简介"></a>简介</h3><ul>
<li>单向的数据流动</li>
<li>Flux应用主要包括三部分：dispatcher、store和views（React components）</li>
</ul>
<p><img src="/../picture/flux-flow.png" alt="Resize icon"></p>
<h3 id="dispatcher_uFF08_u8C03_u5EA6_u8005_uFF09"><a href="#dispatcher_uFF08_u8C03_u5EA6_u8005_uFF09" class="headerlink" title="dispatcher（调度者）"></a>dispatcher（调度者）</h3><ul>
<li>管理所有的数据流</li>
<li>本质store callback 的注册表，用来向stores分发action，可以指定注册的callback的执行顺序来管理store之间的依赖</li>
</ul>
<h3 id="store_28_u4ED3_u5E93_29"><a href="#store_28_u4ED3_u5E93_29" class="headerlink" title="store(仓库)"></a>store(仓库)</h3><ul>
<li>包含应用的状态和逻辑，管理多个对象状态</li>
<li>在dispatcher注册，并提供相应的回调</li>
<li>更新后向应用广播change事件，view响应并重新获取数据</li>
</ul>
<h3 id="action"><a href="#action" class="headerlink" title="action"></a>action</h3><ul>
<li>dispatcher提供了一个可以允许我们向store中触发分发的方法</li>
</ul>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/支付宝notify-异步通知与https的问题/" itemprop="url">
                  支付宝notify 异步通知与https的问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-05-13T15:36:49+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/支付宝notify-异步通知与https的问题/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/支付宝notify-异步通知与https的问题/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="u95EE_u9898_u548C_u89E3_u51B3_u65B9_u6CD5"><a href="#u95EE_u9898_u548C_u89E3_u51B3_u65B9_u6CD5" class="headerlink" title="问题和解决方法"></a>问题和解决方法</h3><p>在对接支付宝时，发生了这样的问题,使用http链接时，支付宝notify是没有问题的，但换成https后便通知不到了</p>
<p>最可能的问题便是<strong>ssl证书出错</strong>了,注意支付宝不支持自签名证书（<a href="https://doc.open.alipay.com/doc2/detail?treeId=66&amp;articleId=104422&amp;docType=1）" target="_blank" rel="external">https://doc.open.alipay.com/doc2/detail?treeId=66&amp;articleId=104422&amp;docType=1）</a></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">去这个网站检测下你的CSR吧</div><div class="line">https:<span class="regexp">//</span>cryptoreport.websecurity.symantec.com<span class="regexp">/checker/</span>views<span class="regexp">/csrCheck.jsp</span></div></pre></td></tr></table></figure>
<h3 id="u4E8B_u60C5_u7ECF_u8FC7"><a href="#u4E8B_u60C5_u7ECF_u8FC7" class="headerlink" title="事情经过"></a>事情经过</h3><p>某天，同事们偷偷给网站加了安全套接字，把http换成了https,于是我负责的支付模块就出错了。</p>
<p>一开始，我就简单改了config,提交给支付宝的notify_url改成了https。本以为就没问题了，但在我又付出了￥0.01的巨款后，发现支付宝还是没有通知过来。。然后就懵逼了</p>
<p><img src="/../picture/懵逼.jpg" alt="Smaller icon"></p>
<p>懵逼了大概7.8秒后，我就去百度了一下、、、我居然去百度了一下。有人说原因是:</p>
<blockquote>
<p>支付宝对ssl证书也有检查，而那种免费的ssl证书通不过检查。后来没办法就只好改成http notify了 </p>
</blockquote>
<p>好吧。。。这种解决方法，这尼玛根本就不是个解决方案、</p>
<p>注：俺们公司用的CA是GeoTrust,不是他们说的免费证书。顺带感叹下做CA真赚钱</p>
<p>于是又去问支付宝客服，给了他交易号，让他帮我查了下日志,就是这样的<br><img src="/../picture/alipaylog.png" alt="Smaller icon"></p>
<p>http状态码是0耶。看来支付宝确实没有去访问我们的服务器嘛。看来确实在ssl证书检查这块了，但还不清楚是什么问题，还是问问Google吧~（推荐翻墙工具：<a href="http://www.ishadowsocks.net）" target="_blank" rel="external">http://www.ishadowsocks.net）</a></p>
<p>Google帮我搜到了支付宝的这个<a href="https://doc.open.alipay.com/doc2/detail?treeId=66&amp;articleId=104422&amp;docType=1页面(别问我为什么之前没看到。。支付宝文档太多了，我有点眼花),其中对异步通知是这么说的：" target="_blank" rel="external">https://doc.open.alipay.com/doc2/detail?treeId=66&amp;articleId=104422&amp;docType=1页面(别问我为什么之前没看到。。支付宝文档太多了，我有点眼花),其中对异步通知是这么说的：</a></p>
<blockquote>
<p>需确认页面是http还是https，如果是https，那么需要安装ssl证书，证书要求有如下：<br>要求“正规的证书机构签发，不支持自签名”，如果不理解请咨询证书供应商。<br>域名证书检测地址参考：<a href="https://cryptoreport.websecurity.symantec.com/checker/" target="_blank" rel="external">https://cryptoreport.websecurity.symantec.com/checker/</a></p>
</blockquote>
<p>然后就拿着csr去检测了。。靠，果然有鬼（毕竟不是我写的）~~然后改好重新部署</p>
<p>再付出巨款做测试，终于等来支付宝敲门啦</p>
<h3 id="u4E8B_u6545_u603B_u7ED3"><a href="#u4E8B_u6545_u603B_u7ED3" class="headerlink" title="事故总结"></a>事故总结</h3><p>不能说是事故，，因为网站还在测试阶段。。否则，我就该引咎辞职了（宝宝心里苦啊、、）</p>
<ol>
<li>仔细看文档 </li>
<li>不要用百度</li>
</ol>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/openssl生成ssl证书及向申请CA流程/" itemprop="url">
                  openssl生成ssl证书及向申请CA流程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-05-13T10:57:49+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/openssl生成ssl证书及向申请CA流程/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/openssl生成ssl证书及向申请CA流程/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="u751F_u6210key"><a href="#u751F_u6210key" class="headerlink" title="生成key"></a>生成key</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">openssl genrsa -des3 -out prvtkey<span class="selector-class">.pem</span> <span class="number">2048</span> </div><div class="line">或者无密码保护的</div><div class="line">openssl genrsa -out prvtkey<span class="selector-class">.pem</span> <span class="number">2048</span></div></pre></td></tr></table></figure>
<h3 id="u751F_u6210-csr_28_u7528_u8FD9_u4E2A_u5411_u6570_u5B57_u8BC1_u4E66_u9881_u53D1_u673A_u6784_uFF08_u5373CA_uFF09_u7533_u8BF7_u4E00_u4E2A_u6570_u5B57_u8BC1_u4E66_29"><a href="#u751F_u6210-csr_28_u7528_u8FD9_u4E2A_u5411_u6570_u5B57_u8BC1_u4E66_u9881_u53D1_u673A_u6784_uFF08_u5373CA_uFF09_u7533_u8BF7_u4E00_u4E2A_u6570_u5B57_u8BC1_u4E66_29" class="headerlink" title="生成.csr(用这个向数字证书颁发机构（即CA）申请一个数字证书)"></a>生成.csr(用这个向数字证书颁发机构（即CA）申请一个数字证书)</h3><figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl req -<span class="keyword">new</span> -key prvtkey.pem -<span class="keyword">out</span> cert.csr</div></pre></td></tr></table></figure>
<p>然后填写信息，注意<strong>Common Name (eg, your websites domain name)</strong>，要填写网站域名,如:pay.abc.com</p>
<p>生成的.csr文件是否规范可以在这检测：<br><a href="https://cryptoreport.websecurity.symantec.com/checker/views/csrCheck.jsp" target="_blank" rel="external">https://cryptoreport.websecurity.symantec.com/checker/views/csrCheck.jsp</a></p>
<p>然后向CA申请数字证书，再用CA给的cacert.pem替换原来的prvtkey.pem</p>
<h3 id="u81EA_u5EFACA"><a href="#u81EA_u5EFACA" class="headerlink" title="自建CA"></a>自建CA</h3><p><a href="http://www.cnblogs.com/AloneSword/p/3809002.html" target="_blank" rel="external">http://www.cnblogs.com/AloneSword/p/3809002.html</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/12/js中一堆凌乱的小知识/" itemprop="url">
                  js中一堆凌乱的小知识
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-05-12T11:34:45+08:00" content="2016-05-12">
              2016-05-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/12/js中一堆凌乱的小知识/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/12/js中一堆凌乱的小知识/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h4 id="setTimeout_clearTimeout"><a href="#setTimeout_clearTimeout" class="headerlink" title="setTimeout clearTimeout"></a>setTimeout clearTimeout</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">var</span> timer=setTimeout</div><div class="line"></div><div class="line"><span class="function"><span class="title">clearTimeout</span><span class="params">(timer)</span></span></div></pre></td></tr></table></figure>
<h4 id="u6570_u7EC4_u6DF1_u62F7_u8D1D"><a href="#u6570_u7EC4_u6DF1_u62F7_u8D1D" class="headerlink" title="数组深拷贝"></a>数组深拷贝</h4><figure class="highlight delphi"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> a=[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</div><div class="line">b=a.slice(<span class="number">0</span>,[<span class="keyword">end</span>])</div><div class="line">slice 方法返回一个 <span class="keyword">Array</span> 对象</div><div class="line"></div><div class="line">slice 方法一直复制到 <span class="keyword">end</span> 所指定的元素</div><div class="line">b=a.concat();</div></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/22/hate-css-1/" itemprop="url">
                  hate css of 选择器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-04-22T08:58:18+08:00" content="2016-04-22">
              2016-04-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/hate/" itemprop="url" rel="index">
                    <span itemprop="name">hate</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/22/hate-css-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/22/hate-css-1/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="u9009_u62E9_u5668"><a href="#u9009_u62E9_u5668" class="headerlink" title="选择器"></a>选择器</h3><h4 id="u7EE7_u627F"><a href="#u7EE7_u627F" class="headerlink" title="继承"></a>继承</h4><ul>
<li>子元素从父元素继承属性，<code>IE/Windows 直到 IE6 还存在相关的问题，在表格内的字体样式会被忽略。</code></li>
<li>针对子元素创建规则，则可摆脱继承</li>
</ul>
<h4 id="u5143_u7D20_u9009_u62E9_u5668"><a href="#u5143_u7D20_u9009_u62E9_u5668" class="headerlink" title="元素选择器"></a>元素选择器</h4><ul>
<li>文档的元素就是最基本的选择器 比如 p、h1、em、a，甚至可以是 html 本身</li>
</ul>
<h4 id="u9009_u62E9_u5668_u5206_u7EC4"><a href="#u9009_u62E9_u5668_u5206_u7EC4" class="headerlink" title="选择器分组"></a>选择器分组</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">h2</span>, <span class="selector-tag">p</span> &#123;<span class="attribute">color</span>:gray;&#125;</div></pre></td></tr></table></figure>
<p>将 h2 和 p 选择器放在规则左边，然后用逗号分隔，就定义了一个规则。其右边的样式（color:gray;）将应用到这两个选择器所引用的元素。逗号告诉浏览器，规则中包含两个不同的选择器</p>
<ul>
<li>通配符选择器 *,与任何元素匹配</li>
</ul>
<h4 id="u7C7B_u9009_u62E9_u5668"><a href="#u7C7B_u9009_u62E9_u5668" class="headerlink" title="类选择器"></a>类选择器</h4><ul>
<li>class </li>
</ul>
<p><code>结合元素选择器</code> </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">p</span><span class="selector-class">.important</span> &#123;<span class="attribute">color</span>:red;&#125; <span class="comment">//匹配 class 属性包含 important 的所有 p 元素</span></div></pre></td></tr></table></figure>
<p><code>class 值中可能包含一个词列表，各个词之间用空格分隔</code></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt; <span class="selector-tag">p</span> class=<span class="string">"important warning"</span>&gt;</div><div class="line">This paragraph is <span class="selector-tag">a</span> very important warning.</div><div class="line">&lt; /p&gt;</div><div class="line"></div><div class="line"><span class="selector-class">.important</span><span class="selector-class">.warning</span> &#123;<span class="attribute">background</span>:silver;&#125;<span class="comment">//class 中同时包含 important 和 warning</span></div></pre></td></tr></table></figure>
<p><code>在 IE7 之前的版本中，不同平台的 Internet Explorer 都不能正确地处理多类选择器</code></p>
<h4 id="ID_u9009_u62E9_u5668"><a href="#ID_u9009_u62E9_u5668" class="headerlink" title="ID选择器"></a>ID选择器</h4><ul>
<li>ID 选择器前面有一个 # 号</li>
<li>不能使用 ID 词列表</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-id">#intro</span> &#123;<span class="attribute">font-weight</span>:bold;&#125;</div></pre></td></tr></table></figure>
<h4 id="u5C5E_u6027_u9009_u62E9_u5668"><a href="#u5C5E_u6027_u9009_u62E9_u5668" class="headerlink" title="属性选择器"></a>属性选择器</h4><figure class="highlight scss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">*<span class="selector-attr">[title]</span> &#123;<span class="attribute">color</span>:red;&#125;<span class="comment">// 把包含标题（title）的所有元素变为红色</span></div><div class="line"><span class="selector-tag">a</span><span class="selector-attr">[href]</span> &#123;<span class="attribute">color</span>:red;&#125; <span class="comment">// 对有 href 属性的锚（a 元素）应用样式</span></div><div class="line"><span class="selector-tag">a</span><span class="selector-attr">[href]</span><span class="selector-attr">[title]</span> &#123;<span class="attribute">color</span>:red;&#125; <span class="comment">//将同时有 href 和 title 属性的 HTML 超链接的文本设置为红色</span></div></pre></td></tr></table></figure>
<p><code>根据具体属性值选择</code></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//将指向 Web 服务器上某个指定文档的超链接变成红色</div><div class="line">a[href="http://www.w3school.com.cn/about_us.asp"] &#123;color: red;&#125;</div><div class="line">//可以把多个属性-值选择器链接在一起来选择一个文档</div><div class="line">a[<span class="string">href="http://www.w3school.com.cn/"</span>][<span class="symbol">title="W3School"</span>] &#123;color: red;&#125;</div></pre></td></tr></table></figure>
<h4 id="u540E_u4EE3_u9009_u62E9_u5668"><a href="#u540E_u4EE3_u9009_u62E9_u5668" class="headerlink" title="后代选择器"></a>后代选择器</h4><ul>
<li>依赖于上下文关系来应用或者避免某项规则</li>
</ul>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//列表中的 strong 元素变为斜体字</span></div><div class="line"></div><div class="line">li <span class="class">strong </span>&#123;</div><div class="line">    font-style: italic;</div><div class="line">    font-weight: normal;</div><div class="line">  &#125;</div><div class="line"> </div><div class="line"> <span class="params">&lt;p&gt;</span><span class="params">&lt;strong&gt;</span>我是粗体字，不是斜体字，因为我不在列表当中，所以这个规则对我不起作用<span class="params">&lt;/strong&gt;</span><span class="params">&lt;/p&gt;</span></div><div class="line"></div><div class="line"><span class="params">&lt;ol&gt;</span></div><div class="line"><span class="params">&lt;li&gt;</span><span class="params">&lt;strong&gt;</span>我是斜体字。这是因为 strong 元素位于 li 元素内。<span class="params">&lt;/strong&gt;</span><span class="params">&lt;/li&gt;</span></div><div class="line"><span class="params">&lt;li&gt;</span>我是正常的字体。<span class="params">&lt;/li&gt;</span></div><div class="line"><span class="params">&lt;/ol&gt;</span></div></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/19/node中一堆凌乱的小知识/" itemprop="url">
                  node中一堆凌乱的小知识
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-04-19T14:17:56+08:00" content="2016-04-19">
              2016-04-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index">
                    <span itemprop="name">nodejs</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/19/node中一堆凌乱的小知识/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/19/node中一堆凌乱的小知识/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h4 id="xml_u76F8_u5173"><a href="#xml_u76F8_u5173" class="headerlink" title="xml相关"></a>xml相关</h4><p><code>xml转json</code>: npm包 xml2js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//explicitArray:false 返回json的value不为数组，explicitRoot:false，去掉头部</span></div><div class="line"><span class="keyword">var</span> xml=<span class="string">'&lt;xml&gt;&lt;a&gt;1&lt;/a&gt;&lt;b&gt;2&lt;/b&gt;&lt;/xml&gt;'</span>;</div><div class="line">blue.promisify(<span class="keyword">new</span> xml2js.Parser(&#123;<span class="attr">explicitArray</span>:<span class="literal">false</span>,<span class="attr">explicitRoot</span>:<span class="literal">false</span>&#125;).parseString)(xml).then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.dir(result);</div><div class="line">&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">error</span>)</span>&#123;</div><div class="line"><span class="comment">//&#123; a: '1', b: '2' &#125;</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p><code>json转xml</code>:npm包 xmlbuilder</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="xml">//‘xml’ root名称，headless: true 去掉 xml 头部，pretty: true 格式化</span></div><div class="line">var json = <span class="template-variable">&#123;</span></div><div class="line">	a: 1,</div><div class="line">	b: 2</div><div class="line">&#125;<span class="xml">;</span></div><div class="line">console.error(xmlbuilder.create('xml',<span class="template-variable">&#123;headless: true&#125;</span><span class="xml">).ele(json).end(</span><span class="template-variable">&#123; pretty: true&#125;</span><span class="xml">))</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">xml</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">a</span>&gt;</span>1<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">b</span>&gt;</span>2<span class="tag">&lt;/<span class="name">b</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">xml</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="bluebird"><a href="#bluebird" class="headerlink" title="bluebird"></a>bluebird</h4><p><code>promise.promisify 将api promise 化</code></p>
<h4 id="prcess"><a href="#prcess" class="headerlink" title="prcess"></a>prcess</h4><p><code>To set an environment variable in Windows</code>:</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SET</span> NODE_ENV=development</div></pre></td></tr></table></figure>
<p><code>on OS X or Linux</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> NODE_ENV=development</div></pre></td></tr></table></figure>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/05/node-异步编程/" itemprop="url">
                  node 异步编程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-04-05T16:10:24+08:00" content="2016-04-05">
              2016-04-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index">
                    <span itemprop="name">nodejs</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/05/node-异步编程/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/05/node-异步编程/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p><code>高阶函数</code>:把函数参数作为参数，或作为返回值</p>
<p><code>偏函数</code>: 将传入参数作为判断或者其他逻辑条件</p>
<h3 id="u6CE8_u610F_u70B9"><a href="#u6CE8_u610F_u70B9" class="headerlink" title="注意点"></a>注意点</h3><h4 id="u5F02_u5E38_u5904_u7406"><a href="#u5F02_u5E38_u5904_u7406" class="headerlink" title="异常处理"></a>异常处理</h4><p>异步I/O有两个处理阶段，中间有事件循环调度，异步方法在提交请求后就返回了，try/catch只能捕获当次事件循环内的异常，不能捕获callback的异常</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">try &#123;</div><div class="line">	req.body = JSON.<span class="keyword">parse</span>(buf, options.reviver);</div><div class="line">	<span class="comment">//callback()不能放在这，若callback异常，会导致它多次执行</span></div><div class="line">&#125; catch (<span class="keyword">err</span>) &#123;</div><div class="line">	<span class="keyword">err</span>.body = buf;</div><div class="line">	<span class="keyword">err</span>.status = 400;</div><div class="line">	<span class="keyword">return</span> callback(<span class="keyword">err</span>);</div><div class="line">&#125;</div><div class="line">callback();</div></pre></td></tr></table></figure>
<h4 id="u963B_u585E_u4EE3_u7801"><a href="#u963B_u585E_u4EE3_u7801" class="headerlink" title="阻塞代码"></a>阻塞代码</h4><p>这么写会持续占用CPU资源，破坏事件循环的调度，因为Node是单线程，会导致其余请求得不到响应</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">    <span class="comment">// TODO</span></div><div class="line"><span class="keyword">var</span> start = <span class="keyword">new</span> <span class="built_in">Date</span>();</div><div class="line"><span class="keyword">while</span> (<span class="keyword">new</span> <span class="built_in">Date</span>() - start &lt; <span class="number">1000</span>) &#123;</div><div class="line">	<span class="comment">// TODO </span></div><div class="line">&#125;</div><div class="line">   <span class="comment">// 需要阻塞的代码</span></div></pre></td></tr></table></figure>
<h3 id="u5F02_u6B65_u7F16_u7A0B_u89E3_u51B3_u65B9_u6848"><a href="#u5F02_u6B65_u7F16_u7A0B_u89E3_u51B3_u65B9_u6848" class="headerlink" title="异步编程解决方案"></a>异步编程解决方案</h3><h4 id="u4E8B_u4EF6"><a href="#u4E8B_u4EF6" class="headerlink" title="事件"></a>事件</h4><p>Node中事件的发布通常是伴随事件循环而异步触发的</p>
<ul>
<li>事件与侦听器是多对多的，设置过多的侦听器会导致过多的CPU占用</li>
<li>要给EventEmitter对象添加error事件和处理，若触发error事件不处理，会引起线程退出\</li>
<li>使用once()添加的侦听器只会执行一次，在执行后就会将相关的事件移除</li>
</ul>
<p><code>使用事件的途径</code></p>
<ul>
<li>实例化events</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> events =<span class="built_in">require</span>(‘events’);</div><div class="line"><span class="keyword">var</span> emitter = <span class="keyword">new</span> events.EventEmitter();</div><div class="line"></div><div class="line">emitter.on(<span class="string">'do'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">value</span>)</span>&#123;<span class="built_in">console</span>.log(value)&#125;);</div><div class="line">emitter.emit(<span class="string">'do'</span>,<span class="string">'doing'</span>);</div></pre></td></tr></table></figure>
<ul>
<li>继承events模块</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>)</div><div class="line"><span class="keyword">var</span> events = <span class="built_in">require</span>(<span class="string">'events'</span>);</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Stream</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	events.EventEmitter.call(<span class="keyword">this</span>);</div><div class="line">&#125;</div><div class="line">util.inherits(Stream, events.EventEmitter);</div><div class="line">Stream.prototype.test = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="number">111</span>;</div><div class="line">	&#125; <span class="keyword">catch</span> (error) &#123;</div><div class="line">		self.emit(<span class="string">'error'</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> stream = <span class="keyword">new</span> Stream();</div><div class="line">stream.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="built_in">console</span>.error(<span class="string">'asdasd'</span>)</div><div class="line">&#125;);</div><div class="line">stream.test();</div></pre></td></tr></table></figure>
<h5 id="u5229_u7528Once_28_29_u89E3_u51B3_u96EA_u5D29_u95EE_u9898"><a href="#u5229_u7528Once_28_29_u89E3_u51B3_u96EA_u5D29_u95EE_u9898" class="headerlink" title="利用Once()解决雪崩问题"></a>利用Once()解决雪崩问题</h5><ul>
<li>在高访问量、大并发量的情况下缓存突然失效, 大量的请求同时涌入数据库中,数据库无法承受，影响网站速度</li>
<li>在缓存中无数据时，访问量大的话，同条SQL可能会被执行多次，此时可以将所有请求放入事件队列，利用once()来绑定，SQL在执行时,新到的相同调用只需在队列中等待数据,一旦查询结束,得到的结果可以被这些调用共同使用</li>
</ul>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> proxy = <span class="keyword">new</span> events.EventEmitter();</div><div class="line"><span class="keyword">var</span> status = <span class="string">"ready"</span>;</div><div class="line"><span class="keyword">var</span> select = <span class="function"><span class="keyword">function</span><span class="params">(callback)</span> </span>&#123;</div><div class="line">	proxy.once(<span class="string">"selected"</span>, <span class="keyword">callback</span>);</div><div class="line">	<span class="keyword">if</span> (status === <span class="string">"ready"</span>) &#123;</div><div class="line">		status = <span class="string">"pending"</span>;</div><div class="line">		db.select(<span class="string">"SQL"</span>, <span class="function"><span class="keyword">function</span><span class="params">(results)</span> </span>&#123;</div><div class="line">			proxy.emit(<span class="string">"selected"</span>, results);</div><div class="line">			status = <span class="string">"ready"</span>;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>可能会因为侦听器过多引发警号，调用setMaxListeners(0)移除或设置大的阈值</p>
<h5 id="EventProxy__u5904_u7406_u591A_u4E8B_u4EF6_u5BF9_u4E00_u4FA6_u542C_u5668_uFF0C_u9002_u7528_u4E8E_u5B9E_u4F8B_u5316_u4E8B_u4EF6"><a href="#EventProxy__u5904_u7406_u591A_u4E8B_u4EF6_u5BF9_u4E00_u4FA6_u542C_u5668_uFF0C_u9002_u7528_u4E8E_u5B9E_u4F8B_u5316_u4E8B_u4EF6" class="headerlink" title="EventProxy 处理多事件对一侦听器，适用于实例化事件"></a>EventProxy 处理多事件对一侦听器，适用于实例化事件</h5><ul>
<li>all() 当每个事件都被触发了才会执行,只执行一次</li>
</ul>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> proxy = <span class="keyword">new</span> EventProxy();</div><div class="line">proxy.all(<span class="string">"template"</span>, <span class="string">"data"</span>, <span class="string">"resources"</span>, <span class="function"><span class="keyword">function</span><span class="params">(template, data, resources)</span> </span>&#123; <span class="comment">// TODO</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ul>
<li>tail() 首次也是需要每个事件都被触发，之后只要某个事件触发，就会用最新的数据执行</li>
<li>after() 事件执行多少次后执行侦听器的单一事件组合订阅</li>
</ul>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> proxy = <span class="keyword">new</span> EventProxy();</div><div class="line">proxy.after(<span class="string">"data"</span>, <span class="number">10</span>, <span class="function"><span class="keyword">function</span><span class="params">(datas)</span> </span>&#123; <span class="comment">// TODO</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ul>
<li>not()</li>
<li>any()</li>
</ul>
<p><strong>EventProxy对异常处理的优化</strong></p>
<ul>
<li>fail()</li>
</ul>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">ep.fail(<span class="keyword">callback</span>);</div><div class="line"><span class="comment">//等价于</span></div><div class="line">ep.fail(<span class="function"><span class="keyword">function</span><span class="params">(err)</span> </span>&#123;</div><div class="line">	<span class="keyword">callback</span>(err);</div><div class="line">&#125;);</div><div class="line"><span class="comment">//又等价于 </span></div><div class="line">ep.bind(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span><span class="params">(err)</span> </span>&#123;</div><div class="line">	<span class="comment">// 卸载所有处理函数 </span></div><div class="line">	ep.unbind();</div><div class="line">	<span class="comment">// 异常回调</span></div><div class="line">	<span class="keyword">callback</span>(err);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ul>
<li>done()</li>
</ul>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">ep.done(<span class="string">'tpl'</span>);</div><div class="line"><span class="comment">//等价于</span></div><div class="line"><span class="function"><span class="keyword">function</span><span class="params">(err, content)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (err) &#123;</div><div class="line">		<span class="comment">// 发生异常，交给error事件处理函数处理</span></div><div class="line">		<span class="keyword">return</span> ep.emit(<span class="string">'error'</span>, err);</div><div class="line">	&#125;</div><div class="line">	ep.emit(<span class="string">'tpl'</span>, content);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>done()接受函数参数</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">ep.done(<span class="function"><span class="keyword">function</span><span class="params">(content)</span> </span>&#123; </div><div class="line">     <span class="comment">// TODO</span></div><div class="line">	<span class="comment">// 无需考虑异常 </span></div><div class="line">	ep.emit(<span class="string">'tpl'</span>, content);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">//等价于</span></div><div class="line"><span class="function"><span class="keyword">function</span><span class="params">(err, content)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (err) &#123;</div><div class="line">		<span class="comment">//   发生异常 给error事件的处理函数处理</span></div><div class="line">		<span class="keyword">return</span> ep.emit(<span class="string">'error'</span>, err);</div><div class="line">	&#125;</div><div class="line">	(<span class="function"><span class="keyword">function</span><span class="params">(content)</span> </span>&#123;</div><div class="line">		<span class="comment">// TODO</span></div><div class="line">		<span class="comment">// 无需考虑异常 </span></div><div class="line">		ep.emit(<span class="string">'tpl'</span>, content);</div><div class="line">	&#125;(content));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>代码对比</code></p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">exports.getContent = <span class="function"><span class="keyword">function</span><span class="params">(callback)</span> </span>&#123;</div><div class="line">	<span class="keyword">var</span> ep = <span class="keyword">new</span> EventProxy();</div><div class="line">	ep.all(<span class="string">'tpl'</span>, <span class="function"><span class="keyword">function</span><span class="params">(tpl, data)</span> </span>&#123;</div><div class="line">		<span class="comment">// 成功回调</span></div><div class="line">		<span class="keyword">callback</span>(<span class="literal">null</span>, &#123;</div><div class="line">			template: tpl,</div><div class="line">			data: data</div><div class="line">		&#125;);</div><div class="line">	&#125;);</div><div class="line">	<span class="comment">// 帧听error事件 </span></div><div class="line">	ep.bind(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span><span class="params">(err)</span> </span>&#123;</div><div class="line">		<span class="comment">// 卸载 所有处理函数 </span></div><div class="line">		ep.unbind();</div><div class="line">		<span class="comment">// 异常回调 </span></div><div class="line">		<span class="keyword">callback</span>(err);</div><div class="line">	&#125;);</div><div class="line">	fs.readFile(<span class="string">'template.tpl'</span>, <span class="string">'utf-8'</span>, <span class="function"><span class="keyword">function</span><span class="params">(err, content)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (err) &#123;</div><div class="line">			<span class="comment">//   发生异常，给error事件的处理函数处理 </span></div><div class="line">			<span class="keyword">return</span> ep.emit(<span class="string">'error'</span>, err);</div><div class="line">		&#125;</div><div class="line">		ep.emit(<span class="string">'tpl'</span>, content);</div><div class="line">	&#125;);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line">exports.getContent = <span class="function"><span class="keyword">function</span><span class="params">(callback)</span> </span>&#123;</div><div class="line">	<span class="keyword">var</span> ep = <span class="keyword">new</span> EventProxy();</div><div class="line">	ep.all(<span class="string">'tpl'</span>, <span class="function"><span class="keyword">function</span><span class="params">(tpl, data)</span> </span>&#123; </div><div class="line">	<span class="comment">// 成功回调</span></div><div class="line">		<span class="keyword">callback</span>(<span class="literal">null</span>, &#123;</div><div class="line">			template: tpl,</div><div class="line">			data: data</div><div class="line">		&#125;);</div><div class="line">	&#125;); </div><div class="line">	<span class="comment">//绑定错误处理函数 </span></div><div class="line">	ep.fail(<span class="keyword">callback</span>);</div><div class="line">	fs.readFile(<span class="string">'template.tpl'</span>, <span class="string">'utf-8'</span>, ep.done(<span class="string">'tpl'</span>));</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="Promise/Deferred_28_u5E94_u7528_u53C2_u89C1_uFF1Aes6_Promise_29"><a href="#Promise/Deferred_28_u5E94_u7528_u53C2_u89C1_uFF1Aes6_Promise_29" class="headerlink" title="Promise/Deferred(应用参见：es6 Promise)"></a>Promise/Deferred(应用参见：es6 Promise)</h4><ul>
<li>先执行异步调用，后传递处理方法</li>
<li>then()方法只接受function对象，继续返回promise()对象，可选progress事件传入</li>
<li>Promise是高级接口，依靠低级接口事件来实现</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//then</span></div><div class="line"><span class="keyword">var</span> <span class="built_in">Promise</span> = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	EventEmitter.call(<span class="keyword">this</span>);</div><div class="line">&#125;;</div><div class="line">util.inherits(<span class="built_in">Promise</span>, EventEmitter);</div><div class="line"><span class="built_in">Promise</span>.prototype.then = <span class="function"><span class="keyword">function</span>(<span class="params">fulfilledHandler, errorHandler, progressHandler</span>) </span>&#123;</div><div class="line">	<span class="keyword">if</span> (<span class="keyword">typeof</span> fulfilledHandler === <span class="string">'function'</span>) &#123;</div><div class="line">		<span class="comment">//  用once()方法  保证成功回调只执行一次  </span></div><div class="line">		<span class="keyword">this</span>.once(<span class="string">'success'</span>, fulfilledHandler);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (<span class="keyword">typeof</span> errorHandler === <span class="string">'function'</span>) &#123;</div><div class="line">		<span class="comment">//  用once()方法  保证成功回调只执行一次   </span></div><div class="line">		<span class="keyword">this</span>.once(<span class="string">'error'</span>, errorHandler);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (<span class="keyword">typeof</span> progressHandler === <span class="string">'function'</span>) &#123;</div><div class="line">		<span class="keyword">this</span>.on(<span class="string">'progress'</span>, progressHandler);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;;</div><div class="line"><span class="comment">//实现这些功能的对象被称为Deferred,即延迟对象 </span></div><div class="line"><span class="keyword">var</span> Deferred = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="keyword">this</span>.state = <span class="string">'unfulfilled'</span>;</div><div class="line">	<span class="keyword">this</span>.promise = <span class="keyword">new</span> <span class="built_in">Promise</span>();</div><div class="line">&#125;;</div><div class="line">Deferred.prototype.resolve = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</div><div class="line">	<span class="keyword">this</span>.state = <span class="string">'fulfilled'</span>;</div><div class="line">	<span class="keyword">this</span>.promise.emit(<span class="string">'success'</span>, obj);</div><div class="line">&#125;;</div><div class="line">Deferred.prototype.reject = <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">	<span class="keyword">this</span>.state = <span class="string">'failed'</span>;</div><div class="line">	<span class="keyword">this</span>.promise.emit(<span class="string">'error'</span>, err);</div><div class="line">&#125;;</div><div class="line">Deferred.prototype.progress = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">	<span class="keyword">this</span>.promise.emit(<span class="string">'progress'</span>, data);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>对res改造成promise</p>
<p><code>Deferred用于内部,维护异步模型的状态，Promise作用于外部,通过then()暴露给外部以添加自定义逻辑</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> promisify = <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</div><div class="line">	<span class="keyword">var</span> deferred = <span class="keyword">new</span> Deferred();</div><div class="line">	<span class="keyword">var</span> result = <span class="string">''</span>;</div><div class="line">	res.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</div><div class="line">		result += chunk;</div><div class="line">		deferred.progress(chunk);</div><div class="line">	&#125;);</div><div class="line">	res.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		deferred.resolve(result);</div><div class="line">	&#125;);</div><div class="line">	res.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">		deferred.reject(err);</div><div class="line">	&#125;);</div><div class="line">	<span class="keyword">return</span> deferred.promise;<span class="comment">//更改内部状态的行为由定义者处理  </span></div><div class="line">&#125;;</div><div class="line"><span class="comment">//then调用的是promise</span></div><div class="line">promisify(res).then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="comment">// Done</span></div><div class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">	<span class="comment">// Error</span></div><div class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</div><div class="line">	<span class="comment">// progress</span></div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'BODY: '</span> + chunk);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><code>Promise多异步协作，all()</code></p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">Deferred</span>.prototype.<span class="built_in">all</span> = <span class="function"><span class="keyword">function</span><span class="params">(promises)</span></span> &#123;</div><div class="line">	var <span class="built_in">count</span> = promises.length;</div><div class="line">	var that = this;</div><div class="line">	var results = [];</div><div class="line">	promises.forEach(<span class="function"><span class="keyword">function</span><span class="params">(promise, i)</span></span> &#123;</div><div class="line">		promise.<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">(data)</span></span> &#123;</div><div class="line">			<span class="built_in">count</span>--;</div><div class="line">			results[i] = <span class="keyword">data</span>;</div><div class="line">			<span class="keyword">if</span> (<span class="built_in">count</span> === <span class="number">0</span>) &#123;</div><div class="line">				that.resolve(results);</div><div class="line">			&#125;</div><div class="line">		&#125;, <span class="function"><span class="keyword">function</span><span class="params">(err)</span></span> &#123;</div><div class="line">			that.reject(err);</div><div class="line">		&#125;);</div><div class="line">	&#125;);</div><div class="line">	<span class="keyword">return</span> this.promise;</div><div class="line">&#125;; </div><div class="line"></div><div class="line">//<span class="built_in">all</span>()返回resolve()结果集</div></pre></td></tr></table></figure>
<p><code>Promise链式调用</code></p>
<ul>
<li>前一个的调用的结果，作为下一个调用的开始，后一个then的回调函数会等待前一个promise的状态变化而运行</li>
</ul>
<p><code>将API Promise化</code></p>
<pre><code>// smooth(fs.readFile);
var smooth = function(method) {
    return function() {
        var deferred = new Deferred();
        var args = Array.prototype.slice.call(arguments, 1); //跳过第一个参数
        args.push(deferred.callback());
        method.apply(null, args);
        return deferred.promise;
    };
};

<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bluebrid的 </span>promisify可以将api promise化</div></pre></td></tr></table></figure>

var Promise = require(&apos;bluebird&apos;)
fs.readFileAsync = Promise.promisify(fs.readFie, fs)

var Promise = require(&apos;bluebird&apos;)
Promise.promisifyAll(fs)

<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### async</div><div class="line">`串行执行`：series()</div></pre></td></tr></table></figure>

async.series([
    function(callback) {
        fs.readFile(&apos;file1.txt&apos;, &apos;utf-8&apos;, callback);
    },
    function(callback) {
        fs.readFile(&apos;file2.txt&apos;, &apos;utf-8&apos;, callback);
    }
], function(err, results) {
    // results =&gt; [file1.txt, file2.txt] 
});

<figure class="highlight gcode"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">传入的callback<span class="comment">()</span>不是由使用者指定，callback<span class="comment">()</span>执行时将结果保存然后执行下一个调用，最终的回调函数执行时，保存的结果以数组传入，一旦异常结束所有调用，将异常传递给最终函数的第一个参数</div><div class="line"></div><div class="line">`并行执行`:parallel<span class="comment">()</span></div></pre></td></tr></table></figure>

async.parallel([function(callback) {
        fs.readFile(&apos;file1.txt&apos;, &apos;utf-8&apos;, callback);
    },
    function(callback) {
        fs.readFile(&apos;file2.txt&apos;, &apos;utf-8&apos;, callback);
    }
], function(err, results) {
    // results =&gt; [file1.txt, file2.txt] 
});

//等价于
var counter = 2;
var results = [];
var done = function(index, value) {
    results[index] = value;
    counter--;
    if (counter === 0) {
        callback(null, results);
    }
};
// 只传递第一个异常
var hasErr = false;
var fail = function(err) {
    if (!hasErr) {
        hasErr = true;
        callback(err);
    }
};
fs.readFile(&apos;file1.txt&apos;, &apos;utf-8&apos;, function(err, content) {
    if (err) {
        return fail(err);
    }
    done(0, content);
});
fs.readFile(&apos;file2.txt&apos;, &apos;utf-8&apos;, function(err, data) {
    if (err) {
        return fail(err);
    }
    done(1, data);
});
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">一旦异步调用异常，，就将异常作为第一个参数传给最终回调函数，结果为数组</div><div class="line"></div><div class="line">`异步调用 依赖`：当前一个的结果是后一个调用的输入 waterfall()</div></pre></td></tr></table></figure>

async.waterfall([function(callback) {
        fs.readFile(&apos;file1.txt&apos;, &apos;utf-8&apos;, function(err, content) {
            callback(err, content);
        });
    },
    function(arg1, callback) {
        // arg1 =&gt; file2.txt
        fs.readFile(arg1, &apos;utf-8&apos;, function(err, content) {
            callback(err, content);
        });
    },
    function(arg1, callback) {
        // arg1 =&gt; file3.txt
        fs.readFile(arg1, &apos;utf-8&apos;, function(err, content) {
            callback(err, content);
        });
    }
], function(err, result) {
    // result =&gt; file4.txt 
});

<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">`自动依赖处理` auto()</div></pre></td></tr></table></figure>

{
    readConfig: function() {}, //读取配置
    connectMongoDB: function() {},//连接mongo
    connectRedis: function() {},//连接redis
    complieAsserts: function() {},//编译静态
    uploadAsserts: function() {},//上传静态到cdn
    startup: function() {}//启动
}

var deps = {
    readConfig: function(callback) {
        // read config file
        callback();
    },
    connectMongoDB: [&apos;readConfig&apos;, function(callback) { 
    // connect to mongodb
        callback();
    }],
    connectRedis: [&apos;readConfig&apos;, function(callback) {
        // connect to redis callback();
        图灵社区会员 Eric Liu(guangqiang.dev @gmail.com) 专享 尊重版权
    }],
    complieAsserts: function(callback) {
        // complie asserts
        callback();
    },
    uploadAsserts: [&apos;complieAsserts&apos;, function(callback) {
        // upload to assert 2 callback();
    }],
    startup: [&apos;connectMongoDB&apos;, &apos;connectRedis&apos;, &apos;uploadAsserts&apos;, function(callback) {
        // startup
    }] 
};

//auto根据依赖关系自动分析
async.auto(deps);
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="section">#### Step </span></div><div class="line"><span class="code">`串行`</span></div></pre></td></tr></table></figure>

Step(
    function readFile1() {
        fs.readFile(&apos;file1.txt&apos;, &apos;utf-8&apos;, this);
    },
    function readFile2(err, content) {
        fs.readFile(&apos;file2.txt&apos;, &apos;utf-8&apos;, this);
    },
    function done(err, content) {
        console.log(content);
    }
);

<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">this</span>是<span class="keyword">Step</span>内部的一个<span class="keyword">next</span>()方法,将调用结果作为下一个任务的参数并调用</div><div class="line"></div><div class="line">`并行` parallel()</div></pre></td></tr></table></figure>

Step(
    function readFile1() {
        fs.readFile(&apos;file1.txt&apos;, &apos;utf-8&apos;, this.parallel());
        fs.readFile(&apos;file2.txt&apos;, &apos;utf-8&apos;, this.parallel());
    },
    function done(err, content1, content2) {
        // content1 =&gt; file1
        // content2 =&gt; file2 
        console.log(arguments);
    });
</code></pre><p>如果异步方法传回结果为多个参数，step只取前两个。parallel（）原理是每次执行时将内部计数器加1，</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="http://www.wmtcore.com/uploads/avatar.png" alt="WMT" itemprop="image"/>
          <p class="site-author-name" itemprop="name">WMT</p>
        </div>
        <p class="site-description motion-element" itemprop="description">不扯犊子 -NOT ALONE</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">48</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">14</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">16</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/WMTcore" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015-12 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WMT</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"wmtcore"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     


    
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  

  
  

</body>
</html>
