<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="WMTcore" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="不扯犊子 -NOT ALONE">
<meta property="og:type" content="website">
<meta property="og:title" content="大碗拉面">
<meta property="og:url" content="https://www.wmtcore.com/page/3/index.html">
<meta property="og:site_name" content="大碗拉面">
<meta property="og:description" content="不扯犊子 -NOT ALONE">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="大碗拉面">
<meta name="twitter:description" content="不扯犊子 -NOT ALONE">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> 大碗拉面 </title>
</head>

<body itemscope itemtype="https://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="https://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="https://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?8fc1dcdaa63dc57073d1f217ba27dc7d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="https://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">大碗拉面</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
      
        <li class="menu-item menu-item-search">
          <a href="#" class="st-search-show-outputs">
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', '1zo1-KPbS2sqsk4pXnSQ','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">

    

    
    
      
      

      
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/openssl生成ssl证书及向申请CA流程/" itemprop="url">
                  openssl生成ssl证书及向申请CA流程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-05-13T10:57:49+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/openssl生成ssl证书及向申请CA流程/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/openssl生成ssl证书及向申请CA流程/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="生成key"><a href="#生成key" class="headerlink" title="生成key"></a>生成key</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">openssl genrsa -des3 -out prvtkey<span class="selector-class">.pem</span> <span class="number">2048</span> </div><div class="line">或者无密码保护的</div><div class="line">openssl genrsa -out prvtkey<span class="selector-class">.pem</span> <span class="number">2048</span></div></pre></td></tr></table></figure>
<h3 id="生成-csr-用这个向数字证书颁发机构（即CA）申请一个数字证书"><a href="#生成-csr-用这个向数字证书颁发机构（即CA）申请一个数字证书" class="headerlink" title="生成.csr(用这个向数字证书颁发机构（即CA）申请一个数字证书)"></a>生成.csr(用这个向数字证书颁发机构（即CA）申请一个数字证书)</h3><figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl req -<span class="keyword">new</span> -key prvtkey.pem -<span class="keyword">out</span> cert.csr</div></pre></td></tr></table></figure>
<p>然后填写信息，注意<strong>Common Name (eg, your websites domain name)</strong>，要填写网站域名,如:pay.abc.com</p>
<p>生成的.csr文件是否规范可以在这检测：<br><a href="https://cryptoreport.websecurity.symantec.com/checker/views/csrCheck.jsp" target="_blank" rel="external">https://cryptoreport.websecurity.symantec.com/checker/views/csrCheck.jsp</a></p>
<p>然后向CA申请数字证书，再用CA给的cacert.pem替换原来的prvtkey.pem</p>
<h3 id="自建CA"><a href="#自建CA" class="headerlink" title="自建CA"></a>自建CA</h3><p><a href="http://www.cnblogs.com/AloneSword/p/3809002.html" target="_blank" rel="external">http://www.cnblogs.com/AloneSword/p/3809002.html</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/12/js中一堆凌乱的小知识/" itemprop="url">
                  js中一堆凌乱的小知识
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-05-12T11:34:45+08:00" content="2016-05-12">
              2016-05-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/12/js中一堆凌乱的小知识/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/12/js中一堆凌乱的小知识/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h4 id="setTimeout-clearTimeout"><a href="#setTimeout-clearTimeout" class="headerlink" title="setTimeout clearTimeout"></a>setTimeout clearTimeout</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">var</span> timer=setTimeout</div><div class="line"></div><div class="line"><span class="function"><span class="title">clearTimeout</span><span class="params">(timer)</span></span></div></pre></td></tr></table></figure>
<h4 id="数组深拷贝"><a href="#数组深拷贝" class="headerlink" title="数组深拷贝"></a>数组深拷贝</h4><figure class="highlight delphi"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> a=[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</div><div class="line">b=a.slice(<span class="number">0</span>,[<span class="keyword">end</span>])</div><div class="line">slice 方法返回一个 <span class="keyword">Array</span> 对象</div><div class="line"></div><div class="line">slice 方法一直复制到 <span class="keyword">end</span> 所指定的元素</div><div class="line">b=a.concat();</div></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/22/hate-css-1/" itemprop="url">
                  hate css of 选择器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-04-22T08:58:18+08:00" content="2016-04-22">
              2016-04-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/hate/" itemprop="url" rel="index">
                    <span itemprop="name">hate</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/22/hate-css-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/22/hate-css-1/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="选择器"><a href="#选择器" class="headerlink" title="选择器"></a>选择器</h3><h4 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h4><ul>
<li>子元素从父元素继承属性，<code>IE/Windows 直到 IE6 还存在相关的问题，在表格内的字体样式会被忽略。</code></li>
<li>针对子元素创建规则，则可摆脱继承</li>
</ul>
<h4 id="元素选择器"><a href="#元素选择器" class="headerlink" title="元素选择器"></a>元素选择器</h4><ul>
<li>文档的元素就是最基本的选择器 比如 p、h1、em、a，甚至可以是 html 本身</li>
</ul>
<h4 id="选择器分组"><a href="#选择器分组" class="headerlink" title="选择器分组"></a>选择器分组</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">h2</span>, <span class="selector-tag">p</span> &#123;<span class="attribute">color</span>:gray;&#125;</div></pre></td></tr></table></figure>
<p>将 h2 和 p 选择器放在规则左边，然后用逗号分隔，就定义了一个规则。其右边的样式（color:gray;）将应用到这两个选择器所引用的元素。逗号告诉浏览器，规则中包含两个不同的选择器</p>
<ul>
<li>通配符选择器 *,与任何元素匹配</li>
</ul>
<h4 id="类选择器"><a href="#类选择器" class="headerlink" title="类选择器"></a>类选择器</h4><ul>
<li>class </li>
</ul>
<p><code>结合元素选择器</code> </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">p</span><span class="selector-class">.important</span> &#123;<span class="attribute">color</span>:red;&#125; <span class="comment">//匹配 class 属性包含 important 的所有 p 元素</span></div></pre></td></tr></table></figure>
<p><code>class 值中可能包含一个词列表，各个词之间用空格分隔</code></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt; <span class="selector-tag">p</span> class=<span class="string">"important warning"</span>&gt;</div><div class="line">This paragraph is <span class="selector-tag">a</span> very important warning.</div><div class="line">&lt; /p&gt;</div><div class="line"></div><div class="line"><span class="selector-class">.important</span><span class="selector-class">.warning</span> &#123;<span class="attribute">background</span>:silver;&#125;<span class="comment">//class 中同时包含 important 和 warning</span></div></pre></td></tr></table></figure>
<p><code>在 IE7 之前的版本中，不同平台的 Internet Explorer 都不能正确地处理多类选择器</code></p>
<h4 id="ID选择器"><a href="#ID选择器" class="headerlink" title="ID选择器"></a>ID选择器</h4><ul>
<li>ID 选择器前面有一个 # 号</li>
<li>不能使用 ID 词列表</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-id">#intro</span> &#123;<span class="attribute">font-weight</span>:bold;&#125;</div></pre></td></tr></table></figure>
<h4 id="属性选择器"><a href="#属性选择器" class="headerlink" title="属性选择器"></a>属性选择器</h4><figure class="highlight scss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">*<span class="selector-attr">[title]</span> &#123;<span class="attribute">color</span>:red;&#125;<span class="comment">// 把包含标题（title）的所有元素变为红色</span></div><div class="line"><span class="selector-tag">a</span><span class="selector-attr">[href]</span> &#123;<span class="attribute">color</span>:red;&#125; <span class="comment">// 对有 href 属性的锚（a 元素）应用样式</span></div><div class="line"><span class="selector-tag">a</span><span class="selector-attr">[href]</span><span class="selector-attr">[title]</span> &#123;<span class="attribute">color</span>:red;&#125; <span class="comment">//将同时有 href 和 title 属性的 HTML 超链接的文本设置为红色</span></div></pre></td></tr></table></figure>
<p><code>根据具体属性值选择</code></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//将指向 Web 服务器上某个指定文档的超链接变成红色</div><div class="line">a[href="http://www.w3school.com.cn/about_us.asp"] &#123;color: red;&#125;</div><div class="line">//可以把多个属性-值选择器链接在一起来选择一个文档</div><div class="line">a[<span class="string">href="http://www.w3school.com.cn/"</span>][<span class="symbol">title="W3School"</span>] &#123;color: red;&#125;</div></pre></td></tr></table></figure>
<h4 id="后代选择器"><a href="#后代选择器" class="headerlink" title="后代选择器"></a>后代选择器</h4><ul>
<li>依赖于上下文关系来应用或者避免某项规则</li>
</ul>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//列表中的 strong 元素变为斜体字</span></div><div class="line"></div><div class="line">li <span class="class">strong </span>&#123;</div><div class="line">    font-style: italic;</div><div class="line">    font-weight: normal;</div><div class="line">  &#125;</div><div class="line"> </div><div class="line"> <span class="params">&lt;p&gt;</span><span class="params">&lt;strong&gt;</span>我是粗体字，不是斜体字，因为我不在列表当中，所以这个规则对我不起作用<span class="params">&lt;/strong&gt;</span><span class="params">&lt;/p&gt;</span></div><div class="line"></div><div class="line"><span class="params">&lt;ol&gt;</span></div><div class="line"><span class="params">&lt;li&gt;</span><span class="params">&lt;strong&gt;</span>我是斜体字。这是因为 strong 元素位于 li 元素内。<span class="params">&lt;/strong&gt;</span><span class="params">&lt;/li&gt;</span></div><div class="line"><span class="params">&lt;li&gt;</span>我是正常的字体。<span class="params">&lt;/li&gt;</span></div><div class="line"><span class="params">&lt;/ol&gt;</span></div></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/19/node中一堆凌乱的小知识/" itemprop="url">
                  node中一堆凌乱的小知识
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-04-19T14:17:56+08:00" content="2016-04-19">
              2016-04-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index">
                    <span itemprop="name">nodejs</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/19/node中一堆凌乱的小知识/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/19/node中一堆凌乱的小知识/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h4 id="xml相关"><a href="#xml相关" class="headerlink" title="xml相关"></a>xml相关</h4><p><code>xml转json</code>: npm包 xml2js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//explicitArray:false 返回json的value不为数组，explicitRoot:false，去掉头部</span></div><div class="line"><span class="keyword">var</span> xml=<span class="string">'&lt;xml&gt;&lt;a&gt;1&lt;/a&gt;&lt;b&gt;2&lt;/b&gt;&lt;/xml&gt;'</span>;</div><div class="line">blue.promisify(<span class="keyword">new</span> xml2js.Parser(&#123;<span class="attr">explicitArray</span>:<span class="literal">false</span>,<span class="attr">explicitRoot</span>:<span class="literal">false</span>&#125;).parseString)(xml).then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.dir(result);</div><div class="line">&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">error</span>)</span>&#123;</div><div class="line"><span class="comment">//&#123; a: '1', b: '2' &#125;</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p><code>json转xml</code>:npm包 xmlbuilder</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="xml">//‘xml’ root名称，headless: true 去掉 xml 头部，pretty: true 格式化</span></div><div class="line">var json = <span class="template-variable">&#123;</span></div><div class="line">	a: 1,</div><div class="line">	b: 2</div><div class="line">&#125;<span class="xml">;</span></div><div class="line">console.error(xmlbuilder.create('xml',<span class="template-variable">&#123;headless: true&#125;</span><span class="xml">).ele(json).end(</span><span class="template-variable">&#123; pretty: true&#125;</span><span class="xml">))</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">xml</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">a</span>&gt;</span>1<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">b</span>&gt;</span>2<span class="tag">&lt;/<span class="name">b</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">xml</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="bluebird"><a href="#bluebird" class="headerlink" title="bluebird"></a>bluebird</h4><p><code>promise.promisify 将api promise 化</code></p>
<h4 id="prcess"><a href="#prcess" class="headerlink" title="prcess"></a>prcess</h4><p><code>To set an environment variable in Windows</code>:</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SET</span> NODE_ENV=development</div></pre></td></tr></table></figure>
<p><code>on OS X or Linux</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> NODE_ENV=development</div></pre></td></tr></table></figure>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/05/node-异步编程/" itemprop="url">
                  node 异步编程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-04-05T16:10:24+08:00" content="2016-04-05">
              2016-04-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index">
                    <span itemprop="name">nodejs</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/05/node-异步编程/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/05/node-异步编程/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p><code>高阶函数</code>:把函数参数作为参数，或作为返回值</p>
<p><code>偏函数</code>: 将传入参数作为判断或者其他逻辑条件</p>
<h3 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h3><h4 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h4><p>异步I/O有两个处理阶段，中间有事件循环调度，异步方法在提交请求后就返回了，try/catch只能捕获当次事件循环内的异常，不能捕获callback的异常</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">try &#123;</div><div class="line">	req.body = JSON.<span class="keyword">parse</span>(buf, options.reviver);</div><div class="line">	<span class="comment">//callback()不能放在这，若callback异常，会导致它多次执行</span></div><div class="line">&#125; catch (<span class="keyword">err</span>) &#123;</div><div class="line">	<span class="keyword">err</span>.body = buf;</div><div class="line">	<span class="keyword">err</span>.status = 400;</div><div class="line">	<span class="keyword">return</span> callback(<span class="keyword">err</span>);</div><div class="line">&#125;</div><div class="line">callback();</div></pre></td></tr></table></figure>
<h4 id="阻塞代码"><a href="#阻塞代码" class="headerlink" title="阻塞代码"></a>阻塞代码</h4><p>这么写会持续占用CPU资源，破坏事件循环的调度，因为Node是单线程，会导致其余请求得不到响应</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">    <span class="comment">// TODO</span></div><div class="line"><span class="keyword">var</span> start = <span class="keyword">new</span> <span class="type">Date</span>();</div><div class="line"><span class="keyword">while</span> (<span class="keyword">new</span> <span class="type">Date</span>() - start &lt; <span class="number">1000</span>) &#123;</div><div class="line">	<span class="comment">// TODO </span></div><div class="line">&#125;</div><div class="line">   <span class="comment">// 需要阻塞的代码</span></div></pre></td></tr></table></figure>
<h3 id="异步编程解决方案"><a href="#异步编程解决方案" class="headerlink" title="异步编程解决方案"></a>异步编程解决方案</h3><h4 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h4><p>Node中事件的发布通常是伴随事件循环而异步触发的</p>
<ul>
<li>事件与侦听器是多对多的，设置过多的侦听器会导致过多的CPU占用</li>
<li>要给EventEmitter对象添加error事件和处理，若触发error事件不处理，会引起线程退出\</li>
<li>使用once()添加的侦听器只会执行一次，在执行后就会将相关的事件移除</li>
</ul>
<p><code>使用事件的途径</code></p>
<ul>
<li>实例化events</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> events =<span class="built_in">require</span>(‘events’);</div><div class="line"><span class="keyword">var</span> emitter = <span class="keyword">new</span> events.EventEmitter();</div><div class="line"></div><div class="line">emitter.on(<span class="string">'do'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">value</span>)</span>&#123;<span class="built_in">console</span>.log(value)&#125;);</div><div class="line">emitter.emit(<span class="string">'do'</span>,<span class="string">'doing'</span>);</div></pre></td></tr></table></figure>
<ul>
<li>继承events模块</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>)</div><div class="line"><span class="keyword">var</span> events = <span class="built_in">require</span>(<span class="string">'events'</span>);</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Stream</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	events.EventEmitter.call(<span class="keyword">this</span>);</div><div class="line">&#125;</div><div class="line">util.inherits(Stream, events.EventEmitter);</div><div class="line">Stream.prototype.test = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="number">111</span>;</div><div class="line">	&#125; <span class="keyword">catch</span> (error) &#123;</div><div class="line">		self.emit(<span class="string">'error'</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> stream = <span class="keyword">new</span> Stream();</div><div class="line">stream.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="built_in">console</span>.error(<span class="string">'asdasd'</span>)</div><div class="line">&#125;);</div><div class="line">stream.test();</div></pre></td></tr></table></figure>
<h5 id="利用Once-解决雪崩问题"><a href="#利用Once-解决雪崩问题" class="headerlink" title="利用Once()解决雪崩问题"></a>利用Once()解决雪崩问题</h5><ul>
<li>在高访问量、大并发量的情况下缓存突然失效, 大量的请求同时涌入数据库中,数据库无法承受，影响网站速度</li>
<li>在缓存中无数据时，访问量大的话，同条SQL可能会被执行多次，此时可以将所有请求放入事件队列，利用once()来绑定，SQL在执行时,新到的相同调用只需在队列中等待数据,一旦查询结束,得到的结果可以被这些调用共同使用</li>
</ul>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> proxy = <span class="keyword">new</span> <span class="type">events</span>.EventEmitter();</div><div class="line"><span class="keyword">var</span> status = <span class="string">"ready"</span>;</div><div class="line"><span class="keyword">var</span> select = <span class="function"><span class="keyword">function</span></span>(<span class="keyword">callback</span>) &#123;</div><div class="line">	proxy.once(<span class="string">"selected"</span>, <span class="keyword">callback</span>);</div><div class="line">	<span class="keyword">if</span> (status === <span class="string">"ready"</span>) &#123;</div><div class="line">		status = <span class="string">"pending"</span>;</div><div class="line">		db.select(<span class="string">"SQL"</span>, <span class="function"><span class="keyword">function</span></span>(results) &#123;</div><div class="line">			proxy.emit(<span class="string">"selected"</span>, results);</div><div class="line">			status = <span class="string">"ready"</span>;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>可能会因为侦听器过多引发警号，调用setMaxListeners(0)移除或设置大的阈值</p>
<h5 id="EventProxy-处理多事件对一侦听器，适用于实例化事件"><a href="#EventProxy-处理多事件对一侦听器，适用于实例化事件" class="headerlink" title="EventProxy 处理多事件对一侦听器，适用于实例化事件"></a>EventProxy 处理多事件对一侦听器，适用于实例化事件</h5><ul>
<li>all() 当每个事件都被触发了才会执行,只执行一次</li>
</ul>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> proxy = <span class="keyword">new</span> EventProxy();</div><div class="line">proxy.all(<span class="string">"template"</span>, <span class="string">"data"</span>, <span class="string">"resources"</span>, <span class="function"><span class="keyword">function</span><span class="params">(template, data, resources)</span> </span>&#123; <span class="comment">// TODO</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ul>
<li>tail() 首次也是需要每个事件都被触发，之后只要某个事件触发，就会用最新的数据执行</li>
<li>after() 事件执行多少次后执行侦听器的单一事件组合订阅</li>
</ul>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> proxy = <span class="keyword">new</span> EventProxy();</div><div class="line">proxy.after(<span class="string">"data"</span>, <span class="number">10</span>, <span class="function"><span class="keyword">function</span><span class="params">(datas)</span> </span>&#123; <span class="comment">// TODO</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ul>
<li>not()</li>
<li>any()</li>
</ul>
<p><strong>EventProxy对异常处理的优化</strong></p>
<ul>
<li>fail()</li>
</ul>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">ep.fail(<span class="keyword">callback</span>);</div><div class="line"><span class="comment">//等价于</span></div><div class="line">ep.fail(<span class="function"><span class="keyword">function</span></span>(err) &#123;</div><div class="line">	<span class="keyword">callback</span>(err);</div><div class="line">&#125;);</div><div class="line"><span class="comment">//又等价于 </span></div><div class="line">ep.bind(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span></span>(err) &#123;</div><div class="line">	<span class="comment">// 卸载所有处理函数 </span></div><div class="line">	ep.unbind();</div><div class="line">	<span class="comment">// 异常回调</span></div><div class="line">	<span class="keyword">callback</span>(err);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ul>
<li>done()</li>
</ul>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">ep.done(<span class="string">'tpl'</span>);</div><div class="line"><span class="comment">//等价于</span></div><div class="line"><span class="function"><span class="keyword">function</span><span class="params">(err, content)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (err) &#123;</div><div class="line">		<span class="comment">// 发生异常，交给error事件处理函数处理</span></div><div class="line">		<span class="keyword">return</span> ep.emit(<span class="string">'error'</span>, err);</div><div class="line">	&#125;</div><div class="line">	ep.emit(<span class="string">'tpl'</span>, content);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>done()接受函数参数</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">ep.done(<span class="function"><span class="keyword">function</span><span class="params">(content)</span> </span>&#123; </div><div class="line">     <span class="comment">// TODO</span></div><div class="line">	<span class="comment">// 无需考虑异常 </span></div><div class="line">	ep.emit(<span class="string">'tpl'</span>, content);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">//等价于</span></div><div class="line"><span class="function"><span class="keyword">function</span><span class="params">(err, content)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (err) &#123;</div><div class="line">		<span class="comment">//   发生异常 给error事件的处理函数处理</span></div><div class="line">		<span class="keyword">return</span> ep.emit(<span class="string">'error'</span>, err);</div><div class="line">	&#125;</div><div class="line">	(<span class="function"><span class="keyword">function</span><span class="params">(content)</span> </span>&#123;</div><div class="line">		<span class="comment">// TODO</span></div><div class="line">		<span class="comment">// 无需考虑异常 </span></div><div class="line">		ep.emit(<span class="string">'tpl'</span>, content);</div><div class="line">	&#125;(content));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>代码对比</code></p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">exports.getContent = <span class="function"><span class="keyword">function</span></span>(<span class="keyword">callback</span>) &#123;</div><div class="line">	<span class="keyword">var</span> ep = <span class="keyword">new</span> <span class="type">EventProxy</span>();</div><div class="line">	ep.all(<span class="string">'tpl'</span>, <span class="function"><span class="keyword">function</span></span>(tpl, data) &#123;</div><div class="line">		<span class="comment">// 成功回调</span></div><div class="line">		<span class="keyword">callback</span>(<span class="literal">null</span>, &#123;</div><div class="line">			template: <span class="type">tpl</span>,</div><div class="line">			data: <span class="type">data</span></div><div class="line">		&#125;);</div><div class="line">	&#125;);</div><div class="line">	<span class="comment">// 帧听error事件 </span></div><div class="line">	ep.bind(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span></span>(err) &#123;</div><div class="line">		<span class="comment">// 卸载 所有处理函数 </span></div><div class="line">		ep.unbind();</div><div class="line">		<span class="comment">// 异常回调 </span></div><div class="line">		<span class="keyword">callback</span>(err);</div><div class="line">	&#125;);</div><div class="line">	fs.readFile(<span class="string">'template.tpl'</span>, <span class="string">'utf-8'</span>, <span class="function"><span class="keyword">function</span></span>(err, content) &#123;</div><div class="line">		<span class="keyword">if</span> (err) &#123;</div><div class="line">			<span class="comment">//   发生异常，给error事件的处理函数处理 </span></div><div class="line">			<span class="keyword">return</span> ep.emit(<span class="string">'error'</span>, err);</div><div class="line">		&#125;</div><div class="line">		ep.emit(<span class="string">'tpl'</span>, content);</div><div class="line">	&#125;);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line">exports.getContent = <span class="function"><span class="keyword">function</span></span>(<span class="keyword">callback</span>) &#123;</div><div class="line">	<span class="keyword">var</span> ep = <span class="keyword">new</span> <span class="type">EventProxy</span>();</div><div class="line">	ep.all(<span class="string">'tpl'</span>, <span class="function"><span class="keyword">function</span></span>(tpl, data) &#123; </div><div class="line">	<span class="comment">// 成功回调</span></div><div class="line">		<span class="keyword">callback</span>(<span class="literal">null</span>, &#123;</div><div class="line">			template: <span class="type">tpl</span>,</div><div class="line">			data: <span class="type">data</span></div><div class="line">		&#125;);</div><div class="line">	&#125;); </div><div class="line">	<span class="comment">//绑定错误处理函数 </span></div><div class="line">	ep.fail(<span class="keyword">callback</span>);</div><div class="line">	fs.readFile(<span class="string">'template.tpl'</span>, <span class="string">'utf-8'</span>, ep.done(<span class="string">'tpl'</span>));</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="Promise-Deferred-应用参见：es6-Promise"><a href="#Promise-Deferred-应用参见：es6-Promise" class="headerlink" title="Promise/Deferred(应用参见：es6 Promise)"></a>Promise/Deferred(应用参见：es6 Promise)</h4><ul>
<li>先执行异步调用，后传递处理方法</li>
<li>then()方法只接受function对象，继续返回promise()对象，可选progress事件传入</li>
<li>Promise是高级接口，依靠低级接口事件来实现</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//then</span></div><div class="line"><span class="keyword">var</span> <span class="built_in">Promise</span> = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	EventEmitter.call(<span class="keyword">this</span>);</div><div class="line">&#125;;</div><div class="line">util.inherits(<span class="built_in">Promise</span>, EventEmitter);</div><div class="line"><span class="built_in">Promise</span>.prototype.then = <span class="function"><span class="keyword">function</span>(<span class="params">fulfilledHandler, errorHandler, progressHandler</span>) </span>&#123;</div><div class="line">	<span class="keyword">if</span> (<span class="keyword">typeof</span> fulfilledHandler === <span class="string">'function'</span>) &#123;</div><div class="line">		<span class="comment">//  用once()方法  保证成功回调只执行一次  </span></div><div class="line">		<span class="keyword">this</span>.once(<span class="string">'success'</span>, fulfilledHandler);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (<span class="keyword">typeof</span> errorHandler === <span class="string">'function'</span>) &#123;</div><div class="line">		<span class="comment">//  用once()方法  保证成功回调只执行一次   </span></div><div class="line">		<span class="keyword">this</span>.once(<span class="string">'error'</span>, errorHandler);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (<span class="keyword">typeof</span> progressHandler === <span class="string">'function'</span>) &#123;</div><div class="line">		<span class="keyword">this</span>.on(<span class="string">'progress'</span>, progressHandler);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;;</div><div class="line"><span class="comment">//实现这些功能的对象被称为Deferred,即延迟对象 </span></div><div class="line"><span class="keyword">var</span> Deferred = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="keyword">this</span>.state = <span class="string">'unfulfilled'</span>;</div><div class="line">	<span class="keyword">this</span>.promise = <span class="keyword">new</span> <span class="built_in">Promise</span>();</div><div class="line">&#125;;</div><div class="line">Deferred.prototype.resolve = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</div><div class="line">	<span class="keyword">this</span>.state = <span class="string">'fulfilled'</span>;</div><div class="line">	<span class="keyword">this</span>.promise.emit(<span class="string">'success'</span>, obj);</div><div class="line">&#125;;</div><div class="line">Deferred.prototype.reject = <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">	<span class="keyword">this</span>.state = <span class="string">'failed'</span>;</div><div class="line">	<span class="keyword">this</span>.promise.emit(<span class="string">'error'</span>, err);</div><div class="line">&#125;;</div><div class="line">Deferred.prototype.progress = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">	<span class="keyword">this</span>.promise.emit(<span class="string">'progress'</span>, data);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>对res改造成promise</p>
<p><code>Deferred用于内部,维护异步模型的状态，Promise作用于外部,通过then()暴露给外部以添加自定义逻辑</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> promisify = <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</div><div class="line">	<span class="keyword">var</span> deferred = <span class="keyword">new</span> Deferred();</div><div class="line">	<span class="keyword">var</span> result = <span class="string">''</span>;</div><div class="line">	res.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</div><div class="line">		result += chunk;</div><div class="line">		deferred.progress(chunk);</div><div class="line">	&#125;);</div><div class="line">	res.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		deferred.resolve(result);</div><div class="line">	&#125;);</div><div class="line">	res.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">		deferred.reject(err);</div><div class="line">	&#125;);</div><div class="line">	<span class="keyword">return</span> deferred.promise;<span class="comment">//更改内部状态的行为由定义者处理  </span></div><div class="line">&#125;;</div><div class="line"><span class="comment">//then调用的是promise</span></div><div class="line">promisify(res).then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="comment">// Done</span></div><div class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">	<span class="comment">// Error</span></div><div class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</div><div class="line">	<span class="comment">// progress</span></div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'BODY: '</span> + chunk);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><code>Promise多异步协作，all()</code></p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">Deferred</span>.prototype.<span class="built_in">all</span> = <span class="function"><span class="keyword">function</span><span class="params">(promises)</span></span> &#123;</div><div class="line">	var <span class="built_in">count</span> = promises.length;</div><div class="line">	var that = this;</div><div class="line">	var results = [];</div><div class="line">	promises.forEach(<span class="function"><span class="keyword">function</span><span class="params">(promise, i)</span></span> &#123;</div><div class="line">		promise.<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">(data)</span></span> &#123;</div><div class="line">			<span class="built_in">count</span>--;</div><div class="line">			results[i] = <span class="keyword">data</span>;</div><div class="line">			<span class="keyword">if</span> (<span class="built_in">count</span> === <span class="number">0</span>) &#123;</div><div class="line">				that.resolve(results);</div><div class="line">			&#125;</div><div class="line">		&#125;, <span class="function"><span class="keyword">function</span><span class="params">(err)</span></span> &#123;</div><div class="line">			that.reject(err);</div><div class="line">		&#125;);</div><div class="line">	&#125;);</div><div class="line">	<span class="keyword">return</span> this.promise;</div><div class="line">&#125;; </div><div class="line"></div><div class="line">//<span class="built_in">all</span>()返回resolve()结果集</div></pre></td></tr></table></figure>
<p><code>Promise链式调用</code></p>
<ul>
<li>前一个的调用的结果，作为下一个调用的开始，后一个then的回调函数会等待前一个promise的状态变化而运行</li>
</ul>
<p><code>将API Promise化</code></p>
<pre><code>// smooth(fs.readFile);
var smooth = function(method) {
    return function() {
        var deferred = new Deferred();
        var args = Array.prototype.slice.call(arguments, 1); //跳过第一个参数
        args.push(deferred.callback());
        method.apply(null, args);
        return deferred.promise;
    };
};

<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bluebrid的 </span>promisify可以将api promise化</div></pre></td></tr></table></figure>

var Promise = require(&apos;bluebird&apos;)
fs.readFileAsync = Promise.promisify(fs.readFie, fs)

var Promise = require(&apos;bluebird&apos;)
Promise.promisifyAll(fs)

<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### async</div><div class="line">`串行执行`：series()</div></pre></td></tr></table></figure>

async.series([
    function(callback) {
        fs.readFile(&apos;file1.txt&apos;, &apos;utf-8&apos;, callback);
    },
    function(callback) {
        fs.readFile(&apos;file2.txt&apos;, &apos;utf-8&apos;, callback);
    }
], function(err, results) {
    // results =&gt; [file1.txt, file2.txt] 
});

<figure class="highlight gcode"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">传入的callback<span class="comment">()</span>不是由使用者指定，callback<span class="comment">()</span>执行时将结果保存然后执行下一个调用，最终的回调函数执行时，保存的结果以数组传入，一旦异常结束所有调用，将异常传递给最终函数的第一个参数</div><div class="line"></div><div class="line">`并行执行`:parallel<span class="comment">()</span></div></pre></td></tr></table></figure>

async.parallel([function(callback) {
        fs.readFile(&apos;file1.txt&apos;, &apos;utf-8&apos;, callback);
    },
    function(callback) {
        fs.readFile(&apos;file2.txt&apos;, &apos;utf-8&apos;, callback);
    }
], function(err, results) {
    // results =&gt; [file1.txt, file2.txt] 
});

//等价于
var counter = 2;
var results = [];
var done = function(index, value) {
    results[index] = value;
    counter--;
    if (counter === 0) {
        callback(null, results);
    }
};
// 只传递第一个异常
var hasErr = false;
var fail = function(err) {
    if (!hasErr) {
        hasErr = true;
        callback(err);
    }
};
fs.readFile(&apos;file1.txt&apos;, &apos;utf-8&apos;, function(err, content) {
    if (err) {
        return fail(err);
    }
    done(0, content);
});
fs.readFile(&apos;file2.txt&apos;, &apos;utf-8&apos;, function(err, data) {
    if (err) {
        return fail(err);
    }
    done(1, data);
});
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">一旦异步调用异常，，就将异常作为第一个参数传给最终回调函数，结果为数组</div><div class="line"></div><div class="line">`异步调用 依赖`：当前一个的结果是后一个调用的输入 waterfall()</div></pre></td></tr></table></figure>

async.waterfall([function(callback) {
        fs.readFile(&apos;file1.txt&apos;, &apos;utf-8&apos;, function(err, content) {
            callback(err, content);
        });
    },
    function(arg1, callback) {
        // arg1 =&gt; file2.txt
        fs.readFile(arg1, &apos;utf-8&apos;, function(err, content) {
            callback(err, content);
        });
    },
    function(arg1, callback) {
        // arg1 =&gt; file3.txt
        fs.readFile(arg1, &apos;utf-8&apos;, function(err, content) {
            callback(err, content);
        });
    }
], function(err, result) {
    // result =&gt; file4.txt 
});

<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">`自动依赖处理` auto()</div></pre></td></tr></table></figure>

{
    readConfig: function() {}, //读取配置
    connectMongoDB: function() {},//连接mongo
    connectRedis: function() {},//连接redis
    complieAsserts: function() {},//编译静态
    uploadAsserts: function() {},//上传静态到cdn
    startup: function() {}//启动
}

var deps = {
    readConfig: function(callback) {
        // read config file
        callback();
    },
    connectMongoDB: [&apos;readConfig&apos;, function(callback) { 
    // connect to mongodb
        callback();
    }],
    connectRedis: [&apos;readConfig&apos;, function(callback) {
        // connect to redis callback();
        图灵社区会员 Eric Liu(guangqiang.dev @gmail.com) 专享 尊重版权
    }],
    complieAsserts: function(callback) {
        // complie asserts
        callback();
    },
    uploadAsserts: [&apos;complieAsserts&apos;, function(callback) {
        // upload to assert 2 callback();
    }],
    startup: [&apos;connectMongoDB&apos;, &apos;connectRedis&apos;, &apos;uploadAsserts&apos;, function(callback) {
        // startup
    }] 
};

//auto根据依赖关系自动分析
async.auto(deps);
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### Step </div><div class="line">`串行`</div></pre></td></tr></table></figure>

Step(
    function readFile1() {
        fs.readFile(&apos;file1.txt&apos;, &apos;utf-8&apos;, this);
    },
    function readFile2(err, content) {
        fs.readFile(&apos;file2.txt&apos;, &apos;utf-8&apos;, this);
    },
    function done(err, content) {
        console.log(content);
    }
);

<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">this</span>是<span class="keyword">Step</span>内部的一个<span class="keyword">next</span>()方法,将调用结果作为下一个任务的参数并调用</div><div class="line"></div><div class="line">`并行` parallel()</div></pre></td></tr></table></figure>

Step(
    function readFile1() {
        fs.readFile(&apos;file1.txt&apos;, &apos;utf-8&apos;, this.parallel());
        fs.readFile(&apos;file2.txt&apos;, &apos;utf-8&apos;, this.parallel());
    },
    function done(err, content1, content2) {
        // content1 =&gt; file1
        // content2 =&gt; file2 
        console.log(arguments);
    });
</code></pre><p>如果异步方法传回结果为多个参数，step只取前两个。parallel（）原理是每次执行时将内部计数器加1，</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/31/es6-Generator/" itemprop="url">
                  es6 Generator
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-03-31T15:06:15+08:00" content="2016-03-31">
              2016-03-31
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/03/31/es6-Generator/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/03/31/es6-Generator/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><ul>
<li>把它理解成一个状态机，封装了多个内部状态，执行Generator函数会返回一个遍历器对象，可以依次遍历Generator函数内部的每一个状态。</li>
<li>定义时function与函数名之间有一个星号</li>
<li>内部使用yield（产出）语句，定义不同的内部状态</li>
<li>调用遍历器对象的next方法，使指针移向下一个状态</li>
</ul>
<p>调用Generator函数后，该函数并不执行，而是返回一个指向内部状态的指针对象，每次调用next方法，内部指针就从函数头部或上一次停下来的地方开始执行，直到遇到下一个yield语句（或return语句）为止。<strong>Generator函数是分段执行的，yield语句是暂停执行的标记，而next方法可以恢复执行</strong></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">helloWorldGenerator</span><span class="params">()</span></span> &#123;</div><div class="line">  yield <span class="string">'hello'</span>;</div><div class="line">  yield <span class="string">'world'</span>;</div><div class="line">  <span class="keyword">return</span> <span class="string">'ending'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">var hw = helloWorldGenerator();</div><div class="line"></div><div class="line">hw.<span class="built_in">next</span>()</div><div class="line">// &#123; value: <span class="string">'hello'</span>, done: <span class="keyword">false</span> &#125;</div><div class="line"></div><div class="line">hw.<span class="built_in">next</span>()</div><div class="line">// &#123; value: <span class="string">'world'</span>, done: <span class="keyword">false</span> &#125;</div><div class="line"></div><div class="line">hw.<span class="built_in">next</span>()</div><div class="line">// &#123; value: <span class="string">'ending'</span>, done: <span class="keyword">true</span> &#125;，执行完成done变成<span class="keyword">true</span></div><div class="line"></div><div class="line">hw.<span class="built_in">next</span>()</div><div class="line">// &#123; value: undefined, done: <span class="keyword">true</span> &#125;</div></pre></td></tr></table></figure>
<h3 id="yield语句"><a href="#yield语句" class="headerlink" title="yield语句"></a>yield语句</h3><ul>
<li>遍历器对象的next遇到yield语句，就暂停执行后面的操作，并将紧跟在yield后面的那个表达式的值，作为返回的对象的value属性值</li>
<li>下一次调用next方法时，再继续往下执行，直到遇到下一个yield语句</li>
<li>如果没有再遇到新的yield语句，就一直运行到函数结束，直到return语句为止，并将return语句后面的表达式的值，作为返回的对象的value属性值,若无则返回undefined</li>
<li>yield语句如果用在一个表达式之中，必须放在圆括号里面，作函数参数或赋值表达式的右边除外</li>
</ul>
<p>yield与return区别在于每次遇到yield，函数暂停执行，下一次再从该位置继续向后执行，而return不具备位置记忆的功能。一个函数里面，只能执行一次（或者说一个）return语句，但是可以执行多次（或者说多个）yield语句,所以Generator函数可以返回一系列的值，即生成器之意</p>
<p>yield句本身没有返回值，或者说总是返回undefined。<strong>next方法可以带一个参数，该参数就会被当作上一个yield语句的返回值</strong>。第一次使用next方法时，不能带有参数,V8引擎直接忽略第一次使用next方法时的参数，只有从第二次使用next方法开始，参数才是有效的。从语义上讲，第一个next方法用来启动遍历器对象，所以不用带有参数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">f</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; <span class="literal">true</span>; i++) &#123;</div><div class="line">    <span class="keyword">var</span> reset = <span class="keyword">yield</span> i;</div><div class="line">    <span class="keyword">if</span>(reset) &#123; i = <span class="number">-1</span>; &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> g = f();</div><div class="line"></div><div class="line">g.next() <span class="comment">// &#123; value: 0, done: false &#125;</span></div><div class="line">g.next() <span class="comment">// &#123; value: 1, done: false &#125;</span></div><div class="line">g.next(<span class="literal">true</span>) <span class="comment">// &#123; value: 0, done: false &#125;</span></div></pre></td></tr></table></figure>
<p>通过next方法的参数，向Generator函数内部输入值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">dataConsumer</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Started'</span>);</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">`1. <span class="subst">$&#123;<span class="keyword">yield</span>&#125;</span>`</span>);</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">`2. <span class="subst">$&#123;<span class="keyword">yield</span>&#125;</span>`</span>);</div><div class="line">  <span class="keyword">return</span> <span class="string">'result'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> genObj = dataConsumer();</div><div class="line">genObj.next();</div><div class="line"><span class="comment">// Started</span></div><div class="line">genObj.next(<span class="string">'a'</span>)</div><div class="line"><span class="comment">// 1. a</span></div><div class="line">genObj.next(<span class="string">'b'</span>)</div><div class="line"><span class="comment">// 2. b</span></div></pre></td></tr></table></figure>
<h3 id="与Iterator接口的关系"><a href="#与Iterator接口的关系" class="headerlink" title="与Iterator接口的关系"></a>与Iterator接口的关系</h3><ul>
<li>执行Generator函数后返回Iterator对象</li>
</ul>
<p>for…of循环、扩展运算符（…）、解构赋值和Array.from方法内部调用的，都是使用遍历器接口，即可以自动遍历Generator函数</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">扩展运算符（...）用于取出参数对象的所有可遍历属性，拷贝到当前对象之中。</div><div class="line"></div><div class="line"><span class="keyword">let</span> z = &#123; a: <span class="number">3</span>, b: <span class="number">4</span> &#125;;</div><div class="line"><span class="keyword">let</span> n = &#123; ...z &#125;;</div><div class="line">n <span class="comment">// &#123; a: 3, b: 4 &#125;</span></div><div class="line"></div><div class="line">扩展运算符可以用于合并两个对象。</div><div class="line"></div><div class="line"><span class="keyword">let</span> ab = &#123; ...a, ...b &#125;;</div><div class="line"><span class="comment">// 等同于</span></div><div class="line"><span class="keyword">let</span> ab = Object.assign(&#123;&#125;, a, b);</div></pre></td></tr></table></figure>
<h3 id="Generator-prototype-return"><a href="#Generator-prototype-return" class="headerlink" title="Generator.prototype.return()"></a>Generator.prototype.return()</h3><ul>
<li>遍历器对象的return方法，可以返回给定的值，并且终结遍历Generator函数</li>
</ul>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">function* gen() &#123;</div><div class="line">  <span class="keyword">yield</span> <span class="number">1</span>;</div><div class="line">  <span class="keyword">yield</span> <span class="number">2</span>;</div><div class="line">  <span class="keyword">yield</span> <span class="number">3</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">var g = gen();</div><div class="line"></div><div class="line">g.next()        <span class="regexp">//</span> &#123; value: <span class="number">1</span>, done: <span class="literal">false</span> &#125;</div><div class="line">g.<span class="keyword">return</span>(<span class="string">"foo"</span>) <span class="regexp">//</span> &#123; value: <span class="string">"foo"</span>, done: <span class="literal">true</span> &#125;,<span class="keyword">return</span>不提供参数，则返回值的vaule属性为<span class="literal">undefined</span></div><div class="line">g.next()        <span class="regexp">//</span> &#123; value: <span class="literal">undefined</span>, done: <span class="literal">true</span> &#125;</div></pre></td></tr></table></figure>
<h3 id="yield-语句"><a href="#yield-语句" class="headerlink" title="yield*语句"></a>yield*语句</h3><ul>
<li>用来在一个Generator函数里面执行另一个Generator函数</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">yield</span> <span class="string">'a'</span>;</div><div class="line">  <span class="keyword">yield</span> <span class="string">'b'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">bar</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">yield</span> <span class="string">'x'</span>;</div><div class="line">  <span class="keyword">yield</span>* foo();</div><div class="line">  <span class="keyword">yield</span> <span class="string">'y'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 等同于</span></div><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">bar</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">yield</span> <span class="string">'x'</span>;</div><div class="line">  <span class="keyword">yield</span> <span class="string">'a'</span>;</div><div class="line">  <span class="keyword">yield</span> <span class="string">'b'</span>;</div><div class="line">  <span class="keyword">yield</span> <span class="string">'y'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 等同于</span></div><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">bar</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">yield</span> <span class="string">'x'</span>;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> v <span class="keyword">of</span> foo()) &#123;</div><div class="line">    <span class="keyword">yield</span> v;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">yield</span> <span class="string">'y'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">let</span> v <span class="keyword">of</span> bar())&#123;</div><div class="line">  <span class="built_in">console</span>.log(v);</div><div class="line">&#125;</div><div class="line"><span class="comment">// "x"</span></div><div class="line"><span class="comment">// "a"</span></div><div class="line"><span class="comment">// "b"</span></div><div class="line"><span class="comment">// "y"</span></div></pre></td></tr></table></figure>
<p><code>yield*语句等同于在Generator函数内部，部署一个for...of循环</code> ,如果yield*后面跟着一个数组，由于数组原生支持遍历器，因此就会遍历数组成员,还有字符串之类有Iterator接口的数据结构</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">gen</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="keyword">yield</span>* [<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">gen().next() <span class="comment">// &#123; value:"a", done:false &#125;</span></div></pre></td></tr></table></figure>
<figure class="highlight zephir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 下面是二叉树的构造函数，</span></div><div class="line"><span class="comment">// 三个参数分别是左树、当前节点和右树</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Tree</span><span class="params">(left, label, right)</span> </span>&#123;</div><div class="line">  this.left = left;</div><div class="line">  this.label = label;</div><div class="line">  this.right = right;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 下面是中序（inorder）遍历函数。</span></div><div class="line"><span class="comment">// 由于返回的是一个遍历器，所以要用generator函数。</span></div><div class="line"><span class="comment">// 函数体内采用递归算法，所以左树和右树要用yield*遍历</span></div><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">inorder</span><span class="params">(t)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (t) &#123;</div><div class="line">    <span class="keyword">yield</span>* inorder(t.left);</div><div class="line">           <span class="keyword">yield</span> t.label;</div><div class="line">    <span class="keyword">yield</span>* inorder(t.right);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 下面生成二叉树</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">make</span><span class="params">(array)</span> </span>&#123;</div><div class="line">  <span class="comment">// 判断是否为叶节点</span></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">array</span>.length == <span class="number">1</span>) <span class="keyword">return</span> <span class="keyword">new</span> Tree(<span class="keyword">null</span>, <span class="keyword">array</span>[<span class="number">0</span>], <span class="keyword">null</span>);</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Tree(make(<span class="keyword">array</span>[<span class="number">0</span>]), <span class="keyword">array</span>[<span class="number">1</span>], make(<span class="keyword">array</span>[<span class="number">2</span>]));</div><div class="line">&#125;</div><div class="line"><span class="keyword">let</span> tree = make([[[<span class="string">'a'</span>], <span class="string">'b'</span>, [<span class="string">'c'</span>]], <span class="string">'d'</span>, [[<span class="string">'e'</span>], <span class="string">'f'</span>, [<span class="string">'g'</span>]]]);</div><div class="line"></div><div class="line"><span class="comment">// 遍历二叉树</span></div><div class="line"><span class="keyword">var</span> result = [];</div><div class="line"><span class="keyword">for</span> (<span class="keyword">let</span> node of inorder(tree)) &#123;</div><div class="line">  result.push(node);</div><div class="line">&#125;</div><div class="line"></div><div class="line">result</div><div class="line"><span class="comment">// ['a', 'b', 'c', 'd', 'e', 'f', 'g']</span></div></pre></td></tr></table></figure>
<h3 id="Generator的一些应用"><a href="#Generator的一些应用" class="headerlink" title="Generator的一些应用"></a>Generator的一些应用</h3><h4 id="异步转同步"><a href="#异步转同步" class="headerlink" title="异步转同步"></a>异步转同步</h4><p><code>可以把异步操作写在yield语句里面，等到调用next方法时再往后执行</code></p>
<figure class="highlight qml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">main</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="built_in">var</span> result = <span class="keyword">yield</span> request(<span class="string">"http://some.url"</span>);</div><div class="line">	<span class="built_in">var</span> resp = <span class="built_in">JSON</span>.parse(result);</div><div class="line">	<span class="built_in">console</span>.log(resp.value);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">request</span>(<span class="params">url</span>) </span>&#123;</div><div class="line">	makeAjaxCall(<span class="built_in">url</span>, <span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</div><div class="line">		it.next(response);   <span class="comment">//因为yield语句构成的表达式，本身是没有值的,必须加上response参数</span></div><div class="line">	&#125;);</div><div class="line">&#125;</div><div class="line"><span class="built_in">var</span> it = main();</div><div class="line">it.next();</div></pre></td></tr></table></figure>
<h4 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h4><p><code>多个任务需要并列执行时,可以采用数组的写法</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">parallelDownloads</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">let</span> [text1,text2] = <span class="keyword">yield</span> [</div><div class="line">    taskA(),</div><div class="line">    taskB()</div><div class="line">  ];</div><div class="line">  <span class="built_in">console</span>.log(text1, text2);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="部署iterator接口"><a href="#部署iterator接口" class="headerlink" title="部署iterator接口"></a>部署iterator接口</h4><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">function* iterEntries(obj) &#123;</div><div class="line">  <span class="keyword">let</span> keys = Object.keys(obj);</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="number">0</span>; i &lt; keys.length; i++) &#123;</div><div class="line">    <span class="keyword">let</span> <span class="built_in">key</span> = keys[i];</div><div class="line">    yield [<span class="built_in">key</span>, obj[<span class="built_in">key</span>]];</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> myObj = &#123; foo: <span class="number">3</span>, <span class="built_in">bar</span>: <span class="number">7</span> &#125;;</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">let</span> [<span class="built_in">key</span>, value] of iterEntries(myObj)) &#123;</div><div class="line">  console.<span class="built_in">log</span>(<span class="built_in">key</span>, value);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// foo 3</span></div><div class="line"><span class="comment">// bar 7</span></div></pre></td></tr></table></figure>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/29/Node异步I-O/" itemprop="url">
                  Node异步I/O
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-03-29T15:27:32+08:00" content="2016-03-29">
              2016-03-29
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index">
                    <span itemprop="name">nodejs</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/03/29/Node异步I-O/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/03/29/Node异步I-O/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p><code>让I/O与CPU计算并行</code></p>
<p>Node 在*nix平台，通过线程池实现(主线程和I/O线程)，在windows下使用IOCP(调用异步方法，等待I/O完成后通知，执行回调，内部也依靠线程池，但由系统内核管理)，通过libuv层来兼容。</p>
<p>Node本身是多线程的，但其中的JavaScript是单线程、因为v8的限制，但计算之类的都是在此线程，多线程只是I/O（磁盘，网络等），I/O有另外的线程池</p>
<h3 id="事件循环"><a href="#事件循环" class="headerlink" title="事件循环"></a>事件循环</h3><ul>
<li><p>Node自身的执行模型,在libuv中</p>
</li>
<li><p>在Node启动时，创建一个类似while(true)的循环，每循环一次成一个Tick,每次Tick查看是否有事件要处理，若有就处理事件和它的相关回调函数。在windows中基于IOCP,在*nix中基于多线程</p>
</li>
<li><p>在Tick过程中通过<strong>观察者</strong>判断是否有事件要处理  </p>
</li>
<li><p>异步过程中最重要的就是请求对象，所有状态、传入参数、当前方法和回调函数都封装在此，javascript将对象组装好，送入I/O线程池后就结束了，I/O操作在线程池中等待请求对象被执行</p>
</li>
<li><p>Tick在执行过程中检查线程池中是否有执行完的请求，并加入<strong>I/O观察者队列</strong>中，然后再从观察者取到可用的请求对象当做事件处理，取出对象中的回调函数执行,若有业务层callback再给js执行</p>
</li>
</ul>
<p><img src="../picture/IO异步.png" alt="Smaller icon"></p>
<h4 id="事件驱动的高性能服务器"><a href="#事件驱动的高性能服务器" class="headerlink" title="事件驱动的高性能服务器"></a>事件驱动的高性能服务器</h4><p>基于事件驱动的非阻塞I/O模型<br><code>通过主循环加载事件触发的方式来运行程序处理请求，无需为每一个请求创建额外的对应线程</code>：操作系统因为线程少，所以在上下文切换时代价很小，有助系统稳定处理大量请求（但不适合密集运算),但用户代码不能并行执行，I/O可以</p>
<ul>
<li>单线程保证运行安全，避免重入</li>
</ul>
<p><img src="../picture/高性能服务器.png" alt="Smaller icon"></p>
<h3 id="另外一些异步api"><a href="#另外一些异步api" class="headerlink" title="另外一些异步api"></a>另外一些异步api</h3><h4 id="定时器"><a href="#定时器" class="headerlink" title="定时器"></a>定时器</h4><ul>
<li>setTimeout()单次定时执行 setInterval()多次定时执行</li>
</ul>
<p>原理和异步I/O类似，将创建的定时器放到定时器观察者内部的红黑树，tick执行时，从红黑树中迭代取出定时器对象，检查是否超过定时时间，超过就形成事件并且立刻执行回调函数。</p>
<p><code>问题</code>：定时不精确，如果某个循环占用时间过多，当再轮到定时器执行时就已经超时了</p>
<h4 id="process-nextTick"><a href="#process-nextTick" class="headerlink" title="process.nextTick()"></a>process.nextTick()</h4><ul>
<li>若想立即异步执行一个任务，用这个更高效</li>
</ul>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123; <span class="comment">// TODO</span>&#125;, <span class="number">0</span>);<span class="comment">// 比较浪费性能</span></div><div class="line"></div><div class="line">process.nextTick=<span class="function"><span class="keyword">function</span><span class="params">(callback)</span></span>&#123;</div><div class="line">	<span class="keyword">if</span>(process._exiting) <span class="keyword">return</span>;</div><div class="line">	<span class="keyword">if</span>(tickDepth &gt;=process.maxTickDepth)</div><div class="line">	   maxTickWarn();</div><div class="line">	<span class="keyword">var</span> tock=&#123;callback:callback&#125;;</div><div class="line">	<span class="keyword">if</span>(process.domain) tock.domain=process.domain;</div><div class="line">	 nextTickQueue.push(tock);</div><div class="line">	<span class="keyword">if</span>(nextTickQueue.length)&#123;</div><div class="line">	  process._needTickCallback();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>调用process.nextTick(),只会将回调函数放入队列中，在下个Tick取出</code></p>
<h4 id="setImmediate"><a href="#setImmediate" class="headerlink" title="setImmediate()"></a>setImmediate()</h4><ul>
<li>类process.nextTick() 将回调函数延时执行，建议使用这个（v0.9.1以后）</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">process.nextTick(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'nextTick延时执行1'</span>)</div><div class="line">&#125;);</div><div class="line">process.nextTick(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'nextTick延时执行2'</span>);</div><div class="line">&#125;);</div><div class="line">setImmdiate(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'setImmdiate延时执行1'</span>);</div><div class="line">	process.nextTick(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'强势插入'</span>);</div><div class="line">	&#125;)</div><div class="line">&#125;);  </div><div class="line">setImmediate(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'setImmediate延时执行2'</span>); </div><div class="line">&#125;);</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'正常执行'</span>);</div><div class="line"></div><div class="line"><span class="comment">//正常执行 </span></div><div class="line"><span class="comment">//nextTick  延时执行1 </span></div><div class="line"><span class="comment">//nextTick  延时执行2 </span></div><div class="line"><span class="comment">//setImmediate  延时执行1  </span></div><div class="line"><span class="comment">//强势插入 </span></div><div class="line"><span class="comment">//setImmediate  延时执行2</span></div></pre></td></tr></table></figure>
<p><code>process.nextTick()属于idle观察者，setImmediate()属于check观察者，在每轮循环中，idle观察者先于I/O观察者先与check</code></p>
<p>process.nextTick()的回调函数保存在<strong>数组</strong>中,在每轮循环中会将数组中的回调函数<strong>全部执行</strong>完。setImmediate()保存在<strong>链表</strong>中,在每轮循环中<strong>执行链表的一个</strong>回调函数</p>
<h3 id="异步并发控制"><a href="#异步并发控制" class="headerlink" title="异步并发控制"></a>异步并发控制</h3><p>并发量过大,下层服务器会吃不消</p>
<h5 id="bagpipe"><a href="#bagpipe" class="headerlink" title="bagpipe"></a>bagpipe</h5><ol>
<li>通过队列控制并发量</li>
<li>在当前活跃的异步调用量小于限定值，从队列中取出执行</li>
<li>活跃调用达到限定值后，调用暂存在队列中</li>
<li>每个调用结束时，从队列中取出新的异步调用执行</li>
</ol>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/15/node的模块加载/" itemprop="url">
                  node的模块加载
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-03-15T10:53:32+08:00" content="2016-03-15">
              2016-03-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index">
                    <span itemprop="name">nodejs</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/03/15/node的模块加载/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/03/15/node的模块加载/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="模块实现"><a href="#模块实现" class="headerlink" title="模块实现"></a>模块实现</h3><p>依照CommonJS的模块规范，使用require()引入模块的api,使用exports导出模块的方法、变量；其中module对象代表模块本身，exports是它的属性</p>
<p><code>优点： 每个模块有独立的空间、不必考虑变量污染</code></p>
<p>Node引入模块通过路径分析、文件定位、编译执行，会对引入的模块缓<strong>存其编译和执行后的对象</strong>，二次加载时缓存<strong>优先核心模块之后文件模块</strong>。加载自定义模块（第三方包）最慢，要向上逐级递归查找node_modules目录</p>
<p>因为允许require()中不含文件拓展名，Node会按照<code>.js、.node、.json的次序补足，依次尝试</code>,并且需要调用fs模块同步阻塞判断文件是否存在，会因为Node单线程引起性能问题，<code>对于.node、.json文件带上拓展名能快些</code></p>
<h4 id="分析目录和包"><a href="#分析目录和包" class="headerlink" title="分析目录和包"></a>分析目录和包</h4><p>require()通过分析文件拓展名后仍然没有查到文件、但取到一个目录，此时Node会将目录当做包来处理。</p>
<ol>
<li>在当前目录下查找package.json(CommonJS规定的包描述文件)</li>
<li>通过JSON.parse()解析，取出main属性指定的文件名，若无拓展名就遍历拓展名</li>
</ol>
<p>如果mian属性指定文件名错误、没有package.json文件，Node会把index.当做默认文件名，依次查找、遍历拓展名。</p>
<p>如果分析目录后没有定位成功，就进入下一个模块路径查找，模块路径都都遍历完了还没找到就抛错。</p>
<h3 id="模块编译"><a href="#模块编译" class="headerlink" title="模块编译"></a>模块编译</h3><p><code>.js 通过fs同步读取文件后编译执行</code> ,Node对获取的js文件内容进行了头尾包装</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">exports,<span class="built_in">require</span>,<span class="built_in">module</span>,__filename,__dirname</span>)</span>&#123;<span class="comment">//头尾包装</span></div><div class="line">  <span class="keyword">var</span> math=<span class="built_in">require</span>(<span class="string">'math'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>如此每个模块都有作作用域隔离，包装后的代码通过vm原生模块runInThisContext()执行，返回一个function对象，再将当前模块对象的exports属性、require()、module、文件的完整路径和文件目录作为参数传给function()。最后调用方拿到了exports属性</p>
<p><strong>exports和module.exports的区别</strong> exports对象是以形参形式传入的，直接赋值不会改变作用域外的值。所以需要对module.exports对象赋值，对exports属性赋值则无碍</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> change = <span class="function"><span class="keyword">function</span>(<span class="params">a</span>) </span>&#123;</div><div class="line">	a = <span class="number">100</span>;</div><div class="line">	<span class="built_in">console</span>.log(a); <span class="comment">// =&gt; 100</span></div><div class="line">&#125;;</div><div class="line"><span class="keyword">var</span> a = <span class="number">10</span>;</div><div class="line">change(a);</div><div class="line"><span class="built_in">console</span>.log(a); <span class="comment">// =&gt; 10</span></div></pre></td></tr></table></figure>
<p><code>.node 这是用c/c++编写的拓展文件，通过dlopen()加载再编译</code> 在windows、*nix有不同的实现，通过libuv兼容层封装,实际不用编译，它是c/c++编译生成的，只要加载、执行，exports对象直接和.node联系，执行效率高</p>
<p><code>.json 通过fs读取，使用JSON.parse()解析，再赋值给exports</code> ,对于JSON文件直接用require()比fs高效</p>
<p>将编译后的模块，以文件路径为索引缓存在Module.cache对象上</p>
<h3 id="核心模块"><a href="#核心模块" class="headerlink" title="核心模块"></a>核心模块</h3><ul>
<li>将核心模块中纯用c/c++写的称为建内模块，因为通常不被用户调用</li>
<li>部分模块通过c/c++编写核心部分，js实现包装、导出来提高性能</li>
</ul>
<p>Node使用v8的js2c.py将所有内置js转成c++里的数组，生成node_natives.sh头文件，在Node启动时加入内存，然后再根据require()加载、执行;也要经历头尾包装，缓存在NativeModule._cache对象上</p>
<h3 id="NPM"><a href="#NPM" class="headerlink" title="NPM"></a>NPM</h3><p><code>package.json 包描述文件</code>  dependencies npm根据这个自动加载依赖的包,scripts 用于包管理器来安装、编译、测试和卸载包(钩子命令，preinstall之类的) devDependencies 开发时的依赖包，bin 命令行工具</p>
<p><code>全局安装 -g</code> 将包变成全局可用的执行命令，不是require()到</p>
<p><code>其他方式安装包</code> npm install 指定package.json的位置，npm install [pg] –registry=<a href="http://registry.url" target="_blank" rel="external">http://registry.url</a> 或者直接采用镜像源 npm config set registry <a href="http://registry.url" target="_blank" rel="external">http://registry.url</a></p>
<p><code>局域NPM</code></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/06/mysql事务与锁/" itemprop="url">
                  mysql事务与锁
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-03-06T14:56:20+08:00" content="2016-03-06">
              2016-03-06
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/03/06/mysql事务与锁/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/03/06/mysql事务与锁/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="事务定义"><a href="#事务定义" class="headerlink" title="事务定义"></a>事务定义</h3><p><code>一组原子性SQL查询，独立的工作单元</code></p>
<p>ACID(atomicity-原子性,consistency-一致性,isolation-隔离性,durability-持久性)</p>
<ul>
<li>事务不可分割</li>
<li>从一个一致性状态转到另一个一致性状态</li>
<li>事务修改提交之前对其他事务不可见</li>
<li>一旦提交，永远保存</li>
</ul>
<p><code>根据业务是否需要事务，选择合适的储存引擎，提升性能</code><br>若存储引擎不支持事务也可以使用<strong>locktable</strong>提供一定保护</p>
<h4 id="隔离级别"><a href="#隔离级别" class="headerlink" title="隔离级别"></a>隔离级别</h4><ul>
<li>脏读（dirty read）：事务读取了未提交的数据</li>
<li>不可重复读（nonrepeatable read）：事务T1读取一行记录，紧接着事务T2修改了T1刚才读取的那一行记录，然后T1又再次读取这行记录，发现与刚才读取的结果不同</li>
<li>幻像读（phantom read）：当某个事务在读某个范围内的记录时，另一个事务又在该范围内加入了新的记录，当之前的事务再读取该范围的记录时，会产生幻行。InnoDB和XtraDB存储引擎通过MVCC解决了幻像读的问题</li>
</ul>
<p><code>READ UNCOMMITTED(未提交读)</code>: 事务的修改即使未提交，对其他事务也可见，性能略好，但有很多问题，不建议使用</p>
<p><code>READ COMMITTED(提交读)</code>: 事务所做的修改在提交前对其他事务不可见，大多数数据库默认隔离级别</p>
<p><code>REPEATABLE READ(可重复读)</code>: 同一事务多次读取的记录结果是一致的,Mysql默认级别</p>
<p><code>SERIALIZABLE(序列化)</code> : 强制事务串行执行，会对读取的每一行数据加锁，会导致大量的超时和锁争用，用在非常需要确保数据的一致性并且可以接受没有并发的情况下</p>
<table>
<thead>
<tr>
<th>事务的隔离级别</th>
<th>脏读可能性</th>
<th>不可重复读可能性</th>
<th>幻像读可能性</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>READ UNCOMMITTED未提交读</td>
<td>YES</td>
<td>YES</td>
<td>YES</td>
</tr>
<tr>
<td>READ COMMITTED提交读</td>
<td>No</td>
<td>YES</td>
<td>YES</td>
</tr>
<tr>
<td>REPEATABLE READ可重复读</td>
<td>No</td>
<td>No</td>
<td>YES</td>
<td>Mysql默认级别</td>
</tr>
<tr>
<td>SERIALIZABLE序列化</td>
<td>No</td>
<td>No</td>
<td>No</td>
<td>会在读取的每一行数据上都加锁</td>
</tr>
</tbody>
</table>
<h4 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h4><p>多个事务在同一资源上互相占用，并请求锁定对方占用的资源，从而导致恶性循环</p>
<ul>
<li>多个事务以不同的顺序锁定资源</li>
<li>多个事务同时锁定同一资源</li>
</ul>
<p>解决方式：1. 检测到死锁时，立刻返回错误 2. 当查询的时间达到锁等待超时的设定后放弃锁请求</p>
<p><code>InnoDB处理方式</code>： 将持有最少行级排他锁的事务进行回滚</p>
<p>发生死锁后，只有部分或者完全回滚其中一个事务，才能打破死锁。发生死锁无法避免，程序设计时需要考虑如何处理死锁，通常<strong>重新执行因死锁回滚的事务</strong>即可</p>
<h4 id="事务日志"><a href="#事务日志" class="headerlink" title="事务日志"></a>事务日志</h4><p><code>提高事务的效率</code>：</p>
<ol>
<li>存储引擎在修改表的数据时只需要修改其内存拷贝，再把该修改行为记录到持久在硬盘上的事务日志中，而不用将修改的数据本身持久到磁盘。</li>
<li>事务日志采用的是追加的方式，写日志的操作是在磁盘上的一小块顺序I/O，不像随机I/O需要在多次移动磁头。</li>
</ol>
<p>事务日志持久后，内存被修改的数据在后台慢慢刷回到磁盘。称为预写式日志（Write-Ahead Logging），<strong>修改数据需要写两次磁盘</strong>.</p>
<p>若数据的修改已经记录到日志并持久化，即使内存的修改没及时写到磁盘，也可以在存储引擎重启时自动恢复</p>
<h3 id="MySQL事务"><a href="#MySQL事务" class="headerlink" title="MySQL事务"></a>MySQL事务</h3><p>官方提供的事务存储引擎：InnoDB和NDB Cluster<br>             第三方：XtraDB和PBXT</p>
<h4 id="自动提交"><a href="#自动提交" class="headerlink" title="自动提交"></a>自动提交</h4><p>mysql默认会启用自动提交，每个查询都会被当作一个事务执行提交操作，在当前连接中可以设置AUTOCOMMIT 1/ON或0/OFF。</p>
<p><strong>导致大量数据改变的操作ALTER TABLE,还有LOCK TABLES等也会导致自动提交</strong></p>
<h4 id="事务中混合使用存储引擎"><a href="#事务中混合使用存储引擎" class="headerlink" title="事务中混合使用存储引擎"></a>事务中混合使用存储引擎</h4><ul>
<li>在非事务型的表上，回滚操作无效，且不会报错，只会有警告信息</li>
</ul>
<p>为每张表选择合适的存储引擎</p>
<h4 id="隐式、显式锁定"><a href="#隐式、显式锁定" class="headerlink" title="隐式、显式锁定"></a>隐式、显式锁定</h4><ul>
<li>InnoDB使用两段锁定协议，事务执行时，可随时执行锁定，只要到COMMIT或ROLLBACK时才会同时释放所有锁，InnoDB会根据隔离级别自动加锁（隐式）</li>
<li>SELECT … LOCK IN SHARE MODE和 SELECT … FOR UPDATE 显式锁定，但不建议使用</li>
</ul>
<p><code>LOCK TABLES、UNLOCK TABLES</code>服务器层实现，不能代替事务，且影响性能</p>
<h4 id="MVCC多版本并发控制"><a href="#MVCC多版本并发控制" class="headerlink" title="MVCC多版本并发控制"></a>MVCC多版本并发控制</h4><ul>
<li>行级锁变种 能尽量避免加锁 开销低</li>
<li></li>
</ul>
<p>此处介绍InnoDB对MVVC的实现</p>
<p><code>实现原理</code>： 在每行记录后保存两个隐藏的列，一个保存行创建时间，一个保存过期（删除）时间，此处的时间指的是系统版本号，它会在创建事务时递增，</p>
<p><code>具体操作</code>：</p>
<ul>
<li>SElECT<ul>
<li>只查找版本号小号或等于当前事务的版本号，确保读取的行，或是在事务开始之前，或是事务自己插入的</li>
<li>行的删除版本要么未定义，要么大于当前事务版本号，确保事务读到行在事务开始之前未被删除</li>
</ul>
</li>
<li>INSERT<ul>
<li>插入的每一行保存当前系统版本号作为行版本号</li>
</ul>
</li>
<li>DELETE<ul>
<li>插入的每一行保存当前系统版本号作为行版本号   </li>
</ul>
</li>
<li>UPDATE<ul>
<li>为插入的新记录保存当前系统版本号作为行版本号，同时保存当前系统版本号到原来的行作为行删除标识</li>
</ul>
</li>
</ul>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/02/24/angularjs-布局模板和路由/" itemprop="url">
                  angularjs 布局模板和路由
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-02-24T14:54:28+08:00" content="2016-02-24">
              2016-02-24
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/前端/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/02/24/angularjs-布局模板和路由/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/02/24/angularjs-布局模板和路由/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p><strong>将视图（页面）分解成布局和模板视图，再根据当前URL展示对应视图</strong></p>
<h3 id="布局模板"><a href="#布局模板" class="headerlink" title="布局模板"></a>布局模板</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt; header&gt;<span class="xml"><span class="tag">&lt; <span class="attr">h1</span>&gt;</span>Header<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">header</span>&gt;</span></span></div><div class="line">&lt; div <span class="class"><span class="keyword">class</span></span>=<span class="string">"content"</span> &gt;</div><div class="line">   <span class="xml"><span class="tag">&lt; <span class="attr">div</span> <span class="attr">ng-view</span>&gt;</span><span class="tag">&lt; /<span class="attr">div</span>&gt;</span></span><span class="xml"><span class="tag">&lt; /<span class="attr">div</span> &gt;</span></span></div></pre></td></tr></table></figure>
<p>ng-view 由ngRoute模块提供的一个特殊指令, 在HTML中给$route对应的视图内容占位。优先级1000</p>
<ul>
<li>每次触发$routeChangeSuccess事件, 视图会更新 </li>
<li>如果某个模板同当前的路由关联<ul>
<li>创建新作用域</li>
<li>移除上一视图和作用域</li>
<li>将新作用域与当前模板关联</li>
<li>如果路由中控制器定义，则与当前作用域关联</li>
<li>触发$viewContentLoaded </li>
<li>如果提供onload属性,调用所指定的函数     </li>
</ul>
</li>
</ul>
<h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><ul>
<li>使用$routeProvider的when和otherwise</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">angular.module(<span class="string">'myApp'</span>, []).config(<span class="function"><span class="keyword">function</span><span class="params">($routeProvider)</span> </span>&#123;</div><div class="line">   $routeProvider</div><div class="line">       .when(<span class="string">'/'</span>,&#123;</div><div class="line">          <span class="comment">//  controller、template、templateURL、resolve、redirectTo、reloadOnSearch和css</span></div><div class="line">       &#125;)</div><div class="line">   &#125;）</div></pre></td></tr></table></figure>
<p><code>controller</code> 字符串或函数</p>
<p><code>template</code> html模板,<code>templateURL</code>模板链接</p>
<p><code>resolve</code> 将resolve对象里的值注入到控制器中</p>
<p><code>redirectTo</code> 路由替换，字符串或者函数，在调用函数时会传入：从当前路径中提取的路由参数，当前路径，当前URL中的查询串</p>
<p><code>reloadOnSearch</code> true时， $location.search()变化时会重新加载路由</p>
<h4 id="路由模式"><a href="#路由模式" class="headerlink" title="路由模式"></a>路由模式</h4><ul>
<li>标签模式</li>
</ul>
<h3 id="location服务"><a href="#location服务" class="headerlink" title="$location服务"></a>$location服务</h3><p>类window.location,能修改路径和内部跳转，不能刷新整个页面</p>
<ul>
<li>$location.path() 获取或修改路径，并且与HTML5的历史api交互，提供用户后退的功能,加replace()，就不能后退</li>
<li>absUrl() 获取编码后完整的URL</li>
<li>hash() 获取URL中的hash片段  </li>
<li>host() 获取URL中的主机，port()端口号，</li>
<li>protocol() 获取URL中的协议</li>
<li>search() 获取URL中的查询串，也可以用对象、字符串设置查询</li>
<li>url() 获取或修改当前的URL</li>
</ul>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="https://schema.org/Person">
          <img class="site-author-image" src="http://wmtcore.com/uploads/avatar.png" alt="WMT" itemprop="image"/>
          <p class="site-author-name" itemprop="name">WMT</p>
        </div>
        <p class="site-description motion-element" itemprop="description">不扯犊子 -NOT ALONE</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">53</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">15</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">21</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/WMTcore" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015-12 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WMT</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"wmtcore"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     
     
  	  <script type="text/javascript">
  		var duoshuo_user_ID = 6224283662221837000
      var duoshuo_admin_nickname="作者"
  	  </script>
     
  	<script src="/js/ua-parser.min.js"></script>
  	<script src="/js/hook-duoshuo.js"></script>
  


    
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  

  
  

</body>
</html>
