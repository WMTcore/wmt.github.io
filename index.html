<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






  <meta name="baidu-site-verification" content="SoMgkf0fOF" />







  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="WMTcore" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="不扯犊子 -NOT ALONE">
<meta property="og:type" content="website">
<meta property="og:title" content="大碗拉面">
<meta property="og:url" content="https://www.wmtcore.com/index.html">
<meta property="og:site_name" content="大碗拉面">
<meta property="og:description" content="不扯犊子 -NOT ALONE">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="大碗拉面">
<meta name="twitter:description" content="不扯犊子 -NOT ALONE">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> 大碗拉面 </title>
</head>

<body itemscope itemtype="https://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="https://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="https://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?fd1a09a8302af22bf35f067279757d54";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="https://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">大碗拉面</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
      
        <li class="menu-item menu-item-search">
          <a href="#" class="st-search-show-outputs">
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'hXvPsMvt_RLywgyzUhtE','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">

    

    
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/09/01/es数据被黑事件记录和处理/" itemprop="url">
                  es数据被黑事件记录和处理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2020-09-01T18:44:00+08:00" content="2020-09-01">
              2020-09-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/工作日常/" itemprop="url" rel="index">
                    <span itemprop="name">工作日常</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/09/01/es数据被黑事件记录和处理/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/09/01/es数据被黑事件记录和处理/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h3><p><code>时间</code>: 2020年8月30日 4点10分</p>
<p>es中所有open的日志全被删掉，包括系统日志，只留下一个read_me</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"read_me"</span>: &#123;</div><div class="line">    <span class="string">"aliases"</span>: &#123;&#125;,</div><div class="line">    <span class="string">"mappings"</span>: &#123;</div><div class="line">      <span class="string">"_doc"</span>: &#123;</div><div class="line">        <span class="string">"properties"</span>: &#123;</div><div class="line">          <span class="string">"@timestamp"</span>: &#123;</div><div class="line">            <span class="string">"type"</span>: <span class="string">"date"</span></div><div class="line">          &#125;,</div><div class="line">          <span class="string">"message"</span>: &#123;</div><div class="line">            <span class="string">"type"</span>: <span class="string">"text"</span>,</div><div class="line">            <span class="string">"fields"</span>: &#123;</div><div class="line">              <span class="string">"keyword"</span>: &#123;</div><div class="line">                <span class="string">"type"</span>: <span class="string">"keyword"</span>,</div><div class="line">                <span class="string">"ignore_above"</span>: <span class="number">256</span></div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"settings"</span>: &#123;</div><div class="line">      <span class="string">"index"</span>: &#123;</div><div class="line">        <span class="string">"creation_date"</span>: <span class="string">"1598760619467"</span>,</div><div class="line">        <span class="string">"number_of_shards"</span>: <span class="string">"5"</span>,</div><div class="line">        <span class="string">"number_of_replicas"</span>: <span class="string">"1"</span>,</div><div class="line">        <span class="string">"uuid"</span>: <span class="string">"cL_kgJ_XQqe2lSgOrN4VUw"</span>,</div><div class="line">        <span class="string">"version"</span>: &#123;</div><div class="line">          <span class="string">"created"</span>: <span class="string">"6030299"</span></div><div class="line">        &#125;,</div><div class="line">        <span class="string">"provided_name"</span>: <span class="string">"read_me"</span></div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="string">"message"</span>: <span class="string">"SEND 0.015 BTC TO THIS WALLET: 1BJxnAYaaWNbQcL9o9GS768v3VqVMNDusD IF YOU WANT RECOVER YOUR DATABASE! SEND TO THIS EMAIL YOUR SERVER IP AFTER SENDING THE BITCOINS getbase@cock.li"</span></div></pre></td></tr></table></figure>
<p>网络i/o没有突增，所以数据并没有被移走，而是直接被删掉了</p>
<h4 id="影响"><a href="#影响" class="headerlink" title="影响"></a>影响</h4><p><code>数据丢失</code>：es所在云盘有快照备份，可以从28号早上五点的恢复，丢失数据即28，29号和30号一部分，周末基本无日志，所以主要<strong>损失28号当前的请求日志</strong></p>
<p><code>修复成本</code>: 导出30号之后的日志，然后回滚磁盘，操作简单但耗时较长，预计影响时间3小时，后期考虑是否更换云盘类型，提高备份和回滚速度</p>
<h3 id="漏洞查找"><a href="#漏洞查找" class="headerlink" title="漏洞查找"></a>漏洞查找</h3><ul>
<li>es没有密码保护</li>
</ul>
<p>操作es有三种个途径，一是ip直接访问，二是通过内网slb访问，三是使用kibana</p>
<p>这三者都在内网中<strong>需要ecs安全组访问白名单</strong>，检查不存在大范围的ip授权，除了阿里云自动添加的ip段较大（到24位），但平时<code>添加公司ip过期没有及时删除</code></p>
<p>检索slb中与发生时间相近的日志，条件过滤<code>request_method: DELETE</code>,查到了大量删除请求,再根据<code>http_user_agent: python-requests/2.18.4</code>为条件过滤得到了完整的攻击请求</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">08<span class="string">-28</span> 23:38:25</div><div class="line">client_ip:  195.54.161.252</div><div class="line">client_port:  60516</div><div class="line">http_host:   *.*.*.*:9200</div><div class="line">http_user_agent:  python-requests/2.18.4</div><div class="line">request_method:  HEAD</div><div class="line">request_uri:  /</div><div class="line">slb_vport:  9200</div><div class="line"><span class="keyword">time:</span>  2020<span class="string">-08</span><span class="string">-28</span>T23:38:25<span class="string">+08</span>:00</div><div class="line">upstream_addr:  *.*.*.*:32101</div><div class="line">vip_addr:   *.*.*.*</div><div class="line"></div><div class="line">08<span class="string">-28</span> 23:38:28</div><div class="line">client_ip:  195.54.161.252</div><div class="line">client_port:  39732</div><div class="line">http_host:  *.*.*.*:9200</div><div class="line">http_user_agent:  python-requests/2.18.4</div><div class="line">request_method:  GET</div><div class="line">request_uri:  /_all/</div><div class="line">slb_vport:  9200</div><div class="line"><span class="keyword">time:</span>  2020<span class="string">-08</span><span class="string">-30</span>T12:10:19<span class="string">+08</span>:00</div><div class="line">upstream_addr: *.*.*.*</div><div class="line">vip_addr:  *.*.*.*</div><div class="line"></div><div class="line">08<span class="string">-28</span> 23:38:36</div><div class="line">client_ip:  195.54.161.252</div><div class="line">client_port:  32844</div><div class="line">http_host:  *.*.*.*:9200</div><div class="line">http_user_agent:  python-requests/2.18.4</div><div class="line">request_method:  DELETE</div><div class="line">request_uri:  /log_saas_develop<span class="string">-2020</span>.07.21/</div><div class="line">slb_vport:  9200</div><div class="line"><span class="keyword">time:</span>  2020<span class="string">-08</span><span class="string">-28</span>T23:38:36<span class="string">+08</span>:00</div><div class="line">upstream_addr:  *.*.*.*:32101</div><div class="line">vip_addr:  *.*.*.*</div><div class="line"></div><div class="line">...</div></pre></td></tr></table></figure>
<p>一共发起了<strong>两次攻击</strong>，第一次发生在<code>08-28 23:38:25</code>,第二次是在<code>08-30 12:10:19</code></p>
<p><code>http_host</code>是一个公网ip，一开始在slb和ecs中都没查到，后来发现是我使用的阿里云子账号权限不够看不到EIP =_=||</p>
<p>漏洞: <strong>内网slb绑定了公网eip，没有访问控制，也没有改es默认端口</strong>,被暴利扫描的脚本发现</p>
<h3 id="问题处理"><a href="#问题处理" class="headerlink" title="问题处理"></a>问题处理</h3><p><code>出现问题的原因</code>: 原先es绑定的内网slb是单纯为es使用<strong>端口设为默认9200</strong>，方便内网中其他服务通过域名访问到es，后被<strong>合并到slb ops-k8s-cluster</strong>，但该slb是绑定在k8s上并<strong>提供了EIP给k8s的api server</strong>，导致es暴露到公网中，没有访问控制且未修改端口</p>
<p><code>处理方法</code>: <strong>增加访问控制</strong>，采用和ecs相同的方式刷白名单，<strong>不使用默认端口9200</strong></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>未被保护的资产暴露到公网被暴力扫描脚本攻击</p>
<h4 id="发现问题与自检"><a href="#发现问题与自检" class="headerlink" title="发现问题与自检"></a>发现问题与自检</h4><ol>
<li>暴露公网ip的服务（slb,ecs,rds）<strong>必须配置访问控制</strong></li>
<li>自建的公共服务（es,redis,gitlab,jenkins,spinnaker等）<strong>禁止使用默认端口</strong></li>
<li>自建服务<strong>只能通过域名访问</strong>，避免无访问记录</li>
<li>云盘快照备份中只备份工作日的配置不合理，原先是周一到周五，需改为周二到周六</li>
<li>定期更换服务密码</li>
</ol>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/08/27/分布式任务平台设计概要/" itemprop="url">
                  分布式任务平台设计概要
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2020-08-27T15:45:36+08:00" content="2020-08-27">
              2020-08-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/工作日常/" itemprop="url" rel="index">
                    <span itemprop="name">工作日常</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/08/27/分布式任务平台设计概要/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/08/27/分布式任务平台设计概要/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="任务"><a href="#任务" class="headerlink" title="任务"></a>任务</h3><h4 id="记录"><a href="#记录" class="headerlink" title="记录"></a>记录</h4><p>从mq获取任务，再记录到job表,记录的信息有 funcName，args，createUser，priority，serviceName</p>
<h4 id="读取"><a href="#读取" class="headerlink" title="读取"></a>读取</h4><p>从job表读取任务</p>
<p><code>限流</code>: 当待执行队列长度超<strong>missionQueueSize</strong>则等待<strong>readTimeDelayMillsWhenFlowControl</strong>后重新执行</p>
<p><code>限频</code>: 每隔<strong>readInterval</strong>读取任务</p>
<h4 id="执行"><a href="#执行" class="headerlink" title="执行"></a>执行</h4><p>从待执行队列中取出任务发送给worker</p>
<p><code>并发</code>：根据<strong>parallelConsumeLimit</strong>限制，同时发送任务</p>
<p>当无任务时等待<strong>get_new_mission</strong>事件触发</p>
<p>发送任务时不等待结果，然后修改job表中任务状态为<strong>E</strong></p>
<h4 id="完成"><a href="#完成" class="headerlink" title="完成"></a>完成</h4><p>监听etcd完成任务的信息写入</p>
<p>按执行结果修改job表中任务状态，从<strong>missionInProcessMap</strong>中删除该任务</p>
<h4 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h4><p>定期检查执行中的任务状态，主要是执行时间</p>
<p>对于执行<strong>missionOutT重试超过限制ime</strong>超时的任务重新加入任务队列，重试超次数<strong>retryTimes</strong>的任务则在job表中标记为<strong>F</strong>,失败原因为重试超过限制</p>
<h3 id="master"><a href="#master" class="headerlink" title="master"></a>master</h3><h4 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h4><p>将任务完成信息同步到etcd中<br>优势：</p>
<ol>
<li>主动通知任务完成，实现方便，无需master等待完成结果</li>
<li>避免进度丢失，单点问题</li>
</ol>
<h5 id="master选举"><a href="#master选举" class="headerlink" title="master选举"></a>master选举</h5><p>key为/mif/schedule/leader,当版本为0时创建并设置ttl,其他scheduler监听该key，当失效时重新选举</p>
<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p>service/job/init</p>
<ol>
<li>读取etcd中已存在的任务（已完成master未处理）</li>
<li>从job表载入正在执行的任务，加入missionInProcessMap</li>
<li>启动监听etcd任务完成put事件</li>
<li>执行<a href="#检查">任务检查</a></li>
<li>执行<a href="#完成">任务完成</a></li>
<li>开始循环读取任务,检查任务,执行任务</li>
</ol>
<h4 id="发送任务"><a href="#发送任务" class="headerlink" title="发送任务"></a>发送任务</h4><p>通过http post触发部署在函数计算中的worker</p>
<ul>
<li>fc判断服务启动完成存在问题，在启动未完成时接受请求返回502</li>
</ul>
<p>当请求返回此错误时，采取重试</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (response.data.errorMessage.indexOf(<span class="string">'Process exited unexpectedly before completing request'</span>) !== <span class="number">-1</span>) &#123;</div><div class="line">  <span class="keyword">const</span> &#123; missionId, serviceName, funcName, args &#125; = data;</div><div class="line">  app.logger.error(error);</div><div class="line">  <span class="keyword">return</span> app.send(missionId, serviceName, funcName, args);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="worker"><a href="#worker" class="headerlink" title="worker"></a>worker</h3><p>部署在函数计算，节省资源，方便扩容，无需健康检查</p>
<p>接收任务与rpc处理逻辑类似不再重复</p>
<h4 id="中间件finishMission"><a href="#中间件finishMission" class="headerlink" title="中间件finishMission"></a>中间件finishMission</h4><p>待执行完成后向etcd插入结果</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">await</span> next();</div><div class="line"><span class="keyword">if</span> (!ctx.missionId) <span class="keyword">return</span>;</div><div class="line"><span class="keyword">await</span> ctx.app.etcdMission.put(<span class="string">'finish/'</span> + ctx.missionId).value(<span class="built_in">JSON</span>.stringify(&#123;</div><div class="line">  <span class="attr">missionId</span>: ctx.missionId,</div><div class="line">  <span class="attr">time</span>: <span class="built_in">Date</span>.now(),</div><div class="line">  <span class="attr">status</span>: <span class="string">'S'</span>,</div><div class="line">&#125;));</div></pre></td></tr></table></figure>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/08/19/SaaS工程编译/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2020-08-19T17:59:31+08:00" content="2020-08-19">
              2020-08-19
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/08/19/SaaS工程编译/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/08/19/SaaS工程编译/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="SaaS工程编译"><a href="#SaaS工程编译" class="headerlink" title="SaaS工程编译"></a>SaaS工程编译</h2><h3 id="webpack配置"><a href="#webpack配置" class="headerlink" title="webpack配置"></a>webpack配置</h3><ul>
<li>将工程打包到一个文件中</li>
</ul>
<p>工程中使用<code>app-module-path</code>设置src为根路径，所以在打包时需要对src做替换</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="attr">entry</span>: <span class="string">'./index.js'</span>,</div><div class="line">  <span class="attr">target</span>: <span class="string">'node'</span>,</div><div class="line">  <span class="attr">output</span>: &#123;</div><div class="line">    <span class="attr">filename</span>: <span class="string">'bundle.js'</span>,</div><div class="line">    <span class="attr">path</span>: __dirname</div><div class="line">  &#125;,</div><div class="line">  <span class="comment">// devtool: 'inline-source-map',</span></div><div class="line">  externals: _externals(),</div><div class="line">  <span class="attr">resolve</span>:&#123;</div><div class="line">    <span class="attr">alias</span>: &#123;</div><div class="line">      <span class="attr">config</span>: path.resolve(__dirname, <span class="string">'config.js'</span>),</div><div class="line">      <span class="string">'src'</span>: path.resolve(__dirname, <span class="string">'./src'</span>),</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">_externals</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">let</span> manifest = <span class="built_in">require</span>(<span class="string">'./package.json'</span>);</div><div class="line">  <span class="keyword">let</span> dependencies = manifest.dependencies;</div><div class="line">  <span class="keyword">let</span> externals = &#123;&#125;;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> p <span class="keyword">in</span> dependencies) &#123;</div><div class="line">    externals[p] = <span class="string">'commonjs '</span> + p;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> externals;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="动态引用转为静态引用脚本"><a href="#动态引用转为静态引用脚本" class="headerlink" title="动态引用转为静态引用脚本"></a>动态引用转为静态引用脚本</h3><p>工程通过读取目标来实现动态引用，只在执行时触发，导致两个问题：</p>
<ol>
<li>动态路径无法被webpack打包</li>
<li>转成静态引用后出现循环调用问题</li>
</ol>
<h4 id="生成静态引用脚本"><a href="#生成静态引用脚本" class="headerlink" title="生成静态引用脚本"></a>生成静态引用脚本</h4><p>生成对应目录</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> dir = dirname(__dirname)+<span class="string">'/src/routes'</span>;</div><div class="line"></div><div class="line"><span class="keyword">let</span> requireString=<span class="string">`'use strict';</span></div><div class="line"></div><div class="line">`</div><div class="line"></div><div class="line">fs.readdirSync(dir).filter(<span class="function"><span class="keyword">function</span> (<span class="params">file</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> (file.indexOf(<span class="string">'.'</span>) !== <span class="number">0</span>) &amp;&amp; (file !== <span class="string">'index.js'</span>) &amp;&amp; (file.slice(<span class="number">-3</span>) === <span class="string">'.js'</span>);</div><div class="line">  &#125;)</div><div class="line">  .forEach(<span class="function"><span class="keyword">function</span> (<span class="params">file</span>) </span>&#123;</div><div class="line">    requireString += <span class="string">`require('./<span class="subst">$&#123;basename(file)&#125;</span>');\n`</span></div><div class="line">  &#125;);</div><div class="line"></div><div class="line">fs.writeFileSync(dir+<span class="string">'/index.js'</span>,requireString)</div></pre></td></tr></table></figure>
<h4 id="循环调用"><a href="#循环调用" class="headerlink" title="循环调用"></a>循环调用</h4><p>工程service文件夹内部有相互调用，但直接引用index.js文件，转成静态引用后出现循环调用导致报错</p>
<p>通过Proxy来处理循环引用，原理是在init时只给个proxy对象，在正真调用时返回require对应的文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="keyword">new</span> <span class="built_in">Proxy</span>(&#123;&#125;, &#123;</div><div class="line">  <span class="attr">get</span>: <span class="function">(<span class="params">target, value</span>) =&gt;</span> &#123;</div><div class="line">  	<span class="comment">// 有些地方在init时就要获取具体的service (like, &#123;foo&#125; = service),所以需要多返回一层Proxy</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Proxy</span>(&#123;</div><div class="line">      <span class="attr">service</span>: value</div><div class="line">    &#125;, &#123;</div><div class="line">      <span class="attr">get</span>: <span class="function">(<span class="params">target, value</span>) =&gt;</span> &#123;</div><div class="line">        <span class="keyword">return</span> requireObj[target.service][value]</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h3 id="env文件处理"><a href="#env文件处理" class="headerlink" title=".env文件处理"></a>.env文件处理</h3><p>增加另外的启动文件run.js,加.env加到环境变量中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="built_in">require</span>(<span class="string">'dotenv'</span>).config(&#123;<span class="attr">path</span>:__dirname+<span class="string">'/.env'</span>&#125;)</div><div class="line"></div><div class="line">process.env.APP_HOME = __dirname;</div><div class="line">process.env.pkg = <span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="built_in">require</span>(<span class="string">'./bundle.js'</span>);</div></pre></td></tr></table></figure>
<h3 id="pkg编译"><a href="#pkg编译" class="headerlink" title="pkg编译"></a>pkg编译</h3><p>将<strong>run.js</strong>设为编译入口，再引入.env和grpc.proto，node_modules也会打包编译进去</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// package.json</span></div><div class="line">  </div><div class="line">  <span class="string">"bin"</span>: <span class="string">"run.js"</span>,</div><div class="line">  <span class="string">"pkg"</span>:&#123;</div><div class="line">    <span class="string">"assets"</span>: [<span class="string">".env"</span>,<span class="string">"grpc.proto"</span>]</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>最后生成saas的执行文件</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/07/18/分布式事务/" itemprop="url">
                  分布式事务
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2020-07-18T17:48:49+08:00" content="2020-07-18">
              2020-07-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/07/18/分布式事务/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/07/18/分布式事务/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>分布式事务是指是指事务的发起者、参与者、数据资源服务器以及事务管理器分别位于分布式系统的不同节点之上<br>参与者通过网络通信来达到分布式一致性，网络通信不可避免出现失败、超时的情况</p>
<h3 id="XA-Specification"><a href="#XA-Specification" class="headerlink" title="XA Specification"></a>XA Specification</h3><p>基于资源层的底层分布式事务解决方案，对业务的入侵度较低</p>
<p>有些数据分片框架或者中间件也支持XA协议，兼容性、普遍性好 但<strong>并发性能比较差</strong>， 基于XA的分布式事务如果要严格保证ACID，实际需要事务隔离级别为<strong>SERLALIZABLE</strong></p>
<h3 id="基于消息的分布式事务"><a href="#基于消息的分布式事务" class="headerlink" title="基于消息的分布式事务"></a>基于消息的分布式事务</h3><p>通过消息系统来通知其他事务参与方自己事务的执行状态，有效的将事务参与方解耦，各个参与方可以异步执行</p>
<p><code>难点</code>: 解决本地事务执行和消息发送的一致性：两者要同时执行成功或者同时取消执行</p>
<p><code>场景</code>: 原则上只接受下游分支事务的成功，不接受事务的回滚，如果失败就要一直重试，适用于对最终一致性敏感度较低的业务场景</p>
<p>可能会因为接收方的消息堆积导致长时间的数据不一致</p>
<h4 id="基于事务消息"><a href="#基于事务消息" class="headerlink" title="基于事务消息"></a>基于事务消息</h4><p>事务消息发送成功后，处于 prepared 状态，不能被订阅者消费，等到事务消息的状态更改为可消费状态后，下游订阅者才可以监听到次消息。支持事务消息的 MQ 系统有一个定时扫描逻辑，扫描出状态仍然是“待发送”状态的消息，并向消息的发送方发起询问，询问这条事务消息的最终状态如何并根据结果更新事务消息的状态。</p>
<p>提供事务消息状态查询接口</p>
<h4 id="基于本地消息"><a href="#基于本地消息" class="headerlink" title="基于本地消息"></a>基于本地消息</h4><p>如果<strong>所依赖的 MQ 系统不支持事务消息</strong>，那么可以采用本地消息的分布式模式</p>
<p>事务的发起方维护一个本地消息表，业务执行和本地消息表的执行处在同一个本地事务中。业务执行成功，则同时记录一条“待发送”状态的消息到本地消息表中。系统中启动一个定时任务定时扫描本地消息表中状态为“待发送”的记录，并将其发送到 MQ 系统中，如果发送失败或者超时，则一直发送，知道发送成功后，从本地消息表中删除该记录</p>
<h4 id="最大努力通知型分布式事务"><a href="#最大努力通知型分布式事务" class="headerlink" title="最大努力通知型分布式事务"></a>最大努力通知型分布式事务</h4><p>基于 MQ 系统的一种解决方案，但是不要求 MQ 消息可靠（如支付宝支付成功通知），通过引入定期校验机制来对最终一致性做兜底，对业务侵入性较低、对 MQ 系统要求较低，实现比较简单，适合于对最终一致性敏感度比较低、业务链路较短的场景，比如跨平台、跨企业的系统间的业务交互</p>
<h3 id="基于补偿的事务"><a href="#基于补偿的事务" class="headerlink" title="基于补偿的事务"></a>基于补偿的事务</h3><p>事务补偿机制 ： 在事务链中的任何一个正向事务操作，都必须存在一个完全符合回滚规则的可逆事务</p>
<h4 id="TCC"><a href="#TCC" class="headerlink" title="TCC"></a>TCC</h4><p>将资源层的二阶段提交协议转换到业务层，成为业务模型中的一部分,核心思想是通过对资源的预留，尽早释放对资源的加锁，如果事务可以提交，则完成对预留资源的确认，如果事务要回滚，则释放预留的资源</p>
<p>业务设计和代码都会变复杂（需要业务方把功能的实现上由一个接口拆分为三个），但性能、隔离性都很好 </p>
<p>业务方在设计实现上要遵循三个策略（网络中的通信失败或超时）</p>
<ol>
<li>允许空回滚：try 失败或者没有执行 try 操作的参与方收到 cancel 请求时，要进行空回滚操作</li>
<li>保持幂等性：重复调用参与方的 confirm/cancel 方法，因此需要这两个方法实现上保证幂等性</li>
<li>防止资源悬挂：参与方侧 try 请求比 cancel 请求更晚到达的情况，cancel 会执行空回滚而确保事务的正确性，但是此时 try 方法也不可以再被执行</li>
</ol>
<p>支持 TCC 事务的开源框架有：ByteTCC、Himly、TCC-transaction。</p>
<h4 id="Saga模式"><a href="#Saga模式" class="headerlink" title="Saga模式"></a>Saga模式</h4><p>Saga 和 TCC 一样，也是一种补偿事务，但是它没有 try 阶段，而是把分布式事务看作一组本地事务构成的事务链</p>
<p>事务链中的<strong>每一个正向事务操作，都对应一个可逆的事务操作</strong>。Saga 事务协调器负责按照<strong>顺序执行事务链中的分支事务</strong>，分支事务执行完毕，即释放资源。如果某个分支事务失败了，则按照反方向执行事务补偿操作。<strong>如果补偿失败了，就一直重试，补偿操作可以优化为并行执行</strong></p>
<p><strong>不保证事务隔离性</strong>，本地事务提交后变更就对其他事务可见了。其他事务如果更改了已经提交成功的数据，可能会导致补偿操作失败。比如扣款失败，但是钱已经花掉了，<strong>业务设计上需要考虑这种场景并从业务设计上规避这种问题</strong></p>
<p><strong>不完美补偿</strong>，补偿操作会留下之前原始事务操作的痕迹，需要考虑对业务上的影响</p>
<p>要求业务设计实现上遵循三个策略：</p>
<ol>
<li>允许空补偿：网络异常导致事务的参与方只收到了补偿操作指令，因为没有执行过正常操作，因此要进行空补偿</li>
<li>保持幂等性：事务的正向操作和补偿操作都可能被重复触发，因此要保证操作的幂等性</li>
<li>防止资源悬挂：网络异常导致事务的正向操作指令晚于补偿操作指令到达，则要丢弃本次正常操作，否则会出现资源悬挂问题</li>
</ol>
<p><strong>适合于业务流程长的长事务的场景，实现上对业务侵入低，所以非常适合微服务架构的场景</strong>。同时 Saga 采用的是一阶段提交模式，不会对资源长时间加锁，不存在“木桶效应”，所以采用这种模式架构的<strong>系统性能高、吞吐高</strong></p>
<h3 id="阿里云分布式事务相关工具"><a href="#阿里云分布式事务相关工具" class="headerlink" title="阿里云分布式事务相关工具"></a>阿里云分布式事务相关工具</h3><p>DRDS 基于MySQL的XA实现，使用方便，但并发性能低 </p>
<p>GTS 全局事务服务 就提了个本地事务和mq能在一起提交</p>
<h4 id="seata"><a href="#seata" class="headerlink" title="seata"></a>seata</h4><p>通过全局锁实现了写隔离与读隔离</p>
<ul>
<li>一阶段本地事务提交前，需要确保先拿到 全局锁</li>
<li>拿不到 全局锁 ，不能提交本地事务。</li>
<li>拿 全局锁 的尝试被限制在一定范围内，超出范围将放弃，并回滚本地事务，释放本地锁</li>
</ul>
<p>开启本地事务，拿到本地锁，更新操作，本地事务提交前，先拿到该记录的 全局锁 ，本地提交释放本地锁。第二阶段提交释放 全局锁 </p>
<p>全局锁相当于写锁，但比由数据库实现性能好一些，<br>Seata（AT 模式）的<strong>默认全局隔离级别是 读未提交，会出现脏读，要拿读已提交需要全局锁</strong>，可以按业务做调整，但性能会好一些。全局锁会额外增加死锁的风险，但如果出现死锁，会不断进行重试，最后靠等待全局锁超时 </p>
<p>性能比XA好一点，第一阶段的提交会释放本地锁，但还存在全局锁，会阻塞写，但不影响默认的读未提交<br>XA的prepare是数据库实现的锁，而且要求事务串行执行</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/05/30/削足适履(Ten Pounds in a Five-Pound Sack)/" itemprop="url">
                  削足适履(Ten Pounds in a Five-Pound Sack)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2020-05-30T15:11:10+08:00" content="2020-05-30">
              2020-05-30
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/人月神话/" itemprop="url" rel="index">
                    <span itemprop="name">人月神话</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/05/30/削足适履(Ten Pounds in a Five-Pound Sack)/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/05/30/削足适履(Ten Pounds in a Five-Pound Sack)/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="规模控制"><a href="#规模控制" class="headerlink" title="规模控制"></a>规模控制</h3><ul>
<li>规模控制既是技术工作的一部分，也是管理工作的一部分</li>
</ul>
<p>把系统划分成若干部分，并设定每个部分的规模目标，对规模-速度权衡的各种情况有深刻的了解，并预留一些空间</p>
<p><code>制订总体规模的预算</code>：仅对核心程序设定规模目标是不够的，必须把所有的方面都编入预算</p>
<p><code>明确模块的功能</code>： 避免相互推脱</p>
<p><code>确保系统完整性、易用性</code>：培养开发人员从<strong>系统整体出发、面向用户的态度</strong>是软件编程管理人员最重要的职能，加强成员相关的沟通，避免每个人都只在局部优化自己的程序</p>
<h3 id="空间技能"><a href="#空间技能" class="headerlink" title="空间技能"></a>空间技能</h3><p>更多的功能意味着需要更多的空间</p>
<p>可以设计成拥有若干选项 分组，根据选项组来剪裁程序，但也要确定用户可选项目的粗细程度（实现成本）</p>
<p>培训：快速的学习和经验的广泛共享<br>公共组件：运行速度较快和短小精炼的，与系统设计工作并行进行</p>
<h3 id="数据的表现形式是编程的根本"><a href="#数据的表现形式是编程的根本" class="headerlink" title="数据的表现形式是编程的根本"></a>数据的表现形式是编程的根本</h3><p><strong>战略上突破常来自数据或表的重新表达</strong>（授权数据的重新设计）</p>
<p>回顾、 分析实际情况，仔细思考程序的数据</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/05/08/mq包更换/" itemprop="url">
                  mq包更换
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2020-05-08T13:48:49+08:00" content="2020-05-08">
              2020-05-08
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/工作日常/" itemprop="url" rel="index">
                    <span itemprop="name">工作日常</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/05/08/mq包更换/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/05/08/mq包更换/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><ol>
<li>封装http版本的包，现有的js tcp版包已不再更新，有兼容问题</li>
</ol>
<h3 id="设计点记录"><a href="#设计点记录" class="headerlink" title="设计点记录"></a>设计点记录</h3>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/05/08/rpc包更换/" itemprop="url">
                  rpc包更换
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2020-05-08T13:48:49+08:00" content="2020-05-08">
              2020-05-08
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/工作日常/" itemprop="url" rel="index">
                    <span itemprop="name">工作日常</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/05/08/rpc包更换/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/05/08/rpc包更换/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><ol>
<li>精简rpc包，剔除mq功能</li>
<li>使用egg agent,支持多worker启动（支持多worker意义不大，egg 3.0的milestone对docker的singleprocess会做优化，到时候再根据情况做调整）</li>
<li>提供尽量方便的配置性，支持开发自定义proto文件的同时不需要格外增加代码（屏蔽掉内部实现）</li>
</ol>
<h3 id="设计点记录"><a href="#设计点记录" class="headerlink" title="设计点记录"></a>设计点记录</h3><h4 id="client"><a href="#client" class="headerlink" title="client"></a>client</h4><ul>
<li>call</li>
</ul>
<p>连接断开: 连接断开后直接抛错，删掉记录的client，等待下次调用再发起连接,<strong>因为只有调用时才能执行建立连接</strong>,直接用调用方法重试容易出现死循环</p>
<p>报错: 通过判断response.body.code&lt;0,创建error,reject error</p>
<ul>
<li>stream</li>
</ul>
<p>连接断开: 连接断开后重试连接，通过监听error事件重试</p>
<h4 id="server"><a href="#server" class="headerlink" title="server"></a>server</h4><p>启动失败: 设计只支持发生在申请端口时，直接reject error</p>
<p>保存连接对应的client</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> <span class="built_in">key</span> = svcName + funcName + that._getRid();</div><div class="line"></div><div class="line">that.callHandle.<span class="built_in">set</span>(<span class="built_in">key</span>,client)</div></pre></td></tr></table></figure>
<p>触发rpcData时带上key</p>
<p>设置传输包大小</p>
<h3 id="改动范围"><a href="#改动范围" class="headerlink" title="改动范围"></a>改动范围</h3><h4 id="fx-rpc"><a href="#fx-rpc" class="headerlink" title="fx-rpc"></a>fx-rpc</h4><p>启动rpc服务,处理client发送的请求，调用本地方法</p>
<h5 id="传输格式"><a href="#传输格式" class="headerlink" title="传输格式"></a>传输格式</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">syntax = &quot;proto3&quot;;</div><div class="line"></div><div class="line">package fgrid;</div><div class="line"></div><div class="line">service Call &#123;</div><div class="line">  rpc Call (body) returns (body) &#123;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">message body &#123;</div><div class="line">  string body = 1;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="middle"><a href="#middle" class="headerlink" title="middle"></a>middle</h4><p>client发送rpc请求，格式参考部分JSON-RPC</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attribute">method</span>: targetArgs.<span class="built_in">join</span>(<span class="string">'.'</span>),</div><div class="line">  param: [ ...args, ctx.rpcCtx ],</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/04/29/授权重构及微服务开发问题总结/" itemprop="url">
                  授权重构及微服务开发问题总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2020-04-29T16:38:37+08:00" content="2020-04-29">
              2020-04-29
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/工作日常/" itemprop="url" rel="index">
                    <span itemprop="name">工作日常</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/04/29/授权重构及微服务开发问题总结/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/04/29/授权重构及微服务开发问题总结/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="项目回顾"><a href="#项目回顾" class="headerlink" title="项目回顾"></a>项目回顾</h3><h4 id="重构目的"><a href="#重构目的" class="headerlink" title="重构目的"></a>重构目的</h4><p>优化授权数据的存储方式，避免原先冗长的缓存计算</p>
<h4 id="成果"><a href="#成果" class="headerlink" title="成果"></a>成果</h4><p>无需再做定时的缓存刷新，据实施和客户反馈操作授权速度和流程度比原先有大幅提升</p>
<h4 id="槽点和败笔"><a href="#槽点和败笔" class="headerlink" title="槽点和败笔"></a>槽点和败笔</h4><ol>
<li>从目的出发业务基本无改动，完全搬运原先代码,也因此出现了一些纰漏</li>
<li>过度设计，ra-backend无意义的透传，首先侧重代码的清晰、可读性，再考虑其他规范，避免形式主义</li>
<li>缺少自测手段,过度依赖测试团队,效率很低</li>
<li>前期在基础组件花费时间过长，缺乏进度管控,后期赶工,代码质量缺少保障</li>
<li>// 沟通问题</li>
</ol>
<h3 id="开发体感"><a href="#开发体感" class="headerlink" title="开发体感"></a>开发体感</h3><h4 id="业务代码"><a href="#业务代码" class="headerlink" title="业务代码"></a>业务代码</h4><ol>
<li>修改依赖授权数据的项目非常痛苦,要去了解原先的业务场景和数据格式后再设计接口，在后期测试时，这块花费了很大时间，出了bug难以排查</li>
<li>原先项目参数定义比较奇怪，使用-1表示否定，mongo支持undefined为查询条件</li>
</ol>
<h4 id="基础组件"><a href="#基础组件" class="headerlink" title="基础组件"></a>基础组件</h4><ol>
<li>缺少服务地址组件： 本地开发启动多服务联调比较麻烦，连接线上服务也需要不断修改配置文件</li>
<li>log插件：线上报错信息不完整，没有显示具体的调用信息</li>
</ol>
<h3 id="工程化"><a href="#工程化" class="headerlink" title="工程化"></a>工程化</h3><h4 id="解耦"><a href="#解耦" class="headerlink" title="解耦"></a>解耦</h4><ol>
<li>服务拆分颗粒度 要与公司业务发展趋势相契合，不能生搬硬套教程，做适当整合(基础信息类)</li>
<li>避免类似ra-backend只做透传的项目</li>
<li>传入参数的校验，存在将前端传入参数直接透传查询的情况，需要加以验证和鉴权</li>
</ol>
<h4 id="模块化"><a href="#模块化" class="headerlink" title="模块化"></a>模块化</h4><ol>
<li>因为docker构建缓存，私有包不自动更新,增加Jenkins配置或者写明使用包版本</li>
<li>私有包版本管理，不兼容问题</li>
</ol>
<h4 id="质量保证"><a href="#质量保证" class="headerlink" title="质量保证"></a>质量保证</h4><ol>
<li>最小单元测试 确保不出现语法错误(await、拼写)</li>
<li>健康检查，考虑开放http来提供健康检查，通过fx-rpc插件实现再调用rpc来自检</li>
</ol>
<h4 id="代码风格"><a href="#代码风格" class="headerlink" title="代码风格"></a>代码风格</h4><ol>
<li>下划线转驼峰</li>
<li>单文件代码行数,按controller映射service容易出现代码行数过大 需要做适当拆解</li>
</ol>
<h4 id="临时发布环境搭建"><a href="#临时发布环境搭建" class="headerlink" title="临时发布环境搭建"></a>临时发布环境搭建</h4><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><h4 id="测试准备"><a href="#测试准备" class="headerlink" title="测试准备"></a>测试准备</h4><ol>
<li>撤下老的项目，防止再被调用</li>
</ol>
<h4 id="自测能力"><a href="#自测能力" class="headerlink" title="自测能力"></a>自测能力</h4><p>对复杂业务场景的自测能力</p>
<h3 id="沟通"><a href="#沟通" class="headerlink" title="沟通"></a>沟通</h3><h4 id="团队会议"><a href="#团队会议" class="headerlink" title="团队会议"></a>团队会议</h4><ol>
<li>回顾本周进度，指定下周计划，预防延期或及时做进度调整</li>
<li>对于有争议的问题由tl做决策避免拖延</li>
<li>确定责任边界，避免扯皮;回顾、调整目标，确保团队整体方向正确（避免无用功，有争议时从目标出发）</li>
<li>做好会议记录（记录决策）发给与会者</li>
</ol>
<h3 id="下阶段计划"><a href="#下阶段计划" class="headerlink" title="下阶段计划"></a>下阶段计划</h3><h4 id="rpc包更换"><a href="#rpc包更换" class="headerlink" title="rpc包更换"></a>rpc包更换</h4><ol>
<li>精简rpc包，剔除mq功能</li>
<li>使用egg agent,支持多worker启动</li>
</ol>
<h4 id="mq包更换"><a href="#mq包更换" class="headerlink" title="mq包更换"></a>mq包更换</h4><ol>
<li>封装http版本的包</li>
<li>避免一个业务动作批量发送mq的场景（类似多段的分布式事务） 需要由业务侧做拆分</li>
</ol>
<h4 id="log"><a href="#log" class="headerlink" title="log"></a>log</h4><ol>
<li>错误日志输出适配rpc，打印调用参数和traceId</li>
</ol>
<h4 id="减少rpc传输字段"><a href="#减少rpc传输字段" class="headerlink" title="减少rpc传输字段"></a>减少rpc传输字段</h4><ol>
<li>禁用select * ,自协调参数输出</li>
</ol>
<h4 id="服务地址组件"><a href="#服务地址组件" class="headerlink" title="服务地址组件"></a>服务地址组件</h4><ol>
<li>暂定在本地开发使用，线上运行不依赖它</li>
<li>通过简单的声明即可获取服务地址，包括测试、预发、生产</li>
</ol>
<h3 id="技巧分享"><a href="#技巧分享" class="headerlink" title="技巧分享"></a>技巧分享</h3><p>在node中实现高效缓存<br><a href="http://wmtcore.com/2020/04/23/%E9%AB%98%E6%95%88%E7%BC%93%E5%AD%98%E7%9A%84%E4%BD%BF%E7%94%A8/" target="_blank" rel="external">http://wmtcore.com/2020/04/23/%E9%AB%98%E6%95%88%E7%BC%93%E5%AD%98%E7%9A%84%E4%BD%BF%E7%94%A8/</a></p>
<p>反向授权性能优化<br><a href="http://wmtcore.com/2020/03/20/%E5%8F%8D%E5%90%91%E6%8E%88%E6%9D%83%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" target="_blank" rel="external">http://wmtcore.com/2020/03/20/%E5%8F%8D%E5%90%91%E6%8E%88%E6%9D%83%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/04/23/高效缓存的使用/" itemprop="url">
                  在node中实现高效缓存
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2020-04-23T16:10:21+08:00" content="2020-04-23">
              2020-04-23
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index">
                    <span itemprop="name">nodejs</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/04/23/高效缓存的使用/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/04/23/高效缓存的使用/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p><code>使用场景</code>: 对于量级小，常用的基础数据做内存缓存，提高运算速度</p>
<p><code>getRegionCache</code>方法不仅对外输出，同时内部计算也会使用，为了保证高效，需要隐性异步，不能直接声明async</p>
<h3 id="初始化缓存"><a href="#初始化缓存" class="headerlink" title="初始化缓存"></a>初始化缓存</h3><p>返回Promise 同步等待</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRegionCache</span>(<span class="params">key</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (!cache) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</div><div class="line">      reflashCache().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">        resolve(cache.get(key))</div><div class="line">      &#125;);</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用者拿到的是Promise对象，直接await即可</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">async</span> getRegionCacheAPI(key) &#123;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">await</span> getRegionCache(key)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="缓存异步刷新"><a href="#缓存异步刷新" class="headerlink" title="缓存异步刷新"></a>缓存异步刷新</h3><ul>
<li>对于这类基础数据的缓存，低实时性，通过自维护方式失效，类似LRU的实现</li>
</ul>
<p>缓存到失效时间后通过<code>process.nextTick</code>放入微任务队列异步刷新, 同步计算先拿旧数据继续执行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRegionCache</span>(<span class="params">key</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (overTime) &#123;</div><div class="line">    process.nextTick(<span class="function"><span class="params">()</span> =&gt;</span> reflashCache());</div><div class="line">    updateCacheTime = <span class="built_in">Date</span>.now();</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> cache.get(key);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h3><ul>
<li>在缓存初始化和失效时，大量并发请求同时触发缓存刷新，严重影响数据库性能</li>
</ul>
<p>通过设置once事件监听缓存刷新完成,待缓存刷新结束后，依次返回结果，避免并发刷新缓存</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> <span class="keyword">event</span> = <span class="keyword">new</span> events.EventEmitter();</div><div class="line"><span class="keyword">event</span>.setMaxListeners(<span class="number">100</span>); <span class="comment">//注意设置监听者数量，超过数量会触发leak memory告警</span></div><div class="line"></div><div class="line"><span class="keyword">await</span> reflashCache() &#123;</div><div class="line">  <span class="keyword">await</span> <span class="keyword">new</span> Promise(<span class="keyword">async</span> resolve =&gt; &#123;</div><div class="line">    <span class="keyword">event</span>.once(<span class="string">'finish'</span>, resolve);</div><div class="line">    <span class="keyword">if</span> (eventStatus === <span class="string">'ready'</span>) &#123;</div><div class="line">      eventStatus = <span class="string">'pending'</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">event</span>.emit(<span class="string">'finish'</span>);</div><div class="line">      eventStatus = <span class="string">'ready'</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通过将数据库查询任务放入异步队列，避免了运算时同步等待，体现出node的性能优势</p>
<p>利用事件监听能力，很方便就能处理缓存击穿的问题</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/04/04/胸有成竹(Calling the Shot)/" itemprop="url">
                  未雨绸缪(Plan to Throw One Away)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2020-04-04T14:40:30+08:00" content="2020-04-04">
              2020-04-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/人月神话/" itemprop="url" rel="index">
                    <span itemprop="name">人月神话</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/04/04/胸有成竹(Calling the Shot)/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/04/04/胸有成竹(Calling the Shot)/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>不变只是愿望，变化才是永恒</p>
<h3 id="试验性工厂和增大规模"><a href="#试验性工厂和增大规模" class="headerlink" title="试验性工厂和增大规模"></a>试验性工厂和增大规模</h3><p>开发使用的环境由于规模、量级的限制，导致第一版开发的软件在真实环境运行时易出现各种问题,需要在测试中不断增大规模、模拟真实环境</p>
<p>把第一版开发的产品发布给顾客，可以获得时间，但是对于用户，使用极度痛苦;对于重新开发的人员，分散了精力;对于产品，影响了声誉，即使最好的再设计也难以挽回名声</p>
<h3 id="唯一不变的就是变化本身"><a href="#唯一不变的就是变化本身" class="headerlink" title="唯一不变的就是变化本身"></a>唯一不变的就是变化本身</h3><p>新的系统概念或新技术会不断出现，所以老版的系统必须被抛弃，但即使是最优秀的项目经理，也不能在最开始解决这些问题</p>
<ul>
<li><strong>开发人员交付的是用户满意程度，而不仅仅是实际的产品</strong></li>
<li>用户的实际需要和用户感觉会随着程序使用而变化</li>
</ul>
<p>目标上的变化不可避免，而且设计策略和技术上的变化也不可避免，随着学习的过程更改设计</p>
<h3 id="前进两步，后退一步"><a href="#前进两步，后退一步" class="headerlink" title="前进两步，后退一步"></a>前进两步，后退一步</h3><p>对于一个广泛使用的程序，其维护总成本通常是开发成本的 40%或更多，该成本受用户数目的严重影响。<strong>用户越多，所发现的错误也越多</strong></p>
<p><img src="/picture/未雨绸缪.jpg" alt="Resize icon"></p>
<ul>
<li>缺陷修复总会以(20-50)%的机率引入新的bug </li>
</ul>
<p>原因:</p>
<ol>
<li>看似很轻微的错误，实际却是系统级别的问题，如果没有非常详细的文档，是很难被发现</li>
<li>维护人员常常不是编写代码的开发人员，而是一些初级程序员或者新手</li>
</ol>
<p>成本: 在每次修复之后，必须重新运行先前所有的测试用例，从而确保系统不会以更隐蔽的方式被破坏</p>
<p><strong>设计实现的人员越少、接口越少，产生的错误也就越少</strong> 微服务</p>
<h3 id="前进一步，后退一步"><a href="#前进一步，后退一步" class="headerlink" title="前进一步，后退一步"></a>前进一步，后退一步</h3><ul>
<li>维护越多系统越混乱，所有修改都倾向于破坏系统的架构，增加了系统的混乱程度</li>
<li>用在修复原有设计上瑕疵的工作量越来越少，而早期维护造成的漏洞所引起修复工作越来越多</li>
</ul>
<p><strong>系统软件开发是减少混乱度(减少熵)的过程，所以它本身是处于亚稳态的。软件维护是提高混乱度(增加熵)的过程，即使是最熟练的软件维护工作，也只是放缓了系统退化到非稳态的进程</strong></p>
<p>机器在变化，配置在变化，用户的需求在变化，所以现实系统不可能永远可用。<strong>基于原有系统的重新设计是完全必要的</strong></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="https://schema.org/Person">
          <img class="site-author-image" src="http://wmtcore.com/uploads/avatar.png" alt="WMT" itemprop="image"/>
          <p class="site-author-name" itemprop="name">WMT</p>
        </div>
        <p class="site-description motion-element" itemprop="description">不扯犊子 -NOT ALONE</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">80</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">19</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">23</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/WMTcore" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015-12 - 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WMT</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"wmtcore"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     
     
  	  <script type="text/javascript">
  		var duoshuo_user_ID = 6224283662221837000
      var duoshuo_admin_nickname="作者"
  	  </script>
     
  	<script src="/js/ua-parser.min.js"></script>
  	<script src="/js/hook-duoshuo.js"></script>
  


    
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  

  
  

</body>
</html>
