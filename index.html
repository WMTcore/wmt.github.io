<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="WMTcore" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="不扯犊子 -NOT ALONE">
<meta property="og:type" content="website">
<meta property="og:title" content="大碗拉面">
<meta property="og:url" content="http://www.wmtcore.com/index.html">
<meta property="og:site_name" content="大碗拉面">
<meta property="og:description" content="不扯犊子 -NOT ALONE">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="大碗拉面">
<meta name="twitter:description" content="不扯犊子 -NOT ALONE">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> 大碗拉面 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?8fc1dcdaa63dc57073d1f217ba27dc7d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">大碗拉面</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
      
        <li class="menu-item menu-item-search">
          <a href="#" class="st-search-show-outputs">
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', '1zo1-KPbS2sqsk4pXnSQ','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">

    

    
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/18/nodejs-buffer/" itemprop="url">
                  nodejs buffer
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-07-18T09:55:23+08:00" content="2016-07-18">
              2016-07-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index">
                    <span itemprop="name">nodejs</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/18/nodejs-buffer/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/18/nodejs-buffer/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="Buffer_u7ED3_u6784"><a href="#Buffer_u7ED3_u6784" class="headerlink" title="Buffer结构"></a>Buffer结构</h3><ul>
<li>类似Array，为16进制的两位数，即占一个字节</li>
<li>js与c++结合的模块，内存由c++申请，js分配。因为v8垃圾回收影响性能</li>
<li>node启动时就加载，放在全局对象global</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var buf = <span class="keyword">new</span> Buffer(<span class="number">100</span>);</span><br><span class="line">console.<span class="built_in">log</span>(buf.length); <span class="comment">// =&gt; 100</span></span><br></pre></td></tr></table></figure>
<p><code>如给buffer赋值数字，则范围在0-255,否则负数就加256,过大就减256</code></p>
<p>内存使用slab分配机制，动态内存管理，包含三种状态（full,partial,empty）。Node以8KB为界限区分Buffer是大对象还是小对象（Buffer.poolSize=8*1024），即8kb为slab单元大小，js以它为单元分配内存</p>
<h4 id="u5206_u914D_u5C0FBuffer_u5BF9_u8C61"><a href="#u5206_u914D_u5C0FBuffer_u5BF9_u8C61" class="headerlink" title="分配小Buffer对象"></a>分配小Buffer对象</h4><ul>
<li>小于8kb</li>
</ul>
<p>使用局部变量pool,让处于分配状态的slab单元指向它</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pool;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">allocPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	pool = <span class="keyword">new</span> SlowBuffer(Buffer.poolSize);</span><br><span class="line">	pool.used = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新建小buffer时，如果还没pool,就创建一个slab指向它，当前的buffer对象的parent指向slab</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.parent = pool; <span class="comment">//当前的buffer对象的parent指向slab</span></span><br><span class="line"><span class="keyword">this</span>.offset = pool.used;<span class="comment">//slab开始使用的位置</span></span><br><span class="line">pool.used += <span class="keyword">this</span>.length;<span class="comment">//slab已使用量</span></span><br><span class="line"><span class="keyword">if</span> (pool.used &amp; <span class="number">7</span>) pool.used = (pool.used + <span class="number">8</span>) &amp; ~<span class="number">7</span>;</span><br></pre></td></tr></table></figure>
<p>此时slab状态为partial,在创建buffer时会判断次slab是否够用，如果不够，就构建新的slab,原来的slab剩余的空间浪费，如果不释放就占据8kb</p>
<h4 id="u5206_u914D_u5927Buffer"><a href="#u5206_u914D_u5927Buffer" class="headerlink" title="分配大Buffer"></a>分配大Buffer</h4><p>直接分配一个SlowBuffer对象作为slab单元，并且独占</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Big buffer, just alloc one</span><span class="keyword">this</span>.parent = <span class="keyword">new</span> SlowBuffer(<span class="keyword">this</span>.length);<span class="comment">//SlowBuffer由c++定义,勿直接操作它</span><span class="keyword">this</span>.offset = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p><strong>Buffer对象是js层面的，能被v8标记回收</strong>，但其内部parent指向SlowBuffer,由c++提供的Buffer,所以内存由c++提供，js只是使用它，对于小buffer的频繁操作，使用<strong>slab机制来先申请后分配</strong>，减少内存申请的系统调用，对于<strong>大buffe就直接用C++提供内存</strong></p>
<h3 id="Buffer_u8F6C_u6362"><a href="#Buffer_u8F6C_u6362" class="headerlink" title="Buffer转换"></a>Buffer转换</h3><ul>
<li>支持的字符串编码 ASCII,UTF-8,UTF-16LE/UCS-2,Base64,Binary,Hex</li>
</ul>
<h4 id="u5B57_u7B26_u4E32_u4E0EBuffer_u7684_u8F6C_u6362"><a href="#u5B57_u7B26_u4E32_u4E0EBuffer_u7684_u8F6C_u6362" class="headerlink" title="字符串与Buffer的转换"></a>字符串与Buffer的转换</h4><p>字符串转buffer,使用构造函数new Buffer(str,[encoding]);默认UTF-8</p>
<p><strong>一个Buffer对象可以存多种编码类型的字符串转码的值</strong></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buf.<span class="command">write</span>(<span class="type">string</span>, [<span class="command">offset</span>], [<span class="property">length</span>], [encoding])</span><br></pre></td></tr></table></figure>
<p>buffer转字符串</p>
<pre><code>buf.toString([encoding], [start], [end]) //encoding默认UTF-8,配合start\end实现局部转换

<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="header">#### Buffer不支持的编码类型</span></span><br><span class="line"><span class="bullet">- </span>使用Buffer.isEncoding(encoding)判断</span><br><span class="line"></span><br><span class="line"><span class="code">`iconv 通过c++调用libiconv`</span></span><br><span class="line"><span class="code">`iconv-lite使用纯js实现，但基于v8高性能，少了c++到js的转换，所以比C++实现好`</span></span><br></pre></td></tr></table></figure>

var iconv = require(&apos;iconv-lite&apos;);

var str = iconv.decode(buf, &apos;win1251&apos;);
var buf = iconv.encode(&quot;Sample input string&quot;, &apos;win1251&apos;);`
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="escape">`对</span>无法转换的内容会降级处理，输出部分或者？<span class="escape">`</span><br><span class="line"></span></span><br><span class="line">### Buffer拼接</span><br></pre></td></tr></table></figure>

var fs = require(&apos;fs&apos;);
var rs = fs.createReadStream(&apos;test.md&apos;);
var data = &apos;&apos;;
rs.on(&quot;data&quot;, function(chunk) {
    data += chunk; //等价于data = data.toString() + chunk.toString();此处对宽字节的中文可能造成乱码，即字节没读全就转码
});
rs.on(&quot;end&quot;, function() {
    console.log(data);
});

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#### 解决乱码问题</span></span><br><span class="line">- 在调用<span class="built_in">set</span>Encoding()时，可读流对象在内部设置一个decoder对象</span><br></pre></td></tr></table></figure>

var StringDecoder = require(&apos;string_decoder&apos;).StringDecoder;
var decoder = new StringDecoder(&apos;utf8&apos;);
var buf1 = new Buffer([0xE5, 0xBA, 0x8A, 0xE5, 0x89, 0x8D, 0xE6, 0x98, 0x8E, 0xE6, 0x9C]);
console.log(decoder.write(buf1));
// =&gt; 床前明
var buf2 = new Buffer([0x88, 0xE5, 0x85, 0x89, 0xEF, 0xBC, 0x8C, 0xE7, 0x96, 0x91, 0xE6]);
console.log(decoder.write(buf2));
// =&gt;月光，凝

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">StringDecoder在得到编码后，知道宽字节在utf-<span class="number">8</span>下占<span class="number">3</span>个字节，所以在处理末尾不全的字节时，会保留到第二次write().目前只能处理UTF-<span class="number">8</span>、Base64和UCS-<span class="number">2</span>/UTF-<span class="number">16L</span>E</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#### 正确拼接Buffer</span></span><br></pre></td></tr></table></figure>

var chunks = [];
var size = 0;
res.on(&apos;data&apos;, function(chunk) {
    chunks.push(chunk);
    size += chunk.length;
});
res.on(&apos;end&apos;, function() {
    var buf = Buffer.concat(chunks, size);
    var str = iconv.decode(buf, &apos;utf8&apos;);
    console.log(str);
});

<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">用数组来储存接收的所有Buffer片段并记录总长度，然后调用Buffer.concat<span class="function"><span class="params">()</span>--&gt;</span></span><br></pre></td></tr></table></figure>

Buffer.concat = function(list, length) {
    if (!Array.isArray(list)) {
        throw new Error(&apos;Usage: Buffer.concat(list, [length])&apos;);
    }
    if (list.length === 0) {
        return new Buffer(0);
    } else if (list.length === 1) {
        return list[0];
    }
    if (typeof length !== &apos;number&apos;) {
        length = 0;
        for (var i = 0; i &lt; list.length; i++) {
            var buf = list[i];
            length += buf.length;
        }
    }
    var buffer = new Buffer(length);
    var pos = 0;
    for (var i = 0; i &lt; list.length; i++) {
        var buf = list[i];
        buf.copy(buffer, pos);
        pos += buf.length;
    }
    return buffer;
};

<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### <span class="keyword">Buffer</span>与性能</span><br><span class="line"></span><br><span class="line"><span class="keyword">Buffer</span>广泛应用于文件I/O和网络I/O,尤其在网络传输，**使用<span class="keyword">Buffer</span>比直接使用字符串要性能要高很多。在web开发中对于静态内容可以预先转成<span class="keyword">buffer</span>**,在不需要改变内容时，只读取<span class="keyword">buffer</span>,不做转换</span><br><span class="line"></span><br><span class="line">#### 文件读取</span><br><span class="line"></span><br><span class="line">fs.createReadStream()先在内存中准备一段<span class="keyword">buffer</span>,然后在fs.read()读取时逐步将磁盘中的字节复制到<span class="keyword">buffer</span>,读完一次就用slice()从<span class="keyword">buffer</span>取出部分作为小<span class="keyword">buffer</span>通过data事件传给调用方。<span class="keyword">Buffer</span>用完会重新分配</span><br></pre></td></tr></table></figure>

fs.createReadStream(path, opts)
//参数
{
    flags: &apos;r&apos;,
    encoding: null,
    fd: null,
    mode: 0666,
    highWaterMark: 64 * 1024 // 每次读取的长度
}

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">重新分配</span><br></pre></td></tr></table></figure>

var pool;//常驻内存

function allocNewPool(poolSize) {
    pool = new Buffer(poolSize);
    pool.used = 0;
}
//当pool剩余数量小于128(kMinPoolSpace)字节时，会重新分配
if (!pool || pool.length - pool.used &lt; kMinPoolSpace) { 
// discard the old pool
    pool = null;
    allocNewPool(this._readableState.highWaterMark);
}
</code></pre><p>highWaterMark的大小对性能的影响有：<strong>buffer内存的分配和使用、系统调用次数</strong>;</p>
<ul>
<li>文件流读取基于buffer,buffer基于slowbuffer，文件小于8kb可能造成slab浪费</li>
<li>fs.createReadStream()内部使用fs.read()，会引起系统对磁盘的调用，highWaterMark的大小决定调用次数和data事件次数</li>
</ul>
<p><img src="/../picture/node-buffer" alt="Smaller icon"></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/12/node内存控制/" itemprop="url">
                  node内存控制
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-07-12T16:21:42+08:00" content="2016-07-12">
              2016-07-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index">
                    <span itemprop="name">nodejs</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/12/node内存控制/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/12/node内存控制/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="u5783_u573E_u56DE_u6536_u673A_u5236"><a href="#u5783_u573E_u56DE_u6536_u673A_u5236" class="headerlink" title="垃圾回收机制"></a>垃圾回收机制</h3><ul>
<li>nodejs在执行JavaScript时，内存受到v8限制,64位约为1.4g,32位0.7g</li>
<li>所有js对象是通过堆分配，查看process.memoryUsage()</li>
<li>限制内存原因：垃圾回收时，js线程会暂停执行（避免JS应用逻辑与垃圾回收器看到的不一样），大量的堆内存回收严重影响性能</li>
<li>v8内存整体包含新生代和老生代</li>
</ul>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// 调整内存限制的大小</span><br><span class="line"><span class="keyword">node</span><span class="identifier"> </span><span class="title">--max-old-space-size</span>=<span class="number">1700</span> test.js // 单位为MB <span class="keyword">node</span><span class="identifier"> </span><span class="title">--max-new-space-size</span>=<span class="number">1024</span> test.js // 单位为KB</span><br><span class="line">在V8初始化时生效,一旦生效不能动态变化</span><br></pre></td></tr></table></figure>
<h4 id="u65B0_u751F_u4EE3"><a href="#u65B0_u751F_u4EE3" class="headerlink" title="新生代"></a>新生代</h4><ul>
<li>由两个reserved_semispace<em>size</em>（32位16mb,62位32mb）构成</li>
<li>通过Scavenge算法进行回收，具体实现采用Cheney算法</li>
</ul>
<p>Cheney算法采用复制方式实现垃圾回收，将堆内存分成2块，一个使用（From），一个空闲(To).分配对象在From空间。开始垃圾回收时，检查From里的存活对象，并将它们复制到To，非存活对象占用的空间会被释放，然后From、to角色对换。将存活对象在两个空间之间复制</p>
<p><code>优点是时间短、缺点是只能使用一半堆内存。新生代对象生命周期短，适合此算法</code></p>
<p>当对象经过多次复制依然存活，就会晋升到老生代。对像晋升的条件，<code>是否经历过Scavenge回收,To空间内存占用比超过限制</code></p>
<h4 id="u8001_u751F_u4EE3"><a href="#u8001_u751F_u4EE3" class="headerlink" title="老生代"></a>老生代</h4><ul>
<li>在64未系统下为1400 MB,在32为700 MB</li>
<li>使用Mark-Sweep和Mark-Compact进行垃圾回收</li>
</ul>
<p><code>Mark-Sweep</code> 标记清除,先遍历堆的对象，标记活的对象，之后清除没标记的对象。死对象在老生代只占少部分，所以高效</p>
<p><code>Mark-Compact</code> 整理内存，将Mark-Sweep清理后散开的对象移动到一段。</p>
<p>v8主要使用Mark-Sweep,在空间不足以对新晋升对象分配时才用Mark-Compact</p>
<h4 id="u589E_u91CF_u6807_u8BB0_28incremental_marking_29"><a href="#u589E_u91CF_u6807_u8BB0_28incremental_marking_29" class="headerlink" title="增量标记(incremental marking)"></a>增量标记(incremental marking)</h4><ul>
<li>降低老生代的全堆垃圾回收带来的时间停顿</li>
<li>从标记阶段入手，拆分为许多小步进，与应用逻辑交替运行</li>
<li>垃圾回收最大停顿时间降为原来的1/6</li>
</ul>
<p><code>垃圾回收是影响性能的因素之一，要尽量减少垃圾回收，尤其全堆垃圾回收</code></p>
<h4 id="u67E5_u770B_u5783_u573E_u56DE_u6536_u65E5_u5FD7"><a href="#u67E5_u770B_u5783_u573E_u56DE_u6536_u65E5_u5FD7" class="headerlink" title="查看垃圾回收日志"></a>查看垃圾回收日志</h4><ul>
<li>在启动时添加–trace_gc</li>
</ul>
<p>启动时使用–prof,可以得到v8性能分析数据，包含垃圾回收占用的时间，需要使用工具读取，在Node源码的deps/v8/tools，linux-tick-processor  </p>
<h3 id="u9AD8_u6548_u4F7F_u7528_u5185_u5B58"><a href="#u9AD8_u6548_u4F7F_u7528_u5185_u5B58" class="headerlink" title="高效使用内存"></a>高效使用内存</h3><h4 id="u4F5C_u7528_u57DF"><a href="#u4F5C_u7528_u57DF" class="headerlink" title="作用域"></a>作用域</h4><ul>
<li>js中能形成作用域的有函数调用、with和全局作用域</li>
</ul>
<p>例如，在函数调用时，会创建对应的作用域，在执行结束后销毁，并且在该作用域申明的局部变量也会被销毁</p>
<ol>
<li>标识符查找（即变量名） 先查找当前作用域，再向上级作用域，一直到全局作用域</li>
<li>变量主动释放 全局变量要直到进程退出才释放，导致引用对象常驻老生代，可以用delete删除或者赋undefined、null(delete删除对象的属性可能干扰v8,所以赋值更好)</li>
</ol>
<h4 id="u95ED_u5305"><a href="#u95ED_u5305" class="headerlink" title="闭包"></a>闭包</h4><ul>
<li>外部作用域访问内部作用域的方法，得益于高阶函数特性</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> bar = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">var</span> local = <span class="string">"局部变量"</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> local;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">var</span> baz = bar();</span><br><span class="line">	<span class="built_in">console</span>.log(baz());</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>bar()返回一个匿名函数,一旦 有变量引用它，它的作用域将不会释放，直到没有引用</p>
<p><code>把闭包赋值给一个不可控的对象时，会导致内存泄漏。使用完，将变量赋其他值或置空</code></p>
<h4 id="u67E5_u770B_u5185_u5B58_u4F7F_u7528_u60C5_u51B5"><a href="#u67E5_u770B_u5185_u5B58_u4F7F_u7528_u60C5_u51B5" class="headerlink" title="查看内存使用情况"></a>查看内存使用情况</h4><ul>
<li>查看进程内存占用 process.memoryUsage(),其中rss为进程的常驻内存（node所占的内存），heapTotal、heapUsed为堆内存使用情况</li>
<li>os.totalmem(),os.freemem() 查看系统内存</li>
</ul>
<p><code>Node使用的内存不是都通过v8分配，还有堆外内存,用于处理网络流、I/O流</code></p>
<h3 id="u5185_u5B58_u6CC4_u6F0F"><a href="#u5185_u5B58_u6CC4_u6F0F" class="headerlink" title="内存泄漏"></a>内存泄漏</h3><p><code>造成的原因：缓存、队列消费不及时、作用域未释放</code></p>
<h4 id="u7F13_u5B58"><a href="#u7F13_u5B58" class="headerlink" title="缓存"></a>缓存</h4><ul>
<li>限制内存当缓存，要限制好大小，做好释放</li>
<li>进程之间不能共享内存，所以用内存做缓存也是</li>
</ul>
<p><code>为了加速模块引入，模块会在编译后缓存，由于通过exports导出(闭包),作用域不会释放，常驻老生代。要注意内存泄漏</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> leakArray = [];</span><br><span class="line">exports.leak = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	leakArray.push(<span class="string">"leak"</span> + <span class="built_in">Math</span>.random());</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//局部变量leakArray不停增加内存占用，且不会释放，如果必须如此设计，要提供释放接口</span></span><br></pre></td></tr></table></figure>
<p>推荐使用进程外缓存，<a href="https://github.com/mranney/node_redis" target="_blank">Redis</a>、<a href="https://github.com/3rd-Eden/node-memcached" target="_blank">Memcached</a></p>
<h4 id="u961F_u5217_u72B6_u6001"><a href="#u961F_u5217_u72B6_u6001" class="headerlink" title="队列状态"></a>队列状态</h4><ul>
<li>在生产者和消费者中间</li>
<li>监控队列的长度，超过长度就拒绝</li>
<li>任意的异步调用应该包含超时机制</li>
</ul>
<h4 id="u5185_u5B58_u6CC4_u6F0F_u6392_u67E5"><a href="#u5185_u5B58_u6CC4_u6F0F_u6392_u67E5" class="headerlink" title="内存泄漏排查"></a>内存泄漏排查</h4><h5 id="node-heapdump"><a href="#node-heapdump" class="headerlink" title="node-heapdump"></a>node-heapdump</h5><ol>
<li>安装 npm install heapdump</li>
<li>在开头引入 var heapdump = require(‘heapdump’);</li>
<li>发送命令kill -USR2 <pid>，heapdump会抓拍一份堆内存快照，文件为heapdump-<sec>.<usec>.heapsnapshot格式，是json文件</usec></sec></pid></li>
</ol>
<h5 id="node-memwatch"><a href="#node-memwatch" class="headerlink" title="node-memwatch"></a>node-memwatch</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> memwatch = <span class="built_in">require</span>(<span class="string">'memwatch'</span>);</span><br><span class="line">memwatch.on(<span class="string">'leak'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">info</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'leak:'</span>);</span><br><span class="line">	<span class="built_in">console</span>.log(info);</span><br><span class="line">&#125;);</span><br><span class="line">memwatch.on(<span class="string">'stats'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">stats</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'stats:'</span>) <span class="built_in">console</span>.log(stats);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>在进程使用node-memwatch后，<strong>每次全堆垃圾回收，会触发stats事件</strong>，该事件会传递内存的统计信息</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">stats</span>: &#123;</span><br><span class="line">		<span class="attribute">num_full_gc</span>: <span class="number">4</span>, <span class="comment">//   第几次全堆垃圾回收</span></span><br><span class="line">		<span class="attribute">num_inc_gc</span>: <span class="number">23</span>, <span class="comment">//    第几次增量垃圾回收 </span></span><br><span class="line">		<span class="attribute">heap_compactions</span>: <span class="number">4</span>, <span class="comment">//  第几次对老生代整理</span></span><br><span class="line">		<span class="attribute">usage_trend</span>: <span class="number">0</span>, <span class="comment">// 使用趋势</span></span><br><span class="line">		<span class="attribute">estimated_base</span>: <span class="number">7152944</span>, <span class="comment">// 预估基数 </span></span><br><span class="line">		<span class="attribute">current_base</span>: <span class="number">7152944</span>, <span class="comment">// 当前基数</span></span><br><span class="line">		<span class="attribute">min</span>: <span class="number">6720776</span>, <span class="comment">//  最小</span></span><br><span class="line">		<span class="attribute">max</span>: <span class="number">7152944</span>  <span class="comment">//最大</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>如果经过连续的5次垃圾回收后，内存仍没有被释放，意味有内存泄漏，node-memwatch会触发leak事件</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">leak</span>: <span class="tag">8</span> &#123;</span><br><span class="line">	<span class="attribute">start</span>: Mon Oct <span class="number">07</span> <span class="number">2013</span> <span class="number">13</span>: <span class="number">46</span>: <span class="number">27</span> GMT + <span class="number">0800</span>(CST),</span><br><span class="line">	<span class="attribute">end</span>: Mon Oct <span class="number">07</span> <span class="number">2013</span> <span class="number">13</span>: <span class="number">54</span>: <span class="number">40</span> GMT + <span class="number">0800</span>(CST),</span><br><span class="line">	<span class="attribute">growth</span>: <span class="number">6222576</span>,</span><br><span class="line">	<span class="attribute">reason</span>: <span class="string">'heap growth over 5 consecutive GCs (8m 13s) - 43.33 mb/hr'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//显示内存增长了多了</span></span><br></pre></td></tr></table></figure>
<p>使用node-memwatch的抓取快照和比较快照，能将内存泄漏定位到v8的堆上</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> memwatch = <span class="built_in">require</span>(<span class="string">'memwatch'</span>);</span><br><span class="line"><span class="keyword">var</span> leakArray = [];</span><br><span class="line"><span class="keyword">var</span> leak = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	leakArray.push(<span class="string">"leak"</span> + <span class="built_in">Math</span>.random());</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// Take first snapshot</span></span><br><span class="line"><span class="keyword">var</span> hd = <span class="keyword">new</span> memwatch.HeapDiff();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">	leak();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Take the second snapshot and compute the diff </span></span><br><span class="line"><span class="keyword">var</span> diff = hd.end();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(diff, <span class="literal">null</span>, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"before"</span>: &#123;</span><br><span class="line">		<span class="string">"nodes"</span>: <span class="number">11719</span>,</span><br><span class="line">		<span class="string">"time"</span>: <span class="string">"2013-10-07T06:32:07.000Z"</span>,</span><br><span class="line">		<span class="string">"size_bytes"</span>: <span class="number">1493304</span>,</span><br><span class="line">		<span class="string">"size"</span>: <span class="string">"1.42 mb"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">"after"</span>: &#123;</span><br><span class="line">		<span class="string">"nodes"</span>: <span class="number">31618</span>,</span><br><span class="line">		<span class="string">"time"</span>: <span class="string">"2013-10-07T06:32:07.000Z"</span>,</span><br><span class="line">		<span class="string">"size_bytes"</span>: <span class="number">2684864</span>,</span><br><span class="line">		<span class="string">"size"</span>: <span class="string">"2.56 mb"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">"change"</span>: &#123;</span><br><span class="line">		<span class="string">"size_bytes"</span>: <span class="number">1191560</span>,</span><br><span class="line">		<span class="string">"size"</span>: <span class="string">"1.14 mb"</span>,</span><br><span class="line">		<span class="string">"freed_nodes"</span>: <span class="number">129</span>, <span class="comment">//释放的节点数</span></span><br><span class="line">		<span class="string">"allocated_nodes"</span>: <span class="number">20028</span>,<span class="comment">//分配的节点数</span></span><br><span class="line">		<span class="string">"details"</span>: [&#123;</span><br><span class="line">			<span class="string">"what"</span>: <span class="string">"Array"</span>,</span><br><span class="line">			<span class="string">"size_bytes"</span>: <span class="number">323720</span>,</span><br><span class="line">			<span class="string">"size"</span>: <span class="string">"316.13 kb"</span>,</span><br><span class="line">			<span class="string">"+"</span>: <span class="number">15</span>,</span><br><span class="line">			<span class="string">"-"</span>: <span class="number">65</span></span><br><span class="line">		&#125;, &#123;</span><br><span class="line">			<span class="string">"-"</span>: <span class="number">28</span></span><br><span class="line">		&#125;, &#123;</span><br><span class="line">			<span class="string">"what"</span>: <span class="string">"String"</span>,</span><br><span class="line">			<span class="string">"size_bytes"</span>: <span class="number">879424</span>,</span><br><span class="line">			<span class="string">"what"</span>: <span class="string">"Code"</span>,</span><br><span class="line">			<span class="string">"size_bytes"</span>: -<span class="number">10944</span>,</span><br><span class="line">			<span class="string">"size"</span>: <span class="string">"-10.69 kb"</span>,</span><br><span class="line">			<span class="string">"+"</span>: <span class="number">8</span>,</span><br><span class="line">			<span class="string">"size"</span>: <span class="string">"858.81 kb"</span>,</span><br><span class="line">			<span class="string">"+"</span>: <span class="number">20001</span>, <span class="comment">//大量的string未被回收</span></span><br><span class="line">			<span class="string">"-"</span>: <span class="number">1</span></span><br><span class="line">		&#125;]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="u5927_u5185_u5B58_u5E94_u7528"><a href="#u5927_u5185_u5B58_u5E94_u7528" class="headerlink" title="大内存应用"></a>大内存应用</h4><ul>
<li>使用stream模块处理大文件，fs的createReadStream(),createWriteStream()</li>
</ul>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> reader = fs.createReadStream(<span class="string">'in.txt'</span>);</span><br><span class="line"><span class="keyword">var</span> writer = fs.createWriteStream(<span class="string">'out.txt'</span>);</span><br><span class="line">reader.<span class="keyword">on</span>(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span><span class="params">(chunk)</span> <span class="comment">&#123;</span><br><span class="line">	writer.write(chunk);</span><br><span class="line">&#125;</span>);</span></span><br><span class="line">reader.<span class="keyword">on</span>(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> <span class="comment">&#123;</span><br><span class="line">	writer.end();</span><br><span class="line">&#125;</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//管道方法pipe()，封装了data事件和写入</span></span><br><span class="line"><span class="keyword">var</span> reader = fs.createReadStream(<span class="string">'in.txt'</span>);</span><br><span class="line"><span class="keyword">var</span> writer = fs.createWriteStream(<span class="string">'out.txt'</span>);</span><br><span class="line">reader.pipe(writer);</span><br></pre></td></tr></table></figure>
<p><code>在不需要进行字符串操作时，可以不借助v8，使用Buffer操作，这样不会受到v8的内存限制</code></p>
<p><img src="/../picture/nodejs内存" alt="Smaller icon"></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/08/nginx-http模块基本配置/" itemprop="url">
                  nginx http模块基本配置
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-07-08T10:20:26+08:00" content="2016-07-08">
              2016-07-08
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/nginx/" itemprop="url" rel="index">
                    <span itemprop="name">nginx</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/08/nginx-http模块基本配置/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/08/nginx-http模块基本配置/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="u865A_u62DF_u4E3B_u673A_u548C_u8BF7_u6C42_u5206_u53D1"><a href="#u865A_u62DF_u4E3B_u673A_u548C_u8BF7_u6C42_u5206_u53D1" class="headerlink" title="虚拟主机和请求分发"></a>虚拟主机和请求分发</h3><ul>
<li>多个域名对应同一ip时,配置多个server虚拟主机，对应多个域名，server_name对应用户请求的域名</li>
</ul>
<h4 id="u76D1_u542C_u7AEF_u53E3"><a href="#u76D1_u542C_u7AEF_u53E3" class="headerlink" title="监听端口"></a>监听端口</h4><ul>
<li>默认： listen 80;</li>
<li>配置块： server</li>
</ul>
<p>可以加ip、端口、主机名</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">listen <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>;</span><br><span class="line">listen <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>;<span class="comment">//不加端口号，默认监听80</span></span><br><span class="line">listen *:<span class="number">8000</span>;</span><br><span class="line">listen <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>  default_server backlog=<span class="number">1024</span>;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>parameters</th>
<th>定义</th>
</tr>
</thead>
<tbody>
<tr>
<td>default/default_server</td>
<td>默认server块，不设置就默认第一个server，当请求没能匹配到主机域名时，就选择默认</td>
</tr>
<tr>
<td>backlog=num</td>
<td>tcp中的backlog队列大小。默认-1，不设置。存放等待建立tcp三次握手连接</td>
</tr>
<tr>
<td>rcvbuf=size</td>
<td>监听句柄的SO_RCVBUF</td>
</tr>
<tr>
<td>sndbuf=size</td>
<td>监听句柄的SO_SNDBUF</td>
</tr>
<tr>
<td>accpet_filter</td>
<td>设置accept过滤器，只对FreeBSD</td>
</tr>
<tr>
<td>deferred</td>
<td>只有用户发送请求数据，内核在网卡中收到请求数据包，内核才会唤醒worker进程处理，适用于大并发情况，一般不建议使用</td>
</tr>
<tr>
<td>bind</td>
<td>绑定当前端口/地址对，如127.0.0.1：8000.只有同时对一个端口监听多个地址时有效</td>
</tr>
<tr>
<td>ssl</td>
<td>监听的端口连接必须基于ssl</td>
</tr>
</tbody>
</table>
<h4 id="u4E3B_u673A_u57DF_u540D"><a href="#u4E3B_u673A_u57DF_u540D" class="headerlink" title="主机域名"></a>主机域名</h4><ul>
<li>语法： server——name name[…];可以跟多个主机名</li>
<li>默认： server_name “”; 匹配没有Host的http请求</li>
<li>配置块： server</li>
</ul>
<p>当header的host和多个server匹配，则按匹配优先级</p>
<ol>
<li>字符串完全匹配 www.test.com</li>
<li>通配符在前面的 *.test.com</li>
<li>通配符在后面的 www.test. *</li>
<li>使用正则的</li>
</ol>
<p>都不匹配就选默认的</p>
<h4 id="location"><a href="#location" class="headerlink" title="location"></a>location</h4><ul>
<li>语法： location [=|~|~*|^~|@]</li>
<li>默认： server_name “”; 匹配没有Host的http请求</li>
<li>配置块： server</li>
</ul>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/05/nginx-负载均衡和反向代理的基本配置/" itemprop="url">
                  nginx 负载均衡和反向代理的基本配置
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-07-05T17:47:22+08:00" content="2016-07-05">
              2016-07-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/nginx/" itemprop="url" rel="index">
                    <span itemprop="name">nginx</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/05/nginx-负载均衡和反向代理的基本配置/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/05/nginx-负载均衡和反向代理的基本配置/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="u8D1F_u8F7D_u5747_u8861"><a href="#u8D1F_u8F7D_u5747_u8861" class="headerlink" title="负载均衡"></a>负载均衡</h3><ul>
<li>此处指的是选择一种策略，尽量把请求均匀的分布到每一个上游服务器</li>
</ul>
<h4 id="upstream"><a href="#upstream" class="headerlink" title="upstream"></a>upstream</h4><ul>
<li>配置块 http</li>
<li>语法 upstream name{}</li>
<li>定义一个上游服务器的集群，便于反向代理的proxy_pass使用</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    server <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5566</span> weight=<span class="number">1</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">30</span>s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http:<span class="comment">//backend; #backend指上游服务器</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="server"><a href="#server" class="headerlink" title="server"></a>server</h5><ul>
<li>配置块 upstream</li>
<li>语法 server names[parameters]</li>
<li>指定一台上游服务器的名字 可以是域名，ip，UNIX句柄</li>
</ul>
<table>
<thead>
<tr>
<th>parameters</th>
<th>定义</th>
</tr>
</thead>
<tbody>
<tr>
<td>weight=number</td>
<td>上游服务器转发的权重 默认1</td>
</tr>
<tr>
<td>max_fails=number</td>
<td>在fail_timeout时间内，如果向上游服务器转发失败次数超过number,就认为该服务器在此时间段里不可用，默认1 设为0就不检查失败次数</td>
</tr>
<tr>
<td>fail_timeout=time</td>
<td>用于优化反向代理功能，与连接、读取、响应超时无关，默认10秒</td>
</tr>
<tr>
<td>down</td>
<td>永久下线服务器，只在使用ip_hash有效</td>
</tr>
<tr>
<td>backup</td>
<td>在使用ip_hash时无效 表示上游服务器只是备份服务器，只有在所有非备份上游服务器失效后，才会指向备份</td>
</tr>
</tbody>
</table>
<h5 id="ip_hash"><a href="#ip_hash" class="headerlink" title="ip_hash"></a>ip_hash</h5><ul>
<li>配置块 upstream</li>
<li>语法 ip_hash;</li>
<li>将单个用户的请求固定到某个上游服务器</li>
</ul>
<p>先根据客户端的ip地址计算一个key,将可以按照upstream集群的上游服务器数量进行取模，再根据取模的结果把请求地址转发到相应的上游服务器,不能与weight同时使用，<strong>在标识上游服务器不可用时，要用down不能直接删除，确保转发策略一贯性</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line"> 	ip_hash;</span><br><span class="line">    server <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5566</span> weight=<span class="number">1</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">30</span>s;</span><br><span class="line">    server backend down;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="u8BB0_u5F55_u65E5_u5FD7_u65F6_u652F_u6301_u7684_u53D8_u91CF"><a href="#u8BB0_u5F55_u65E5_u5FD7_u65F6_u652F_u6301_u7684_u53D8_u91CF" class="headerlink" title="记录日志时支持的变量"></a>记录日志时支持的变量</h4><table>
<thead>
<tr>
<th>变量名</th>
<th>定义</th>
</tr>
</thead>
<tbody>
<tr>
<td>$upstream_addr</td>
<td>处理请求的上游服务器地址</td>
</tr>
<tr>
<td>$upstream_cache_status</td>
<td>表示是否命中缓存，取值范围：MISS、EXPIRED、UPDATING、SATLE、HIT</td>
</tr>
<tr>
<td>$upstream_status</td>
<td>上游服务器返回的响应中HTTP响应码</td>
</tr>
<tr>
<td>$upstream_response_time</td>
<td>上游服务器响应时间，精度毫秒</td>
</tr>
<tr>
<td>$upstream<em>http</em>$HEADER</td>
<td>http头部，如upstream_http_host</td>
</tr>
</tbody>
</table>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">log_format</span> timing <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] <span class="variable">$request</span> '</span></span><br><span class="line">	<span class="string">'upstream_response_time <span class="variable">$upstream_response_time</span> '</span></span><br><span class="line">	<span class="string">'msec <span class="variable">$msec</span> request_time <span class="variable">$request_time</span>'</span>;</span><br><span class="line"></span><br><span class="line"><span class="title">log_format</span> up_head <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] <span class="variable">$request</span> '</span></span><br><span class="line">	<span class="string">'upstream_http_content_type <span class="variable">$upstream_http_content_type</span>'</span></span><br></pre></td></tr></table></figure>
<h3 id="u53CD_u5411_u4EE3_u7406_u914D_u7F6E"><a href="#u53CD_u5411_u4EE3_u7406_u914D_u7F6E" class="headerlink" title="反向代理配置"></a>反向代理配置</h3><h4 id="proxy_pass"><a href="#proxy_pass" class="headerlink" title="proxy_pass"></a>proxy_pass</h4><ul>
<li>语法：proxy_pass URL;</li>
<li>配置块 location、if</li>
</ul>
<p>将当前请求反向代理到URL参数指定的服务器上，URL可以是主机名或ip地址</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">proxy_pass http://localhost:<span class="number">3000</span>/uri/;</span><br><span class="line"></span><br><span class="line">可以加上负载均衡 使用upstream</span><br><span class="line">upstream backend <span class="decorator">&#123;...&#125;</span></span><br><span class="line">server &#123;location / &#123;</span><br><span class="line">            proxy_pass http://backend; <span class="comment">#backend指上游服务器</span></span><br><span class="line">        &#125;&#125;</span><br><span class="line"></span><br><span class="line">可以把httpz转换成https</span><br><span class="line">proxy_pass https://<span class="number">192</span>.<span class="number">168</span>.<span class="number">0</span>.<span class="number">1</span>/;</span><br><span class="line"></span><br><span class="line">若需要转发host头部</span><br><span class="line">proxy_set_header <span class="type">Host</span> $host;</span><br></pre></td></tr></table></figure>
<h4 id="proxy_method"><a href="#proxy_method" class="headerlink" title="proxy_method"></a>proxy_method</h4><ul>
<li>语法：proxy_method method;</li>
<li>配置块 http、server、location</li>
</ul>
<p>转发时的协议方法名<br>proxy_method POST; 客户端的GET请求也会被转发成POST</p>
<h4 id="proxy_hide_header"><a href="#proxy_hide_header" class="headerlink" title="proxy_hide_header"></a>proxy_hide_header</h4><ul>
<li>语法：proxy_hide_header the_header;</li>
<li>配置块 http、server、location</li>
</ul>
<p>Nginx会将上游服务器的响应转发给客户端，但默认不会转发以下HTTP头部字段：Date、Server、X-Pad和X-Accel-*.使用proxy_hide_header可以指定哪些不能转发</p>
<p>proxy_hide_header Cache-Control;</p>
<h4 id="proxy_pass_header"><a href="#proxy_pass_header" class="headerlink" title="proxy_pass_header"></a>proxy_pass_header</h4><ul>
<li>语法：proxy_pass_header the_header;</li>
<li>配置块 http、server、location</li>
</ul>
<p>将原来禁止转发的header设为转发</p>
<h4 id="proxy_pass_request_body"><a href="#proxy_pass_request_body" class="headerlink" title="proxy_pass_request_body"></a>proxy_pass_request_body</h4><ul>
<li>语法：proxy_pass_request_body on|off;</li>
<li>默认 on;</li>
<li>配置块 http、server、location<br>是否向上游转发http body</li>
</ul>
<h4 id="proxy_pass_request_headers"><a href="#proxy_pass_request_headers" class="headerlink" title="proxy_pass_request_headers"></a>proxy_pass_request_headers</h4><ul>
<li>语法：proxy_pass_request_headers on|off;</li>
<li>默认 on;</li>
<li>配置块 http、server、location<br>是否向上游转发http header</li>
</ul>
<h4 id="prxoy_redirect"><a href="#prxoy_redirect" class="headerlink" title="prxoy_redirect"></a>prxoy_redirect</h4><ul>
<li>语法：prxoy_redirect [default|off|redirect rep|replacement]];</li>
<li>默认 default;</li>
<li>配置块 http、server、location</li>
</ul>
<p>当上游返回响应是重定向或刷新请求（301，302),proxy_redirect 可以重设HTTP头部的location或refresh字段。</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">proxy_redirect <span class="symbol">http:</span>/<span class="regexp">/localhost:8000/two</span><span class="regexp">/ http:/</span><span class="regexp">/frontend/one</span><span class="regexp">/;</span><br><span class="line"></span><br><span class="line">对location字段的URI是http:/</span><span class="regexp">/localhost:8000/two</span><span class="regexp">/some/uri</span>.实际转发给客户端的是<span class="symbol">http:</span>/<span class="regexp">/frontend/one</span><span class="regexp">/;</span><br><span class="line"></span><br><span class="line">可以使用ngx-http-core-module提供的变量来设置</span><br><span class="line"></span><br><span class="line">proxy_redirect http:/</span><span class="regexp">/localhost:8000/</span> <span class="symbol">http:</span>/<span class="regexp">/$host:$server_port/</span>;</span><br><span class="line"></span><br><span class="line">可以省略replacement参数的主机名部分，这时会用虚拟主机名称填充</span><br><span class="line">proxy_redirect <span class="symbol">http:</span>/<span class="regexp">/localhost:8000/two</span><span class="regexp">/ /one</span><span class="regexp">/;</span><br><span class="line"></span><br><span class="line">使用default参数时，会按照proxy_pass配置项和所属的location配置项重组</span><br><span class="line"></span><br><span class="line">location /one</span><span class="regexp">/ &#123;</span><br><span class="line">  proxy_pass http:/</span><span class="regexp">/upstream:port/two</span><span class="regexp">/;</span><br><span class="line">  proxy_redirect default;</span><br><span class="line">&#125;</span><br><span class="line">等于</span><br><span class="line">location /one</span><span class="regexp">/ &#123;</span><br><span class="line">	proxy_pass http:/</span><span class="regexp">/upstream:port/two</span><span class="regexp">/;</span><br><span class="line">	proxy_redirect http:/</span><span class="regexp">/upstream:port/two</span><span class="regexp">/ /one</span><span class="regexp">/;</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="proxy_next_upstream"><a href="#proxy_next_upstream" class="headerlink" title="proxy_next_upstream"></a>proxy_next_upstream</h4><ul>
<li>语法：proxy_next_upstream [error|timeout|invalid_header|http_500|http_502|http_503|http_504|http_404|off];</li>
<li>默认 error timeout;</li>
<li>配置块 http、server、location</li>
</ul>
<p>当向一台上游转发请求出错时，继续换一台处理<br>（invaild_header 上游响应不合法）</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/01/pm2介绍/" itemprop="url">
                  pm2
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-07-01T15:15:27+08:00" content="2016-07-01">
              2016-07-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index">
                    <span itemprop="name">nodejs</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/01/pm2介绍/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/01/pm2介绍/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <ul>
<li>pm2 是一个带有负载均衡功能的Node应用的进程管理器</li>
<li>内建负载均衡（使用Node cluster 集群模块）</li>
<li>后台运行</li>
<li>0秒停机重载，热升级</li>
<li>具有Ubuntu和CentOS 的启动脚本</li>
<li>停止不稳定的进程（避免无限循环）</li>
<li>控制台检测</li>
<li>提供 HTTP API</li>
<li>远程控制和实时的接口API ( Nodejs 模块,允许和PM2进程管理器交互 )</li>
<li><a href="https://github.com/Unitech/pm2" target="_blank">github</a></li>
</ul>
<table>
<thead>
<tr>
<th>command</th>
<th>explain</th>
</tr>
</thead>
<tbody>
<tr>
<td>$ npm install pm2 -g</td>
<td># Install PM2</td>
</tr>
<tr>
<td>$ pm2 start app.js</td>
<td># Start, Daemonize and auto restart application</td>
</tr>
<tr>
<td>$ pm2 start app.js -i 4</td>
<td># Start 4 instances of application in cluster mode it will load balance network queries to each app</td>
</tr>
<tr>
<td><strong>$ pm2 start app.js –name=”api”</strong></td>
<td># Start application and name it “api”</td>
</tr>
<tr>
<td>$ pm2 start app.js –watch</td>
<td># Restart application on file change</td>
</tr>
<tr>
<td>$ pm2 start script.sh</td>
<td># Start bash script</td>
</tr>
<tr>
<td>$ pm2 list</td>
<td># List all processes started with PM2</td>
</tr>
<tr>
<td><strong>$ pm2 monit</strong></td>
<td># Display memory and cpu usage of each app</td>
</tr>
<tr>
<td>$ pm2 show [app-name]</td>
<td># Show all informations about application</td>
</tr>
<tr>
<td><strong>$ pm2 logs</strong></td>
<td># Display logs of all apps</td>
</tr>
<tr>
<td>$ pm2 logs [app-name]</td>
<td># Display logs for a specific app</td>
</tr>
<tr>
<td>$ pm2 flush</td>
<td></td>
</tr>
<tr>
<td><strong>$ pm2 stop all</strong></td>
<td># Stop all apps</td>
</tr>
<tr>
<td>$ pm2 stop 0</td>
<td># Stop process with id 0</td>
</tr>
<tr>
<td><strong>$ pm2 restart all</strong></td>
<td># Restart all apps</td>
</tr>
<tr>
<td><strong>$ pm2 reload all</strong></td>
<td># Reload all apps in cluster mode</td>
</tr>
<tr>
<td>$ pm2 gracefulReload all</td>
<td># Graceful reload all apps in cluster mode</td>
</tr>
<tr>
<td>$ pm2 delete all</td>
<td># Kill and delete all apps</td>
</tr>
<tr>
<td>$ pm2 delete 0</td>
<td># Delete app with id 0</td>
</tr>
<tr>
<td>$ pm2 scale api 10</td>
<td># Scale app with name api to 10 instances</td>
</tr>
<tr>
<td>$ pm2 reset [app-name]</td>
<td># Reset number of restart for [app-name]</td>
</tr>
<tr>
<td>$ pm2 startup</td>
<td># Generate a startup script to respawn PM2 on boot</td>
</tr>
<tr>
<td>$ pm2 save</td>
<td># Save current process list</td>
</tr>
<tr>
<td>$ pm2 resurrect</td>
<td># Restore previously save processes</td>
</tr>
<tr>
<td>$ pm2 update</td>
<td># Save processes, kill PM2 and restore processes</td>
</tr>
<tr>
<td>$ pm2 generate</td>
<td># Generate a sample json configuration file</td>
</tr>
<tr>
<td>$ pm2 deploy app.json prod setup</td>
<td># Setup “prod” remote server</td>
</tr>
<tr>
<td>$ pm2 deploy app.json prod</td>
<td># Update “prod” remote server</td>
</tr>
<tr>
<td>$ pm2 deploy app.json prod revert 2</td>
<td># Revert “prod” remote server by 2</td>
</tr>
<tr>
<td>$ pm2 module:generate [name]</td>
<td># Generate sample module with name [name]</td>
</tr>
<tr>
<td>$ pm2 install pm2-logrotate</td>
<td># Install module (here a log rotation system)</td>
</tr>
<tr>
<td>$ pm2 uninstall pm2-logrotate</td>
<td># Uninstall module</td>
</tr>
<tr>
<td>$ pm2 publish</td>
<td># Increment version, git push and npm publish</td>
</tr>
</tbody>
</table>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/08/redux-学习笔记（1）/" itemprop="url">
                  redux 学习笔记（1）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-06-08T10:24:46+08:00" content="2016-06-08">
              2016-06-08
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/前端/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/06/08/redux-学习笔记（1）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/06/08/redux-学习笔记（1）/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="redux_u7684_u4F5C_u7528"><a href="#redux_u7684_u4F5C_u7528" class="headerlink" title="redux的作用"></a>redux的作用</h3><p><img src="/../picture/redux流程.png" alt="Smaller icon"></p>
<p>Redux 主要分为三个部分 Action、Reducer、及 Store</p>
<h4 id="action"><a href="#action" class="headerlink" title="action"></a>action</h4><ul>
<li>action用来传递操作 State 的信息,以 Javascript Plain Object 的形式存在，形如</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">type</span>:<span class="value"> <span class="string">'ADD_FILM'</span>,</span><br><span class="line">  name: <span class="string">'Mission: Impossible'</span></span><br><span class="line"></span></span></span>&#125;</span><br></pre></td></tr></table></figure>
<p>type 属性是必要的，用来表达处理 state 数据的方式，其他属性任意，建议简单</p>
<p>但为了方便组织，可以创建函数来生产 action，即Action Creator</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span></span> addFilm(<span class="keyword">name</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="keyword">type</span>: <span class="string">'ADD_FILM'</span>, <span class="keyword">name</span>: <span class="keyword">name</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Reducer"><a href="#Reducer" class="headerlink" title="Reducer"></a>Reducer</h4><ul>
<li>处理action传达需要操作的信息</li>
<li>通过传入旧的 state 和指示操作的 action 来更新 state</li>
</ul>
<p>Reducer 根据传入的<strong> action.type</strong> 来匹配 case 进行不同的 state 更新</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">function films(<span class="keyword">state</span> = initialState, action) &#123;</span><br><span class="line">  switch (action.type) &#123;</span><br><span class="line"> </span><br><span class="line">  case 'ADD_FILM':</span><br><span class="line">    // 更新 <span class="keyword">state</span> 中的 films 字段</span><br><span class="line">    return [&#123;</span><br><span class="line">      id: <span class="keyword">state</span>.films.reduce((<span class="keyword">max</span>Id, film) =&gt; Math.<span class="keyword">max</span>(film.id, <span class="keyword">max</span>Id), -<span class="number">1</span>) + <span class="number">1</span>,</span><br><span class="line">      name: action.name</span><br><span class="line">    &#125;, ...<span class="keyword">state</span>];</span><br><span class="line"> </span><br><span class="line">  case 'DELETE_FILM':</span><br><span class="line">    return <span class="keyword">state</span>.films.filter(film =&gt;</span><br><span class="line">        film.id !== action.id</span><br><span class="line">    );</span><br><span class="line"> </span><br><span class="line">  case 'SHOW_ALL_FILM':</span><br><span class="line">    return Object.assign(&#123;&#125;, <span class="keyword">state</span>, &#123;</span><br><span class="line">        visibilityFilter: action.filter</span><br><span class="line">      &#125;);</span><br><span class="line"> //不要修改 <span class="keyword">state</span>。 使用 Object.assign() 新建了一个副本</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    return <span class="keyword">state</span>;</span><br><span class="line">    //在 <span class="keyword">default</span> 情况下返回旧的 <span class="keyword">state</span>。遇到未知的 action 时，一定要返回旧的 <span class="keyword">state</span>。</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>当 action.type变多时，可以按照功能拆分，在通过组合函数合并</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function rootReducer(<span class="keyword">state</span> = &#123;&#125;, action) &#123;</span><br><span class="line">  return &#123;</span><br><span class="line">    films: filmReducer(<span class="keyword">state</span>.films, action),</span><br><span class="line">    filter: filterReducer(<span class="keyword">state</span>.filter, action)</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"> // rootReducer 将不同部分的 <span class="keyword">state</span> 传给对应的 reducer 处理，最终合并所有 reducer 的返回值，组成整个<span class="keyword">state</span>。</span><br><span class="line"> </span><br><span class="line"> //使用Redux 提供的 combineReducers() 方法</span><br><span class="line">import &#123; combineReducers &#125; <span class="keyword">from</span> 'redux'</span><br><span class="line"></span><br><span class="line">var rootReducer = combineReducers(&#123;</span><br><span class="line">    films: filmReducer,</span><br><span class="line">    filter: filterReducer</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line"> //combineReducers() 将调用一系列 reducer，并根据对应的 key 来筛选出 <span class="keyword">state</span> 中的一部分数据给相应的 reducer，这样也意味着每一个小的 reducer 将只能处理 <span class="keyword">state</span> 的一部分数据</span><br></pre></td></tr></table></figure>
<h4 id="Store"><a href="#Store" class="headerlink" title="Store"></a>Store</h4><ul>
<li>衔接action和reducer</li>
</ul>
<p>Store 是单一的,维护着一个全局的 State，并且根<strong>据 Action 来进行事件分发处理 State</strong>,Store 是一个把 Action 和 Reducer 结合起来的对象。</p>
<p>生成store</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;createStore &#125; <span class="keyword">from</span> <span class="string">'redux'</span></span><br><span class="line"></span><br><span class="line">var store = createStore(rootReducer);</span><br></pre></td></tr></table></figure>
<p>store 对象可以简单的理解为如下形式</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStore</span><span class="params">(reducer, initialState)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//闭包私有变量 </span></span><br><span class="line">    <span class="keyword">var</span> currentReducer = reducer;</span><br><span class="line">    <span class="keyword">var</span> currentState = initialState;</span><br><span class="line">    <span class="keyword">var</span> listeners = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> currentState;</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">subscribe</span><span class="params">(listener)</span> </span>&#123;</span><br><span class="line">      listeners.push(listener);</span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">unsubscribe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> index = listeners.indexOf(listener);</span><br><span class="line">        listeners.splice(index, <span class="number">1</span>);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">(action)</span> </span>&#123;</span><br><span class="line">        currentState = currentReducer(currentState, action);</span><br><span class="line">        listeners.slice().<span class="keyword">forEach</span>(listener =&gt; listener());</span><br><span class="line">        <span class="keyword">return</span> action;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//返回一个包含可访问闭包变量的公有方法</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      dispatch,</span><br><span class="line">      subscribe,</span><br><span class="line">      getState</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>store.getState() 用来获取 state 数据。<br>store.subscribe(listener) 用于注册监听函数。每当 state 数据更新时，将会触发监听函数。<br>store.dispatch(action) 是用于将一个 action 对象发送给 reducer 进行处理</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">store</span><span class="class">.dispatch</span>(<span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">type</span>:<span class="value"> <span class="string">'ADD_FILM'</span>,</span><br><span class="line">  name: <span class="string">'Mission: Impossible'</span></span><br><span class="line"></span></span></span>&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h4><ul>
<li>Connect 组件主要为 React 组件提供 store 中的部分 state 数据 及 dispatch 方法</li>
</ul>
<p>通过<strong>import { connect } from ‘react-redux’</strong>将state的值和action绑定到组件的props上</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">import &#123; connect &#125; <span class="keyword">from</span> 'react-redux'</span><br><span class="line">import Counter <span class="keyword">from</span> '../components/Counter' //一个组件</span><br><span class="line">import * as CounterActions <span class="keyword">from</span> '../actions/counter'</span><br><span class="line"></span><br><span class="line">//将<span class="keyword">state</span>.counter绑定到props的counter</span><br><span class="line">// <span class="keyword">state</span> 将由 store 提供</span><br><span class="line">function mapStateToProps(<span class="keyword">state</span>) &#123;</span><br><span class="line">  return &#123;</span><br><span class="line">    counter: <span class="keyword">state</span>.counter</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//将action的所有方法绑定到props上</span><br><span class="line">function mapDispatchToProps(dispatch) &#123;</span><br><span class="line">  return bindActionCreators(CounterActions, dispatch)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//通过react-redux提供的connect方法将我们需要的<span class="keyword">state</span>中的数据和actions中的方法绑定到props上</span><br><span class="line">export <span class="keyword">default</span> connect(mapStateToProps, CounterActions)(Counter)</span><br></pre></td></tr></table></figure>
<h4 id="saga"><a href="#saga" class="headerlink" title="saga"></a>saga</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  takeEvery</span><br><span class="line">&#125; from <span class="string">'redux-saga'</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  call,</span><br><span class="line">  put,</span><br><span class="line">  fork,</span><br><span class="line">  take,</span><br><span class="line">  cancel</span><br><span class="line">&#125; from <span class="string">'redux-saga/effects'</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  GET_LOGINED_REQUEST,</span><br><span class="line">  LOGIN_REQUEST</span><br><span class="line">&#125; from <span class="string">'./login.js'</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  loginAPI,</span><br><span class="line">  loginedAPI</span><br><span class="line">&#125; from <span class="string">'../../../api'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span>* <span class="title">watchRequestLogined</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> takeEvery(GET_LOGINED_REQUEST, queryFlow)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span>* <span class="title">queryFlow</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> task = <span class="keyword">yield</span> fork(logined)</span><br><span class="line">  <span class="keyword">yield</span> take(LOGIN_CANCEL)</span><br><span class="line">  <span class="keyword">yield</span> cancel(task)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span>* <span class="title">logined</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">yield</span> call(loginedAPI)</span><br><span class="line">    <span class="keyword">yield</span> put(&#123;</span><br><span class="line">      <span class="keyword">type</span>: LOGIN_SUCCESS,</span><br><span class="line">      response</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="keyword">yield</span> put(&#123;</span><br><span class="line">      <span class="keyword">type</span>: LOGIN_CANCEL,</span><br><span class="line">      error</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span>* <span class="title">watchRequestLogin</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> takeEvery(LOGIN_REQUEST, loginFlow)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span>* <span class="title">authorize</span>(<span class="params">&#123;account, password&#125;</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">yield</span> call(loginAPI, &#123;</span><br><span class="line">      account,</span><br><span class="line">      password</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">yield</span> put(&#123;</span><br><span class="line">      <span class="keyword">type</span>: LOGIN_SUCCESS,</span><br><span class="line">      response</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="keyword">yield</span> put(&#123;</span><br><span class="line">      <span class="keyword">type</span>: LOGIN_ERROR,</span><br><span class="line">      error</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span>* <span class="title">loginFlow</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; account, password &#125; = action.payload</span><br><span class="line">  <span class="keyword">const</span> task = <span class="keyword">yield</span> fork(authorize, &#123; account, password &#125;)</span><br><span class="line">  <span class="keyword">yield</span> take(LOGIN_CANCEL)</span><br><span class="line">  <span class="keyword">yield</span> cancel(task)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/01/Flux/" itemprop="url">
                  Flux
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-06-01T16:03:51+08:00" content="2016-06-01">
              2016-06-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/前端/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/06/01/Flux/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/06/01/Flux/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="u7B80_u4ECB"><a href="#u7B80_u4ECB" class="headerlink" title="简介"></a>简介</h3><ul>
<li>单向的数据流动</li>
<li>Flux应用主要包括三部分：dispatcher、store和views（React components）</li>
</ul>
<p><img src="/../picture/flux-flow.png" alt="Resize icon"></p>
<h3 id="dispatcher_uFF08_u8C03_u5EA6_u8005_uFF09"><a href="#dispatcher_uFF08_u8C03_u5EA6_u8005_uFF09" class="headerlink" title="dispatcher（调度者）"></a>dispatcher（调度者）</h3><ul>
<li>管理所有的数据流</li>
<li>本质store callback 的注册表，用来向stores分发action，可以指定注册的callback的执行顺序来管理store之间的依赖</li>
</ul>
<h3 id="store_28_u4ED3_u5E93_29"><a href="#store_28_u4ED3_u5E93_29" class="headerlink" title="store(仓库)"></a>store(仓库)</h3><ul>
<li>包含应用的状态和逻辑，管理多个对象状态</li>
<li>在dispatcher注册，并提供相应的回调</li>
<li>更新后向应用广播change事件，view响应并重新获取数据</li>
</ul>
<h3 id="action"><a href="#action" class="headerlink" title="action"></a>action</h3><ul>
<li>dispatcher提供了一个可以允许我们向store中触发分发的方法</li>
</ul>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/支付宝notify-异步通知与https的问题/" itemprop="url">
                  支付宝notify 异步通知与https的问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-05-13T15:36:49+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/支付宝notify-异步通知与https的问题/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/支付宝notify-异步通知与https的问题/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="u95EE_u9898_u548C_u89E3_u51B3_u65B9_u6CD5"><a href="#u95EE_u9898_u548C_u89E3_u51B3_u65B9_u6CD5" class="headerlink" title="问题和解决方法"></a>问题和解决方法</h3><p>在对接支付宝时，发生了这样的问题,使用http链接时，支付宝notify是没有问题的，但换成https后便通知不到了</p>
<p>最可能的问题便是<strong>ssl证书出错</strong>了,注意支付宝不支持自签名证书（<a href="https://doc.open.alipay.com/doc2/detail?treeId=66&amp;articleId=104422&amp;docType=1）" target="_blank" rel="external">https://doc.open.alipay.com/doc2/detail?treeId=66&amp;articleId=104422&amp;docType=1）</a></p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">去这个网站检测下你的<span class="constant">CSR</span>吧</span><br><span class="line"><span class="symbol">https:</span>/<span class="regexp">/cryptoreport.websecurity.symantec.com/checker</span><span class="regexp">/views/csr</span>Check.jsp</span><br></pre></td></tr></table></figure>
<h3 id="u4E8B_u60C5_u7ECF_u8FC7"><a href="#u4E8B_u60C5_u7ECF_u8FC7" class="headerlink" title="事情经过"></a>事情经过</h3><p>某天，同事们偷偷给网站加了安全套接字，把http换成了https,于是我负责的支付模块就出错了。</p>
<p>一开始，我就简单改了config,提交给支付宝的notify_url改成了https。本以为就没问题了，但在我又付出了￥0.01的巨款后，发现支付宝还是没有通知过来。。然后就懵逼了</p>
<p><img src="/../picture/懵逼.jpg" alt="Smaller icon"></p>
<p>懵逼了大概7.8秒后，我就去百度了一下、、、我居然去百度了一下。有人说原因是:</p>
<blockquote>
<p>支付宝对ssl证书也有检查，而那种免费的ssl证书通不过检查。后来没办法就只好改成http notify了 </p>
</blockquote>
<p>好吧。。。这种解决方法，这尼玛根本就不是个解决方案、</p>
<p>注：俺们公司用的CA是GeoTrust,不是他们说的免费证书。顺带感叹下做CA真赚钱</p>
<p>于是又去问支付宝客服，给了他交易号，让他帮我查了下日志,就是这样的<br><img src="/../picture/alipaylog.png" alt="Smaller icon"></p>
<p>http状态码是0耶。看来支付宝确实没有去访问我们的服务器嘛。看来确实在ssl证书检查这块了，但还不清楚是什么问题，还是问问Google吧~（推荐翻墙工具：<a href="http://www.ishadowsocks.net）" target="_blank" rel="external">http://www.ishadowsocks.net）</a></p>
<p>Google帮我搜到了支付宝的这个<a href="https://doc.open.alipay.com/doc2/detail?treeId=66&amp;articleId=104422&amp;docType=1页面(别问我为什么之前没看到。。支付宝文档太多了，我有点眼花),其中对异步通知是这么说的：" target="_blank" rel="external">https://doc.open.alipay.com/doc2/detail?treeId=66&amp;articleId=104422&amp;docType=1页面(别问我为什么之前没看到。。支付宝文档太多了，我有点眼花),其中对异步通知是这么说的：</a></p>
<blockquote>
<p>需确认页面是http还是https，如果是https，那么需要安装ssl证书，证书要求有如下：<br>要求“正规的证书机构签发，不支持自签名”，如果不理解请咨询证书供应商。<br>域名证书检测地址参考：<a href="https://cryptoreport.websecurity.symantec.com/checker/" target="_blank" rel="external">https://cryptoreport.websecurity.symantec.com/checker/</a></p>
</blockquote>
<p>然后就拿着csr去检测了。。靠，果然有鬼（毕竟不是我写的）~~然后改好重新部署</p>
<p>再付出巨款做测试，终于等来支付宝敲门啦</p>
<h3 id="u4E8B_u6545_u603B_u7ED3"><a href="#u4E8B_u6545_u603B_u7ED3" class="headerlink" title="事故总结"></a>事故总结</h3><p>不能说是事故，，因为网站还在测试阶段。。否则，我就该引咎辞职了（宝宝心里苦啊、、）</p>
<ol>
<li>仔细看文档 </li>
<li>不要用百度</li>
</ol>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/openssl生成ssl证书及向申请CA流程/" itemprop="url">
                  openssl生成ssl证书及向申请CA流程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-05-13T10:57:49+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/openssl生成ssl证书及向申请CA流程/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/openssl生成ssl证书及向申请CA流程/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="u751F_u6210key"><a href="#u751F_u6210key" class="headerlink" title="生成key"></a>生成key</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -des3 -out prvtkey<span class="class">.pem</span> <span class="number">2048</span> </span><br><span class="line">或者无密码保护的</span><br><span class="line">openssl genrsa -out prvtkey<span class="class">.pem</span> <span class="number">2048</span></span><br></pre></td></tr></table></figure>
<h3 id="u751F_u6210-csr_28_u7528_u8FD9_u4E2A_u5411_u6570_u5B57_u8BC1_u4E66_u9881_u53D1_u673A_u6784_uFF08_u5373CA_uFF09_u7533_u8BF7_u4E00_u4E2A_u6570_u5B57_u8BC1_u4E66_29"><a href="#u751F_u6210-csr_28_u7528_u8FD9_u4E2A_u5411_u6570_u5B57_u8BC1_u4E66_u9881_u53D1_u673A_u6784_uFF08_u5373CA_uFF09_u7533_u8BF7_u4E00_u4E2A_u6570_u5B57_u8BC1_u4E66_29" class="headerlink" title="生成.csr(用这个向数字证书颁发机构（即CA）申请一个数字证书)"></a>生成.csr(用这个向数字证书颁发机构（即CA）申请一个数字证书)</h3><figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -<span class="keyword">new</span> -key prvtkey.pem -<span class="keyword">out</span> cert.csr</span><br></pre></td></tr></table></figure>
<p>然后填写信息，注意<strong>Common Name (eg, your websites domain name)</strong>，要填写网站域名,如:pay.abc.com</p>
<p>生成的.csr文件是否规范可以在这检测：<br><a href="https://cryptoreport.websecurity.symantec.com/checker/views/csrCheck.jsp" target="_blank" rel="external">https://cryptoreport.websecurity.symantec.com/checker/views/csrCheck.jsp</a></p>
<p>然后向CA申请数字证书，再用CA给的cacert.pem替换原来的prvtkey.pem</p>
<h3 id="u81EA_u5EFACA"><a href="#u81EA_u5EFACA" class="headerlink" title="自建CA"></a>自建CA</h3><p><a href="http://www.cnblogs.com/AloneSword/p/3809002.html" target="_blank" rel="external">http://www.cnblogs.com/AloneSword/p/3809002.html</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/12/js中一堆凌乱的小知识/" itemprop="url">
                  js中一堆凌乱的小知识
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-05-12T11:34:45+08:00" content="2016-05-12">
              2016-05-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/12/js中一堆凌乱的小知识/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/12/js中一堆凌乱的小知识/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h4 id="setTimeout_clearTimeout"><a href="#setTimeout_clearTimeout" class="headerlink" title="setTimeout clearTimeout"></a>setTimeout clearTimeout</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">var</span> timer=setTimeout</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">clearTimeout</span><span class="params">(timer)</span></span></span><br></pre></td></tr></table></figure>
<h4 id="u6570_u7EC4_u6DF1_u62F7_u8D1D"><a href="#u6570_u7EC4_u6DF1_u62F7_u8D1D" class="headerlink" title="数组深拷贝"></a>数组深拷贝</h4><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a=[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line">b=a.slice(<span class="number">0</span>,[<span class="keyword">end</span>])</span><br><span class="line">slice 方法返回一个 <span class="keyword">Array</span> 对象</span><br><span class="line"></span><br><span class="line">slice 方法一直复制到 <span class="keyword">end</span> 所指定的元素</span><br><span class="line">b=a.<span class="keyword">concat</span>();</span><br></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="http://www.wmtcore.com/uploads/avatar.png" alt="WMT" itemprop="image"/>
          <p class="site-author-name" itemprop="name">WMT</p>
        </div>
        <p class="site-description motion-element" itemprop="description">不扯犊子 -NOT ALONE</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">42</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">14</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">16</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/WMTcore" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015-12 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WMT</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"wmtcore"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     


    
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  

  
  

</body>
</html>
