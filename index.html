<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






  <meta name="baidu-site-verification" content="SoMgkf0fOF" />







  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="WMTcore" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="不扯犊子 -NOT ALONE">
<meta property="og:type" content="website">
<meta property="og:title" content="大碗拉面">
<meta property="og:url" content="https://www.wmtcore.com/index.html">
<meta property="og:site_name" content="大碗拉面">
<meta property="og:description" content="不扯犊子 -NOT ALONE">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="大碗拉面">
<meta name="twitter:description" content="不扯犊子 -NOT ALONE">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> 大碗拉面 </title>
</head>

<body itemscope itemtype="https://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="https://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="https://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?fd1a09a8302af22bf35f067279757d54";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="https://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">大碗拉面</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
      
        <li class="menu-item menu-item-search">
          <a href="#" class="st-search-show-outputs">
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'hXvPsMvt_RLywgyzUhtE','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">

    

    
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/10/21/数组间取交集优化-二分查找 /" itemprop="url">
                  数组间取交集优化-二分查找
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2020-10-21T18:24:30+08:00" content="2020-10-21">
              2020-10-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/工作日常/" itemprop="url" rel="index">
                    <span itemprop="name">工作日常</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/10/21/数组间取交集优化-二分查找 /#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/10/21/数组间取交集优化-二分查找 /" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h3><p>业务：下单时，手术类型中的商品需要与授权商品取交集过滤，剩下的商品才能返回给前端展示</p>
<p>难点：某些大客户手术类型数量有<strong>两百</strong>多，每个又包含<strong>数百</strong>商品，需要和<strong>多达十万</strong>的商品循环做取交集运算</p>
<p>问题：原先使用的lodash的intersection方法循环每个手术类型取交集,在技术用户德高的手术类型时<strong>需要耗时2500ms</strong></p>
<p>设手术类型*商品数量为G,授权商品数量为N,当前时间复杂度为<code>GN</code></p>
<h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><p>使用二分法查找：先确定待查数据的范围，然后逐步缩小范围直到找到或找不到该记录为止，需要先将数组排序</p>
<h4 id="有序数组"><a href="#有序数组" class="headerlink" title="有序数组"></a>有序数组</h4><p>先将授权商品排序,使用快速排序（NlogN），再用二分查找搜索商品(logN)</p>
<p>合计时间复杂度为<code>NlogN+GlogN</code>，减去原先<code>N*G</code>得到<code>NlogN+(logN-N)*G</code>所以N,G越大时优化效果越明显</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">function</span> searchSortArray(sortArray,val)&#123;</div><div class="line">  <span class="keyword">function</span> handle(<span class="built_in">left</span>, <span class="built_in">right</span>) &#123;</div><div class="line">    <span class="keyword">if</span> (<span class="built_in">left</span> &gt; <span class="built_in">right</span>)&#123;</div><div class="line">      return <span class="literal">false</span>;</div><div class="line">    &#125; </div><div class="line">    <span class="keyword">const</span> <span class="built_in">mid</span> = Math.floor((<span class="built_in">left</span> + <span class="built_in">right</span> ) / <span class="number">2</span>);</div><div class="line">    <span class="keyword">const</span> midVal = sortArray[<span class="built_in">mid</span>];</div><div class="line">    <span class="keyword">if</span>(midVal===val)&#123;</div><div class="line">      return <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(midVal&gt;val)&#123;</div><div class="line">      return handle(<span class="built_in">left</span>,<span class="built_in">mid</span><span class="number">-1</span>)</div><div class="line">    &#125;</div><div class="line">    return handle(<span class="built_in">mid</span>+<span class="number">1</span>,<span class="built_in">right</span>)</div><div class="line">  &#125;</div><div class="line">  return handle(<span class="number">0</span>, sortArray.length - <span class="number">1</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="二叉搜索树-BST"><a href="#二叉搜索树-BST" class="headerlink" title="二叉搜索树(BST)"></a>二叉搜索树(BST)</h5><ul>
<li>BST：根节点的值大于其左子树中任意一个节点的值，小于其右节点中任意一节点的值</li>
</ul>
<p>有序数组在计算时，每次都要计算一次中间值(logN)，使用BST能省掉这次计算</p>
<p>再排序的基础上构建一个二叉搜索树（N）,再检索二叉树(logN)</p>
<p>所以原先的有序数组时间复杂度为 <code>NlogN+2GlogN</code>,二叉树的时间复杂度为<code>NlogN+GlogN+N</code>,相减得到<code>GlogN-N</code>,<strong>当G较大时使用BST效果好</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 二叉树结构</span></div><div class="line">function TreeNode(<span class="keyword">val</span>, left, right) &#123;</div><div class="line">  <span class="keyword">this</span>.<span class="keyword">val</span> = (<span class="keyword">val</span> === undefined ? <span class="number">0</span> : <span class="keyword">val</span>);</div><div class="line">  <span class="keyword">this</span>.left = (left === undefined ? <span class="literal">null</span> : left);</div><div class="line">  <span class="keyword">this</span>.right = (right === undefined ? <span class="literal">null</span> : right);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 有序数组转BST</span></div><div class="line">function arrayToBST(sortArray) &#123;</div><div class="line">  function handle(left, right) &#123;</div><div class="line">    <span class="keyword">if</span> (left &gt; right)&#123;</div><div class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">    &#125; </div><div class="line">    const mid = Math.floor((left + right ) / <span class="number">2</span>);</div><div class="line">    const root = new TreeNode(sortArray[mid]);</div><div class="line">    root.left = handle(left, mid - <span class="number">1</span>);</div><div class="line">    root.right = handle(mid + <span class="number">1</span>, right);</div><div class="line">    <span class="keyword">return</span> root;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> handle(<span class="number">0</span>, sortArray.length - <span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 检索BST</span></div><div class="line">function searchBST(BST, <span class="keyword">val</span>) &#123;</div><div class="line">  <span class="keyword">if</span> (!BST) <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">val</span> === BST.<span class="keyword">val</span>) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">val</span> &lt; BST.<span class="keyword">val</span>) &#123;;</div><div class="line">    <span class="keyword">return</span> searchBST(BST.left, <span class="keyword">val</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> searchBST(BST.right, <span class="keyword">val</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><p>在使用BST优化后时间降为<strong>480ms</strong>,比原先快了5倍,效果显著</p>
<p>在实际业务处理中要对商品数量做<strong>判断后再选择合适的算法</strong></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/09/08/问题排查与系统优化/" itemprop="url">
                  问题排查与系统优化
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2020-09-08T13:40:53+08:00" content="2020-09-08">
              2020-09-08
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/方法论/" itemprop="url" rel="index">
                    <span itemprop="name">方法论</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/09/08/问题排查与系统优化/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/09/08/问题排查与系统优化/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h2><h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><ul>
<li>逻辑缺陷：e.g. NPE、死循环、边界情况未覆盖。、</li>
<li>性能瓶颈：e.g. 接口 RT 陡增、吞吐率上不去。</li>
<li>内存异常：e.g. GC 卡顿、频繁 FGC、内存泄露、OOM</li>
<li>并发/分布式：e.g. 存在竞争条件、时钟不同步。</li>
<li>数据问题：e.g. 出现脏数据、序列化失败。</li>
<li>安全问题：e.g. DDoS 攻击、数据泄露。</li>
<li>环境故障：e.g. 宿主机宕机、网络不通、丢包。</li>
<li>操作失误：e.g. 配置推错、删库跑路（危险动作，请勿尝试..）。</li>
</ul>
<h3 id="排查流程"><a href="#排查流程" class="headerlink" title="排查流程"></a>排查流程</h3><h4 id="快速修复"><a href="#快速修复" class="headerlink" title="快速修复"></a>快速修复</h4><ul>
<li>发布期间开始报错，且发布前一切正常？ 先回滚再说，恢复正常后再慢慢排查</li>
<li>应用已经稳定运行很长一段时间，突然开始出现进程退出现象？很可能是内存泄露，默默上重启大法吧</li>
<li>只有少数固定机器报错？试试隔离这部分机器（关闭流量入口）。</li>
<li>单用户流量突增导致服务不稳定？如果不是惹不起的金主爸爸，请勇敢推送限流规则。</li>
<li>下游依赖挂了导致服务雪崩？还想什么呢，降级预案走起。</li>
</ul>
<h4 id="保留现场"><a href="#保留现场" class="headerlink" title="保留现场"></a>保留现场</h4><ul>
<li>隔离一两台机器：将这部分机器入口流量关闭，让它们静静等待你的检阅。</li>
<li>Dump 应用快照：常用的快照类型一般就是线程堆栈和堆内存映射。</li>
</ul>
<p>所有机器都回滚了，咋办？别慌，如果你的应用监控运维体系足够健全，那么你还有多维度的历史数据可以回溯：应用日志、中间件日志、GC 日志、内核日志、Metrics 指标等。</p>
<h4 id="定位原因"><a href="#定位原因" class="headerlink" title="定位原因"></a>定位原因</h4><ul>
<li><p>关联近期变更：90% 以上的线上问题都是由变更引发，这也是为什么集团安全生产的重点一直是在管控“变更”。所以，先不要急着否认（“肯定不是我刚加的那行代码问题！”），相信统计学概率，好好 review 下近期的变更历史（从近至远）。</p>
</li>
<li><p>全链路追踪分析：微服务和中台化盛行的当下，一次业务请求不经过十个八个应用处理一遍，都不好意思说自己是写 Java 的。所以，不要只盯着自己的应用不放，你需要把排查 scope 放大到全链路。</p>
</li>
<li><p>还原事件时间线：请把自己想象成福尔摩斯（柯南也行），摆在你面前的就是一个案发现场，你需要做的是把不同时间点的所有事件线索都串起来，重建和还原整个案发过程。要相信，时间戳是不会骗人的。</p>
</li>
<li><p>找到 Root Cause：排查问题多了你会发现，很多疑似原因往往只是另一个更深层次原因的表象结果之一。作为福尔摩斯，你最需要找到的是幕后凶手，而不是雇佣的杀人犯 —— 否则 TA 还会雇人再来一次。</p>
</li>
<li><p>尝试复现问题：千辛万苦推导出了根因，也不要就急着开始修 bug 了。如果可以，最好能把问题稳定复现出来，这样才更有说服力。这里提醒一点：可千万别在生产环境干这事（除非你真的 know what you’re doing），否则搞不好就是二次伤害（你：哈哈哈，你看，这把刀当时就是从这个角度捅进去的，轨迹完全一样。用户：…）。</p>
</li>
</ul>
<h4 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题"></a>解决问题</h4><ul>
<li><p>修复也是一种变更，需要经过完整的回归测试、灰度发布；切忌火急火燎上线了 bugfix，结果引发更多的 bugs to fix。</p>
</li>
<li><p>修复发布后，一定要做线上验证，并且保持观察一段时间，确保是真的真的修复了。</p>
</li>
<li><p>最后，如果问题已经上升到了故障这个程度，那就拉上大伙好好做个故障复盘吧。整个处理过程一定还有提升空间，你的经验教训对其他同学来说也是一次很好的输入和自查机会：幸福总是相似的，故障也是。</p>
</li>
</ul>
<h3 id="排查⼯具"><a href="#排查⼯具" class="headerlink" title="排查⼯具"></a>排查⼯具</h3><p>日志（Logging）、监控（Metrics）、追踪（Tracing）</p>
<h2 id="系统优化"><a href="#系统优化" class="headerlink" title="系统优化"></a>系统优化</h2><ul>
<li>系统优化的三个基本方向：性能（Performance）、稳定性（Stability）、可维护性（Maintainability）。三者之间并不是完全独立的，而是存在着复杂的相互作用关系，有时甚至会此消彼长。</li>
</ul>
<h3 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h3><h4 id="性能指标"><a href="#性能指标" class="headerlink" title="性能指标"></a>性能指标</h4><p>指标（Indicators）是衡量一件事物好坏的科学量化手段。对于性能而言，一般会使用如下指标评估：</p>
<ul>
<li><p>吞吐率（Throughput）：系统单位时间内能处理的工作负载，例如：在线 Web 系统 - QPS/TPS，离线数据分析系统 - 每秒处理的数据量。</p>
</li>
<li><p>响应时间（Response Time）：以  Web 请求处理为例，响应时间（RT）即请求从发出到收到的往返时间，一般会由网络传输延迟、排队延迟和实际处理耗时几个部分共同组成。</p>
</li>
<li><p>可伸缩性（Scalability）：系统通过增加机器资源（垂直/水平）来承载更多工作负载的能力；投入产出比越高（理想情况是线性伸缩），则说明系统的可伸缩性越好。</p>
</li>
</ul>
<p>此外，同一个系统的吞吐率与响应时间，一般还会存在如下关联关系：吞吐率小于某个临界值时，响应时间几乎不变；一旦超出这个临界值，系统将进入超载状态（overloaded），响应时间开始线性增长。对于一个有稳定性要求的系统，需要在做性能压测和容量规划时充分考虑这个临界值的大小。</p>
<h4 id="性能分析"><a href="#性能分析" class="headerlink" title="性能分析"></a>性能分析</h4><p>坚持 2/8 原则：优先分析和优化系统瓶颈，即当前对系统性能影响最大的原子操作；他们很可能就是 ROI 最高的优化点。</p>
<p>系统层面：tsar、top、iostat、vmstat<br>网络层面：iftop、tcpdump、wireshark<br>数据库层面：SQL explain、CloudDBA<br>应用代码层面：JProfiler、Arthas、jstack</p>
<p>其中很多工具也是问题排查时常用的诊断工具；毕竟，无论是性能分析还是诊断分析，目的都是去理解一个系统和他所处的环境，所需要做的事情都是相似的。</p>
<h4 id="优化原则"><a href="#优化原则" class="headerlink" title="优化原则"></a>优化原则</h4><p>性能优化与做功能需求一样，都是为业务服务的，因此优化时千万不要忙着自嗨，一定要结合目标需求和应用场景 —— 也许这块你想做的优化，压根线上就碰不到；也许那块很难做的优化，可以根据流量特征做非通用的定制优化</p>
<p>你不应该做的：即老生常谈的提前优化（Premature-optimization）与过度优化（Over-optimization） —— 通常而言（并不绝对），性能优化都不是免费的午餐，优化做的越多，往往可维护性也会越差。</p>
<h5 id="优化手段"><a href="#优化手段" class="headerlink" title="优化手段"></a>优化手段</h5><h6 id="简化"><a href="#简化" class="headerlink" title="简化"></a>简化</h6><ul>
<li>业务层面：e.g. 流程精简、需求简化。</li>
<li>编码层面：e.g. 循环内减少高开销操作。</li>
<li>架构层面：e.g. 减少没必要的抽象/分层。</li>
<li>数据层面：e.g. 数据清洗、提取、聚合。</li>
</ul>
<h6 id="并行"><a href="#并行" class="headerlink" title="并行"></a>并行</h6><p>方式：单机并行（多线程）、多机并行（分布式）。</p>
<p>优点：充分利用机器资源（多核、集群）。</p>
<p>缺点：同步开销、线程开销、数据倾斜。</p>
<p>同步优化：乐观锁、细粒度锁、无锁。<br>线程替代（如协程：Java WISP、Go routines、Kotlin coroutines）。<br>数据倾斜：负载均衡（Hash / RR / 动态）</p>
<h6 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h6><p>方式：消息队列 + 任务线程 + 通知机制。</p>
<p>优点：提升吞吐率、组件解耦、削峰填谷。</p>
<p>缺点：排队延迟（队列积压）。</p>
<p>避免过度积压：Back-pressure（Reactive思想）。</p>
<h6 id="批量"><a href="#批量" class="headerlink" title="批量"></a>批量</h6><p>有些事，你可以合起来一起做。</p>
<p>方式：多次单一操作 → 合并为单次批量操作。</p>
<p>案例：TCP Nagel 算法；DB 的批量读写接口。</p>
<p>优点：避免单次操作的固有开销，均摊后总开销更低。</p>
<p>缺点：等待延迟 + 聚合延迟。</p>
<p>减少等待延迟：Timeout 触发提交，控制延迟上限。</p>
<h6 id="时间空间互换"><a href="#时间空间互换" class="headerlink" title="时间空间互换"></a>时间空间互换</h6><p>游戏的本质：要么有闲，要么有钱。</p>
<p>空间换时间：避免重复计算、拉近传输距离、分流减少压力。</p>
<p>案例：缓存、CDN、索引、只读副本（replication）。</p>
<p>时间换空间：有时候也能达到“更快”的效果（数据量减少 → 传输时间减少）。</p>
<p>案例：数据压缩（HTTP/2 头部压缩、Bitmap）。</p>
<h6 id="数据结构与算法优化"><a href="#数据结构与算法优化" class="headerlink" title="数据结构与算法优化"></a>数据结构与算法优化</h6><p>程序 = 数据结构 + 算法</p>
<p>多了解一些“冷门”的数据结构 ：Skip list、Bloom filter、Time Wheel 等。</p>
<p>一些“简单”的算法思想：递归、分治、贪心、动态规划。</p>
<h6 id="池化-amp-局部化"><a href="#池化-amp-局部化" class="headerlink" title="池化 &amp; 局部化"></a>池化 &amp; 局部化</h6><p>共享经济 &amp; 小区超市</p>
<p>池化（Pooling）：减少资源创建和销毁开销。</p>
<p>案例：线程池、内存池、DB 连接池、Socket 连接池。</p>
<p>局部化（Localization）：避免共享资源竞争开销。</p>
<p>案例：TLB（ThreadLocalBuffer）、多级缓存（本地局部缓存 -&gt; 共享全局缓存）。</p>
<h6 id="更多优化手段"><a href="#更多优化手段" class="headerlink" title="更多优化手段"></a>更多优化手段</h6><p>升级红利：内核、JRE、依赖库、协议。<br>调参大师：配置、JVM、内核、网卡。<br>SQL 优化：索引、SELECT *、LIMIT 1。<br>业务特征定制优化：e.g. 凌晨业务低峰期做日志轮转。<br>Hybrid 思想（优点结合）：JDK sort() 实现、Weex/RN。</p>
<h3 id="稳定性优化"><a href="#稳定性优化" class="headerlink" title="稳定性优化"></a>稳定性优化</h3><p>稳定是相对的，业务规模越大、场景越复杂，系统越容易出现不稳定，且带来的影响也越严重</p>
<h4 id="衡量指标"><a href="#衡量指标" class="headerlink" title="衡量指标"></a>衡量指标</h4><p>定义服务的可用跟业务相关，越是底层的基础设施，可用性要求就越高</p>
<p>定义服务的可用性：服务总的可用/不可用比例（服务时长 or 服务次数），监测和量化一个系统的稳定性</p>
<p>可用性：</p>
<ul>
<li>服务可访问： 接口返回200 OK</li>
<li>性能可接受： 99%的请求RT&lt;50ms</li>
</ul>
<p>商业化指标：</p>
<ul>
<li>SLI:</li>
<li>SLO:</li>
<li>SLA:</li>
</ul>
<h4 id="可用性测量"><a href="#可用性测量" class="headerlink" title="可用性测量"></a>可用性测量</h4><p><code>探针模拟</code>: 从客户端侧，模拟用户的调用行为</p>
<ul>
<li>优点：数据真实（客户端角度）</li>
<li>缺点：数据不全面（单一客户数据）</li>
</ul>
<p><code>服务端采集</code>: 从服务端侧，直接分析日志和数据</p>
<ul>
<li>优点：覆盖所有调用数据</li>
<li>缺点：缺失客户端链路数据</li>
</ul>
<h4 id="稳定性优化原则"><a href="#稳定性优化原则" class="headerlink" title="稳定性优化原则"></a>稳定性优化原则</h4><p>关注 RT 的数据分布（如：p50/p99/p999 分位点）,不要尝试承诺和优化可用性到 100%</p>
<h5 id="稳定性优化手段"><a href="#稳定性优化手段" class="headerlink" title="稳定性优化手段"></a>稳定性优化手段</h5><h6 id="避免单点"><a href="#避免单点" class="headerlink" title="避免单点"></a>避免单点</h6><ul>
<li>集群部署</li>
<li>数据副本</li>
<li>多机房容灾</li>
</ul>
<p>只堆量不够，还需要具备故障转移能力（Failover）。</p>
<p>接入层：DNS、VipServer、SLB。</p>
<p>服务层：服务发现 + 健康检查 + 剔除机制。</p>
<p>应用层：无状态设计（Stateless），便于随时和快速切换。</p>
<h6 id="流控-限流"><a href="#流控-限流" class="headerlink" title="流控/限流"></a>流控/限流</h6><p>类型：QPS 流控、并发度流控。</p>
<p>工具：RateLimiter、信号量、Sentinel。</p>
<p>粒度：全局、用户级、接口级。</p>
<p>热点流控：避免意料之外的突增流量。</p>
<h6 id="熔断"><a href="#熔断" class="headerlink" title="熔断"></a>熔断</h6><p>目的：防止连锁故障（雪崩效应）,及时止损</p>
<p>工具：Hystrix、Failsafe、Resilience4j。</p>
<p>功能：自动绕开异常服务并检测恢复状态。</p>
<p>流程：关闭 → 打开 → 半开。</p>
<h6 id="降级"><a href="#降级" class="headerlink" title="降级"></a>降级</h6><p>触发原因：流控、熔断、负载过高。</p>
<p>常见降级方式：</p>
<p>关闭非核心功能：停止应用日志打印</p>
<p>牺牲数据时效性：返回缓存中旧数据</p>
<p>牺牲数据精确性：降低数据采样频率</p>
<h6 id="超时-重试"><a href="#超时-重试" class="headerlink" title="超时/重试"></a>超时/重试</h6><p>超时：避免调用端陷入永久阻塞。</p>
<p>超时时间设置：全链路自上而下规划</p>
<p>Timeout vs. Deadline：使用绝对时间会更好</p>
<p>重试：确保可重试操作的幂等性。</p>
<p>消息去重</p>
<p>异步重试</p>
<p>指数退避</p>
<h6 id="资源设限"><a href="#资源设限" class="headerlink" title="资源设限"></a>资源设限</h6><p>目的：防止资源被异常流量耗尽</p>
<p>资源类型：线程、队列、DB 连接</p>
<p>设限方式：资源池化、有界队列</p>
<p>超限处理：返回 ServiceUnavailable / QuotaExceeded</p>
<h6 id="资源隔离"><a href="#资源隔离" class="headerlink" title="资源隔离"></a>资源隔离</h6><p>目的：防止资源被部分异常流量耗尽；为 VIP 客户提供服务质量保证（QoS）。</p>
<p>隔离方式：队列划分、独立集群；注意处理优先级和资源分配比例。</p>
<h6 id="安全生产"><a href="#安全生产" class="headerlink" title="安全生产"></a>安全生产</h6><p>程序动态性：开关、配置、热升级。</p>
<p>Switch：类型安全；侵入性小。</p>
<p>审核机制：代码 Review、发布审批。</p>
<p>灰度发布；分批部署；回滚预案。</p>
<p>DUCT：自动/手动调整 HSF 节点权重。</p>
<h3 id="可维护性优化"><a href="#可维护性优化" class="headerlink" title="可维护性优化"></a>可维护性优化</h3><p>相比性能和稳定性而言，可维护性所体现的价值往往是最长远、但也最难在短期内可兑现的</p>
<ul>
<li><p>软件生命周期：维护周期 &gt;&gt; 开发周期。</p>
</li>
<li><p>破窗效应、熵增定律：可维护性会趋向于越来越差。</p>
</li>
<li><p>遗留系统的危害：理解难度，修改成本，变更风险；陷入不断踩坑、填坑、又挖坑的循环。</p>
</li>
</ul>
<h4 id="可维护性衡量指标"><a href="#可维护性衡量指标" class="headerlink" title="可维护性衡量指标"></a>可维护性衡量指标</h4><ul>
<li>复杂度（Complexity）：是否复杂度可控？</li>
</ul>
<p>编码：简洁度、命名一致性、代码行数等。</p>
<p>架构：组件耦合度、层次清晰度、职责单一性等。</p>
<ul>
<li>可扩展性（Extensibility）：是否易于变更？</li>
</ul>
<p>需要变更代码或配置时，是否简单优雅、不易出错。</p>
<ul>
<li>可运维性（Operability）：是否方便运维？</li>
</ul>
<p>日志、监控是否完善；部署、扩容是否容易。</p>
<h4 id="可维护性优化原则"><a href="#可维护性优化原则" class="headerlink" title="可维护性优化原则"></a>可维护性优化原则</h4><ul>
<li>遵循 KISS 原则、DRY 原则、各种代码可读性和架构设计原则</li>
<li>不应该引入过多临时性、Hack 代码；功能 Work 就 OK，欠一堆技术债</li>
</ul>
<h4 id="可维护性优化手段"><a href="#可维护性优化手段" class="headerlink" title="可维护性优化手段"></a>可维护性优化手段</h4><h5 id="编码规范"><a href="#编码规范" class="headerlink" title="编码规范"></a>编码规范</h5><p>编码：推荐《Java 开发手册》，另外也推荐 The Art of Readable Code 这本书。ESLint</p>
<p>日志：无盲点、无冗余、TraceID。</p>
<p>测试：代码覆盖度、自动化回归。</p>
<h5 id="代码重构"><a href="#代码重构" class="headerlink" title="代码重构"></a>代码重构</h5><p>何时重构：任何时候代码中嗅到坏味道（bad smell）。</p>
<p>重构节奏：小步迭代、回归验证。</p>
<p>重构 vs. 重写：需要综合考虑成本、风险、并行版本维护等因素。</p>
<h5 id="数据驱动"><a href="#数据驱动" class="headerlink" title="数据驱动"></a>数据驱动</h5><p>系统数据：监控覆盖、Metrics 采集等，对于理解系统、排查问题至关重要。</p>
<p>业务数据：一致性校验、旧数据清理等；要相信，数据往往比代码要活得更久。</p>
<h5 id="技术演进"><a href="#技术演进" class="headerlink" title="技术演进"></a>技术演进</h5><p>需要综合评估风险、生产力、学习成本。</p>
<p>当前方向：微服务化、容器化。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/09/05/分布式锁/" itemprop="url">
                  分布式锁
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2020-09-05T16:35:36+08:00" content="2020-09-05">
              2020-09-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/中间件/" itemprop="url" rel="index">
                    <span itemprop="name">中间件</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/09/05/分布式锁/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/09/05/分布式锁/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>当共享资源自身无法提供互斥能力的时候，为了避免多机器<strong>同时读写访问造成数据破坏</strong>，就需要一个第三方服务提供互斥锁，<strong>获取到锁的机器就可以排他性的访问共享资源</strong>，这样的服务我们统称为分布式锁服务，锁也就叫分布式锁</p>
<p>锁 = 资源 + 并发控制 + 所有权展示</p>
<h3 id="分布式锁的分类"><a href="#分布式锁的分类" class="headerlink" title="分布式锁的分类"></a>分布式锁的分类</h3><h4 id="异步复制"><a href="#异步复制" class="headerlink" title="异步复制"></a>异步复制</h4><ul>
<li>基于异步复制的分布式系统，例如 mysql，tair，redis 等</li>
</ul>
<p><strong>存在数据丢失（丢锁）的风险</strong>，不够安全，往往通过 TTL 的机制承担细粒度的锁服务</p>
<p>该系统<strong>接入简单</strong>，适用于对时间很敏感，期望设置一个较短的有效期，执行短期任务，丢锁对业务影响相对可控的服务</p>
<h4 id="一致性协议"><a href="#一致性协议" class="headerlink" title="一致性协议"></a>一致性协议</h4><ul>
<li>基于 paxos 协议的分布式一致性系统，例如 zookeeper，etcd，consul 等</li>
</ul>
<p>通过一致性协议保证数据的多副本，数据安全性高，往往通过租约（会话）的机制承担粗粒度的锁服务</p>
<p>该系统<strong>需要一定的门槛</strong>，适用于对安全性很敏感，<strong>希望长期持有锁，不期望发生丢锁现象</strong>的服务</p>
<h3 id="分布式锁的实践"><a href="#分布式锁的实践" class="headerlink" title="分布式锁的实践"></a>分布式锁的实践</h3><p>提升分布式锁使用时的正确性、保证锁的可用性以及提升锁的切换效率<br>x</p>
<h4 id="互斥性"><a href="#互斥性" class="headerlink" title="互斥性"></a>互斥性</h4><p><strong>每把锁都和唯一的会话绑定</strong>，客户端通过定期<strong>发送心跳来保证会话的有效性</strong>，也就保证了锁的拥有权。当心跳不能维持时，会话连同关联的锁节点都会被释放，锁节点就可以被重新抢占</p>
<p>全局锁服务提供全局自增的 token，Client 1 拿到锁返回的 token 是 33，并带入存储系统，发生 GC，当 Client 2 抢锁成功返回 34，带入存储系统，存储系统会拒绝 token 较小的请求，那么经过了长时间 full gc 重新恢复后的 Client 1 再次写入数据的时候，因为存储层记录的 token 已经更新，携带 token 值为 33 的请求将被直接拒绝，从而达到了数据保护的效果（像paxos中通过提案）</p>
<h4 id="可用性"><a href="#可用性" class="headerlink" title="可用性"></a>可用性</h4><p>通过持续心跳来保证锁的健壮性</p>
<p>处理异常的用户进程持续占据锁: 会话加黑机制，不再维护心跳，最终导致会话过期。</p>
<p>不能强制删除锁：</p>
<ol>
<li><p>删除锁操作本身不安全，如果锁已经被其他人正常抢占，此时删锁请求会产生误删除。</p>
</li>
<li><p>删除锁后，持有锁的人会话依然正常，它仍然认为自己持有锁，会打破锁的互斥性原则。</p>
</li>
</ol>
<h4 id="切换效率"><a href="#切换效率" class="headerlink" title="切换效率"></a>切换效率</h4><p>当进程持有的锁需要被重新调度时，持有者可以主动删除锁节点</p>
<p>但当持有者发生异常(如进程重启，机器宕机等)，新的进程要重新抢占，就需要等待原先的会话过期后，才有机会抢占成功</p>
<ol>
<li><p>要提升切换精度，本质上要压缩会话生命周期，同时也意味着更快的心跳频率</p>
</li>
<li><p>守护进程发现锁持有进程挂掉的场景，提供锁的 CAS 释放操作，使得进程可以零等待进行抢锁，比如利用在锁节点中存放进程的唯一标识，强制释放已经不再使用的锁，并重新争抢</p>
</li>
</ol>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/09/01/es数据被黑事件记录和处理/" itemprop="url">
                  es数据被黑事件记录和处理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2020-09-01T18:44:00+08:00" content="2020-09-01">
              2020-09-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/工作日常/" itemprop="url" rel="index">
                    <span itemprop="name">工作日常</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/09/01/es数据被黑事件记录和处理/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/09/01/es数据被黑事件记录和处理/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h3><p><code>时间</code>: 2020年8月30日 4点10分</p>
<p>es中所有open的日志全被删掉，包括系统日志，只留下一个read_me</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"read_me"</span>: &#123;</div><div class="line">    <span class="string">"aliases"</span>: &#123;&#125;,</div><div class="line">    <span class="string">"mappings"</span>: &#123;</div><div class="line">      <span class="string">"_doc"</span>: &#123;</div><div class="line">        <span class="string">"properties"</span>: &#123;</div><div class="line">          <span class="string">"@timestamp"</span>: &#123;</div><div class="line">            <span class="string">"type"</span>: <span class="string">"date"</span></div><div class="line">          &#125;,</div><div class="line">          <span class="string">"message"</span>: &#123;</div><div class="line">            <span class="string">"type"</span>: <span class="string">"text"</span>,</div><div class="line">            <span class="string">"fields"</span>: &#123;</div><div class="line">              <span class="string">"keyword"</span>: &#123;</div><div class="line">                <span class="string">"type"</span>: <span class="string">"keyword"</span>,</div><div class="line">                <span class="string">"ignore_above"</span>: <span class="number">256</span></div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"settings"</span>: &#123;</div><div class="line">      <span class="string">"index"</span>: &#123;</div><div class="line">        <span class="string">"creation_date"</span>: <span class="string">"1598760619467"</span>,</div><div class="line">        <span class="string">"number_of_shards"</span>: <span class="string">"5"</span>,</div><div class="line">        <span class="string">"number_of_replicas"</span>: <span class="string">"1"</span>,</div><div class="line">        <span class="string">"uuid"</span>: <span class="string">"cL_kgJ_XQqe2lSgOrN4VUw"</span>,</div><div class="line">        <span class="string">"version"</span>: &#123;</div><div class="line">          <span class="string">"created"</span>: <span class="string">"6030299"</span></div><div class="line">        &#125;,</div><div class="line">        <span class="string">"provided_name"</span>: <span class="string">"read_me"</span></div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="string">"message"</span>: <span class="string">"SEND 0.015 BTC TO THIS WALLET: 1BJxnAYaaWNbQcL9o9GS768v3VqVMNDusD IF YOU WANT RECOVER YOUR DATABASE! SEND TO THIS EMAIL YOUR SERVER IP AFTER SENDING THE BITCOINS getbase@cock.li"</span></div></pre></td></tr></table></figure>
<p>网络i/o没有突增，所以数据并没有被移走，而是直接被删掉了</p>
<h4 id="影响"><a href="#影响" class="headerlink" title="影响"></a>影响</h4><p><code>数据丢失</code>：es所在云盘有快照备份，可以从28号早上五点的恢复，丢失数据即28，29号和30号一部分，周末基本无日志，所以主要<strong>损失28号当前的请求日志</strong></p>
<p><code>修复成本</code>: 导出30号之后的日志，然后回滚磁盘，操作简单但耗时较长，预计影响时间3小时，后期考虑是否更换云盘类型，提高备份和回滚速度</p>
<h3 id="漏洞查找"><a href="#漏洞查找" class="headerlink" title="漏洞查找"></a>漏洞查找</h3><ul>
<li>es没有密码保护</li>
</ul>
<p>操作es有三种个途径，一是ip直接访问，二是通过内网slb访问，三是使用kibana</p>
<p>这三者都在内网中<strong>需要ecs安全组访问白名单</strong>，检查不存在大范围的ip授权，除了阿里云自动添加的ip段较大（到24位），但平时<code>添加公司ip过期没有及时删除</code></p>
<p>检索slb中与发生时间相近的日志，条件过滤<code>request_method: DELETE</code>,查到了大量删除请求,再根据<code>http_user_agent: python-requests/2.18.4</code>为条件过滤得到了完整的攻击请求</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">08<span class="string">-28</span> 23:38:25</div><div class="line">client_ip:  195.54.161.252</div><div class="line">client_port:  60516</div><div class="line">http_host:   *.*.*.*:9200</div><div class="line">http_user_agent:  python-requests/2.18.4</div><div class="line">request_method:  HEAD</div><div class="line">request_uri:  /</div><div class="line">slb_vport:  9200</div><div class="line"><span class="keyword">time:</span>  2020<span class="string">-08</span><span class="string">-28</span>T23:38:25<span class="string">+08</span>:00</div><div class="line">upstream_addr:  *.*.*.*:32101</div><div class="line">vip_addr:   *.*.*.*</div><div class="line"></div><div class="line">08<span class="string">-28</span> 23:38:28</div><div class="line">client_ip:  195.54.161.252</div><div class="line">client_port:  39732</div><div class="line">http_host:  *.*.*.*:9200</div><div class="line">http_user_agent:  python-requests/2.18.4</div><div class="line">request_method:  GET</div><div class="line">request_uri:  /_all/</div><div class="line">slb_vport:  9200</div><div class="line"><span class="keyword">time:</span>  2020<span class="string">-08</span><span class="string">-30</span>T12:10:19<span class="string">+08</span>:00</div><div class="line">upstream_addr: *.*.*.*</div><div class="line">vip_addr:  *.*.*.*</div><div class="line"></div><div class="line">08<span class="string">-28</span> 23:38:36</div><div class="line">client_ip:  195.54.161.252</div><div class="line">client_port:  32844</div><div class="line">http_host:  *.*.*.*:9200</div><div class="line">http_user_agent:  python-requests/2.18.4</div><div class="line">request_method:  DELETE</div><div class="line">request_uri:  /log_saas_develop<span class="string">-2020</span>.07.21/</div><div class="line">slb_vport:  9200</div><div class="line"><span class="keyword">time:</span>  2020<span class="string">-08</span><span class="string">-28</span>T23:38:36<span class="string">+08</span>:00</div><div class="line">upstream_addr:  *.*.*.*:32101</div><div class="line">vip_addr:  *.*.*.*</div><div class="line"></div><div class="line">...</div></pre></td></tr></table></figure>
<p>一共发起了<strong>两次攻击</strong>，第一次发生在<code>08-28 23:38:25</code>,第二次是在<code>08-30 12:10:19</code></p>
<p><code>http_host</code>是一个公网ip，一开始在slb和ecs中都没查到，后来发现是我使用的阿里云子账号权限不够看不到EIP =_=||</p>
<p>漏洞: <strong>内网slb绑定了公网eip，没有访问控制，也没有改es默认端口</strong>,被暴利扫描的脚本发现</p>
<h3 id="问题处理"><a href="#问题处理" class="headerlink" title="问题处理"></a>问题处理</h3><p><code>出现问题的原因</code>: 原先es绑定的内网slb是单纯为es使用<strong>端口设为默认9200</strong>，方便内网中其他服务通过域名访问到es，后被<strong>合并到slb ops-k8s-cluster</strong>，但该slb是绑定在k8s上并<strong>提供了EIP给k8s的api server</strong>，导致es暴露到公网中，没有访问控制且未修改端口</p>
<p><code>处理方法</code>: <strong>增加访问控制</strong>，采用和ecs相同的方式刷白名单，<strong>不使用默认端口9200</strong></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>未被保护的资产暴露到公网被暴力扫描脚本攻击</p>
<h4 id="发现问题与自检"><a href="#发现问题与自检" class="headerlink" title="发现问题与自检"></a>发现问题与自检</h4><ol>
<li>暴露公网ip的服务（slb,ecs,rds）<strong>必须配置访问控制</strong></li>
<li>自建的公共服务（es,redis,gitlab,jenkins,spinnaker等）<strong>禁止使用默认端口</strong></li>
<li>自建服务<strong>只能通过域名访问</strong>，避免无访问记录</li>
<li>云盘快照备份中只备份工作日的配置不合理，原先是周一到周五，需改为周二到周六</li>
<li>定期更换服务密码</li>
</ol>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/08/27/分布式任务平台设计概要/" itemprop="url">
                  分布式任务平台设计概要
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2020-08-27T15:45:36+08:00" content="2020-08-27">
              2020-08-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/工作日常/" itemprop="url" rel="index">
                    <span itemprop="name">工作日常</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/08/27/分布式任务平台设计概要/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/08/27/分布式任务平台设计概要/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="任务"><a href="#任务" class="headerlink" title="任务"></a>任务</h3><h4 id="记录"><a href="#记录" class="headerlink" title="记录"></a>记录</h4><p>从mq获取任务，再记录到job表,记录的信息有 funcName，args，createUser，priority，serviceName</p>
<h4 id="读取"><a href="#读取" class="headerlink" title="读取"></a>读取</h4><p>从job表读取任务</p>
<p><code>限流</code>: 当待执行队列长度超<strong>missionQueueSize</strong>则等待<strong>readTimeDelayMillsWhenFlowControl</strong>后重新执行</p>
<p><code>限频</code>: 每隔<strong>readInterval</strong>读取任务</p>
<h4 id="执行"><a href="#执行" class="headerlink" title="执行"></a>执行</h4><p>从待执行队列中取出任务发送给worker</p>
<p><code>并发</code>：根据<strong>parallelConsumeLimit</strong>限制，同时发送任务</p>
<p>当无任务时等待<strong>get_new_mission</strong>事件触发</p>
<p>发送任务时不等待结果，然后修改job表中任务状态为<strong>E</strong></p>
<h4 id="完成"><a href="#完成" class="headerlink" title="完成"></a>完成</h4><p>监听etcd完成任务的信息写入</p>
<p>按执行结果修改job表中任务状态，从<strong>missionInProcessMap</strong>中删除该任务</p>
<h4 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h4><p>定期检查执行中的任务状态，主要是执行时间</p>
<p>对于执行<strong>missionOutT重试超过限制ime</strong>超时的任务重新加入任务队列，重试超次数<strong>retryTimes</strong>的任务则在job表中标记为<strong>F</strong>,失败原因为重试超过限制</p>
<h3 id="master"><a href="#master" class="headerlink" title="master"></a>master</h3><h4 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h4><p>将任务完成信息同步到etcd中<br>优势：</p>
<ol>
<li>主动通知任务完成，实现方便，无需master等待完成结果</li>
<li>避免进度丢失，单点问题</li>
<li>可以查询记录</li>
<li>master选举</li>
</ol>
<h5 id="master选举"><a href="#master选举" class="headerlink" title="master选举"></a>master选举</h5><p>key为/mif/schedule/leader,当版本为0时创建并设置ttl,其他scheduler监听该key，当失效时重新选举</p>
<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p>service/job/init</p>
<ol>
<li>读取etcd中已存在的任务（已完成master未处理）</li>
<li>从job表载入正在执行的任务，加入missionInProcessMap</li>
<li>启动监听etcd任务完成put事件</li>
<li>执行<a href="#检查">任务检查</a></li>
<li>执行<a href="#完成">任务完成</a></li>
<li>开始循环读取任务,检查任务,执行任务</li>
</ol>
<h4 id="发送任务"><a href="#发送任务" class="headerlink" title="发送任务"></a>发送任务</h4><p>通过http post触发部署在函数计算中的worker</p>
<ul>
<li>fc判断服务启动完成存在问题，在启动未完成时接受请求返回502</li>
</ul>
<p>当请求返回此错误时，采取重试</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (response.data.errorMessage.indexOf(<span class="string">'Process exited unexpectedly before completing request'</span>) !== <span class="number">-1</span>) &#123;</div><div class="line">  <span class="keyword">const</span> &#123; missionId, serviceName, funcName, args &#125; = data;</div><div class="line">  app.logger.error(error);</div><div class="line">  <span class="keyword">return</span> app.send(missionId, serviceName, funcName, args);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="worker"><a href="#worker" class="headerlink" title="worker"></a>worker</h3><p>部署在函数计算，节省资源，方便扩容，无需健康检查</p>
<p>接收任务与rpc处理逻辑类似不再重复<br>·</p>
<h4 id="中间件finishMission"><a href="#中间件finishMission" class="headerlink" title="中间件finishMission"></a>中间件finishMission</h4><p>待执行完成后向etcd插入结果</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">await</span> next();</div><div class="line"><span class="keyword">if</span> (!ctx.missionId) <span class="keyword">return</span>;</div><div class="line"><span class="keyword">await</span> ctx.app.etcdMission.put(<span class="string">'finish/'</span> + ctx.missionId).value(<span class="built_in">JSON</span>.stringify(&#123;</div><div class="line">  <span class="attr">missionId</span>: ctx.missionId,</div><div class="line">  <span class="attr">time</span>: <span class="built_in">Date</span>.now(),</div><div class="line">  <span class="attr">status</span>: <span class="string">'S'</span>,</div><div class="line">&#125;));</div></pre></td></tr></table></figure>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/08/19/SaaS工程编译/" itemprop="url">
                  SaaS工程编译
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2020-08-19T13:30:26+08:00" content="2020-08-19">
              2020-08-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/工作日常/" itemprop="url" rel="index">
                    <span itemprop="name">工作日常</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/08/19/SaaS工程编译/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/08/19/SaaS工程编译/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="webpack配置"><a href="#webpack配置" class="headerlink" title="webpack配置"></a>webpack配置</h3><ul>
<li>将工程打包到一个文件中</li>
</ul>
<p>工程中使用<code>app-module-path</code>设置src为根路径，所以在打包时需要对src做替换</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="attr">entry</span>: <span class="string">'./index.js'</span>,</div><div class="line">  <span class="attr">target</span>: <span class="string">'node'</span>,</div><div class="line">  <span class="attr">output</span>: &#123;</div><div class="line">    <span class="attr">filename</span>: <span class="string">'bundle.js'</span>,</div><div class="line">    <span class="attr">path</span>: __dirname</div><div class="line">  &#125;,</div><div class="line">  <span class="comment">// devtool: 'inline-source-map',</span></div><div class="line">  externals: _externals(),</div><div class="line">  <span class="attr">resolve</span>:&#123;</div><div class="line">    <span class="attr">alias</span>: &#123;</div><div class="line">      <span class="attr">config</span>: path.resolve(__dirname, <span class="string">'config.js'</span>),</div><div class="line">      <span class="string">'src'</span>: path.resolve(__dirname, <span class="string">'./src'</span>),</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">_externals</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">let</span> manifest = <span class="built_in">require</span>(<span class="string">'./package.json'</span>);</div><div class="line">  <span class="keyword">let</span> dependencies = manifest.dependencies;</div><div class="line">  <span class="keyword">let</span> externals = &#123;&#125;;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> p <span class="keyword">in</span> dependencies) &#123;</div><div class="line">    externals[p] = <span class="string">'commonjs '</span> + p;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> externals;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="动态引用转为静态引用脚本"><a href="#动态引用转为静态引用脚本" class="headerlink" title="动态引用转为静态引用脚本"></a>动态引用转为静态引用脚本</h3><p>工程通过读取目标来实现动态引用，只在执行时触发，导致两个问题：</p>
<ol>
<li>动态路径无法被webpack打包</li>
<li>转成静态引用后出现循环调用问题</li>
</ol>
<h4 id="生成静态引用脚本"><a href="#生成静态引用脚本" class="headerlink" title="生成静态引用脚本"></a>生成静态引用脚本</h4><p>生成对应目录</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> dir = dirname(__dirname)+<span class="string">'/src/routes'</span>;</div><div class="line"></div><div class="line"><span class="keyword">let</span> requireString=<span class="string">`'use strict';</span></div><div class="line"></div><div class="line">`</div><div class="line"></div><div class="line">fs.readdirSync(dir).filter(<span class="function"><span class="keyword">function</span> (<span class="params">file</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> (file.indexOf(<span class="string">'.'</span>) !== <span class="number">0</span>) &amp;&amp; (file !== <span class="string">'index.js'</span>) &amp;&amp; (file.slice(<span class="number">-3</span>) === <span class="string">'.js'</span>);</div><div class="line">  &#125;)</div><div class="line">  .forEach(<span class="function"><span class="keyword">function</span> (<span class="params">file</span>) </span>&#123;</div><div class="line">    requireString += <span class="string">`require('./<span class="subst">$&#123;basename(file)&#125;</span>');\n`</span></div><div class="line">  &#125;);</div><div class="line"></div><div class="line">fs.writeFileSync(dir+<span class="string">'/index.js'</span>,requireString)</div></pre></td></tr></table></figure>
<h4 id="循环调用"><a href="#循环调用" class="headerlink" title="循环调用"></a>循环调用</h4><p>工程service文件夹内部有相互调用，但直接引用index.js文件，转成静态引用后出现循环调用导致报错</p>
<p>通过Proxy来处理循环引用，原理是在init时只给个proxy对象，在正真调用时返回require对应的文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="keyword">new</span> <span class="built_in">Proxy</span>(&#123;&#125;, &#123;</div><div class="line">  <span class="attr">get</span>: <span class="function">(<span class="params">target, value</span>) =&gt;</span> &#123;</div><div class="line">  	<span class="comment">// 有些地方在init时就要获取具体的service (like, &#123;foo&#125; = service),所以需要多返回一层Proxy</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Proxy</span>(&#123;</div><div class="line">      <span class="attr">service</span>: value</div><div class="line">    &#125;, &#123;</div><div class="line">      <span class="attr">get</span>: <span class="function">(<span class="params">target, value</span>) =&gt;</span> &#123;</div><div class="line">        <span class="keyword">return</span> requireObj[target.service][value]</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h3 id="env文件处理"><a href="#env文件处理" class="headerlink" title=".env文件处理"></a>.env文件处理</h3><p>增加另外的启动文件run.js,加.env加到环境变量中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="built_in">require</span>(<span class="string">'dotenv'</span>).config(&#123;<span class="attr">path</span>:__dirname+<span class="string">'/.env'</span>&#125;)</div><div class="line"></div><div class="line">process.env.APP_HOME = __dirname;</div><div class="line">process.env.pkg = <span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="built_in">require</span>(<span class="string">'./bundle.js'</span>);</div></pre></td></tr></table></figure>
<h3 id="pkg编译"><a href="#pkg编译" class="headerlink" title="pkg编译"></a>pkg编译</h3><p>将<strong>run.js</strong>设为编译入口，再引入.env和grpc.proto，node_modules也会打包编译进去</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// package.json</span></div><div class="line">  </div><div class="line">  <span class="string">"bin"</span>: <span class="string">"run.js"</span>,</div><div class="line">  <span class="string">"pkg"</span>:&#123;</div><div class="line">    <span class="string">"assets"</span>: [<span class="string">".env"</span>,<span class="string">"grpc.proto"</span>]</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>最后生成saas的执行文件</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/07/18/分布式事务/" itemprop="url">
                  分布式事务
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2020-07-18T17:48:49+08:00" content="2020-07-18">
              2020-07-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/07/18/分布式事务/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/07/18/分布式事务/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>分布式事务是指是指事务的发起者、参与者、数据资源服务器以及事务管理器分别位于分布式系统的不同节点之上<br>参与者通过网络通信来达到分布式一致性，网络通信不可避免出现失败、超时的情况</p>
<h3 id="XA-Specification"><a href="#XA-Specification" class="headerlink" title="XA Specification"></a>XA Specification</h3><p>基于资源层的底层分布式事务解决方案，对业务的入侵度较低</p>
<p>有些数据分片框架或者中间件也支持XA协议，兼容性、普遍性好 但<strong>并发性能比较差</strong>， 基于XA的分布式事务如果要严格保证ACID，实际需要事务隔离级别为<strong>SERLALIZABLE</strong></p>
<h3 id="基于消息的分布式事务"><a href="#基于消息的分布式事务" class="headerlink" title="基于消息的分布式事务"></a>基于消息的分布式事务</h3><p>通过消息系统来通知其他事务参与方自己事务的执行状态，有效的将事务参与方解耦，各个参与方可以异步执行</p>
<p><code>难点</code>: 解决本地事务执行和消息发送的一致性：两者要同时执行成功或者同时取消执行</p>
<p><code>场景</code>: 原则上只接受下游分支事务的成功，不接受事务的回滚，如果失败就要一直重试，适用于对最终一致性敏感度较低的业务场景</p>
<p>可能会因为接收方的消息堆积导致长时间的数据不一致</p>
<h4 id="基于事务消息"><a href="#基于事务消息" class="headerlink" title="基于事务消息"></a>基于事务消息</h4><p>事务消息发送成功后，处于 prepared 状态，不能被订阅者消费，等到事务消息的状态更改为可消费状态后，下游订阅者才可以监听到次消息。支持事务消息的 MQ 系统有一个定时扫描逻辑，扫描出状态仍然是“待发送”状态的消息，并向消息的发送方发起询问，询问这条事务消息的最终状态如何并根据结果更新事务消息的状态。</p>
<p>提供事务消息状态查询接口</p>
<h4 id="基于本地消息"><a href="#基于本地消息" class="headerlink" title="基于本地消息"></a>基于本地消息</h4><p>如果<strong>所依赖的 MQ 系统不支持事务消息</strong>，那么可以采用本地消息的分布式模式</p>
<p>事务的发起方维护一个本地消息表，业务执行和本地消息表的执行处在同一个本地事务中。业务执行成功，则同时记录一条“待发送”状态的消息到本地消息表中。系统中启动一个定时任务定时扫描本地消息表中状态为“待发送”的记录，并将其发送到 MQ 系统中，如果发送失败或者超时，则一直发送，知道发送成功后，从本地消息表中删除该记录</p>
<h4 id="最大努力通知型分布式事务"><a href="#最大努力通知型分布式事务" class="headerlink" title="最大努力通知型分布式事务"></a>最大努力通知型分布式事务</h4><p>基于 MQ 系统的一种解决方案，但是不要求 MQ 消息可靠（如支付宝支付成功通知），通过引入定期校验机制来对最终一致性做兜底，对业务侵入性较低、对 MQ 系统要求较低，实现比较简单，适合于对最终一致性敏感度比较低、业务链路较短的场景，比如跨平台、跨企业的系统间的业务交互</p>
<h3 id="基于补偿的事务"><a href="#基于补偿的事务" class="headerlink" title="基于补偿的事务"></a>基于补偿的事务</h3><p>事务补偿机制 ： 在事务链中的任何一个正向事务操作，都必须存在一个完全符合回滚规则的可逆事务</p>
<h4 id="TCC"><a href="#TCC" class="headerlink" title="TCC"></a>TCC</h4><p>将资源层的二阶段提交协议转换到业务层，成为业务模型中的一部分,核心思想是通过对资源的预留，尽早释放对资源的加锁，如果事务可以提交，则完成对预留资源的确认，如果事务要回滚，则释放预留的资源</p>
<p>业务设计和代码都会变复杂（需要业务方把功能的实现上由一个接口拆分为三个），但性能、隔离性都很好 </p>
<p>业务方在设计实现上要遵循三个策略（网络中的通信失败或超时）</p>
<ol>
<li>允许空回滚：try 失败或者没有执行 try 操作的参与方收到 cancel 请求时，要进行空回滚操作</li>
<li>保持幂等性：重复调用参与方的 confirm/cancel 方法，因此需要这两个方法实现上保证幂等性</li>
<li>防止资源悬挂：参与方侧 try 请求比 cancel 请求更晚到达的情况，cancel 会执行空回滚而确保事务的正确性，但是此时 try 方法也不可以再被执行</li>
</ol>
<p>支持 TCC 事务的开源框架有：ByteTCC、Himly、TCC-transaction。</p>
<h4 id="Saga模式"><a href="#Saga模式" class="headerlink" title="Saga模式"></a>Saga模式</h4><p>Saga 和 TCC 一样，也是一种补偿事务，但是它没有 try 阶段，而是把分布式事务看作一组本地事务构成的事务链</p>
<p>事务链中的<strong>每一个正向事务操作，都对应一个可逆的事务操作</strong>。Saga 事务协调器负责按照<strong>顺序执行事务链中的分支事务</strong>，分支事务执行完毕，即释放资源。如果某个分支事务失败了，则按照反方向执行事务补偿操作。<strong>如果补偿失败了，就一直重试，补偿操作可以优化为并行执行</strong></p>
<p><strong>不保证事务隔离性</strong>，本地事务提交后变更就对其他事务可见了。其他事务如果更改了已经提交成功的数据，可能会导致补偿操作失败。比如扣款失败，但是钱已经花掉了，<strong>业务设计上需要考虑这种场景并从业务设计上规避这种问题</strong></p>
<p><strong>不完美补偿</strong>，补偿操作会留下之前原始事务操作的痕迹，需要考虑对业务上的影响</p>
<p>要求业务设计实现上遵循三个策略：</p>
<ol>
<li>允许空补偿：网络异常导致事务的参与方只收到了补偿操作指令，因为没有执行过正常操作，因此要进行空补偿</li>
<li>保持幂等性：事务的正向操作和补偿操作都可能被重复触发，因此要保证操作的幂等性</li>
<li>防止资源悬挂：网络异常导致事务的正向操作指令晚于补偿操作指令到达，则要丢弃本次正常操作，否则会出现资源悬挂问题</li>
</ol>
<p><strong>适合于业务流程长的长事务的场景，实现上对业务侵入低，所以非常适合微服务架构的场景</strong>。同时 Saga 采用的是一阶段提交模式，不会对资源长时间加锁，不存在“木桶效应”，所以采用这种模式架构的<strong>系统性能高、吞吐高</strong></p>
<h3 id="阿里云分布式事务相关工具"><a href="#阿里云分布式事务相关工具" class="headerlink" title="阿里云分布式事务相关工具"></a>阿里云分布式事务相关工具</h3><p>DRDS 基于MySQL的XA实现，使用方便，但并发性能低 </p>
<p>GTS 全局事务服务 就提了个本地事务和mq能在一起提交</p>
<h4 id="seata"><a href="#seata" class="headerlink" title="seata"></a>seata</h4><p>通过全局锁实现了写隔离与读隔离</p>
<ul>
<li>一阶段本地事务提交前，需要确保先拿到 全局锁</li>
<li>拿不到 全局锁 ，不能提交本地事务。</li>
<li>拿 全局锁 的尝试被限制在一定范围内，超出范围将放弃，并回滚本地事务，释放本地锁</li>
</ul>
<p>开启本地事务，拿到本地锁，更新操作，本地事务提交前，先拿到该记录的 全局锁 ，本地提交释放本地锁。第二阶段提交释放 全局锁 </p>
<p>全局锁相当于写锁，但比由数据库实现性能好一些，<br>Seata（AT 模式）的<strong>默认全局隔离级别是 读未提交，会出现脏读，要拿读已提交需要全局锁</strong>，可以按业务做调整，但性能会好一些。全局锁会额外增加死锁的风险，但如果出现死锁，会不断进行重试，最后靠等待全局锁超时 </p>
<p>性能比XA好一点，第一阶段的提交会释放本地锁，但还存在全局锁，会阻塞写，但不影响默认的读未提交<br>XA的prepare是数据库实现的锁，而且要求事务串行执行</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/05/30/削足适履(Ten Pounds in a Five-Pound Sack)/" itemprop="url">
                  削足适履(Ten Pounds in a Five-Pound Sack)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2020-05-30T15:11:10+08:00" content="2020-05-30">
              2020-05-30
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/人月神话/" itemprop="url" rel="index">
                    <span itemprop="name">人月神话</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/05/30/削足适履(Ten Pounds in a Five-Pound Sack)/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/05/30/削足适履(Ten Pounds in a Five-Pound Sack)/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="规模控制"><a href="#规模控制" class="headerlink" title="规模控制"></a>规模控制</h3><ul>
<li>规模控制既是技术工作的一部分，也是管理工作的一部分</li>
</ul>
<p>把系统划分成若干部分，并设定每个部分的规模目标，对规模-速度权衡的各种情况有深刻的了解，并预留一些空间</p>
<p><code>制订总体规模的预算</code>：仅对核心程序设定规模目标是不够的，必须把所有的方面都编入预算</p>
<p><code>明确模块的功能</code>： 避免相互推脱</p>
<p><code>确保系统完整性、易用性</code>：培养开发人员从<strong>系统整体出发、面向用户的态度</strong>是软件编程管理人员最重要的职能，加强成员相关的沟通，避免每个人都只在局部优化自己的程序</p>
<h3 id="空间技能"><a href="#空间技能" class="headerlink" title="空间技能"></a>空间技能</h3><p>更多的功能意味着需要更多的空间</p>
<p>可以设计成拥有若干选项 分组，根据选项组来剪裁程序，但也要确定用户可选项目的粗细程度（实现成本）</p>
<p>培训：快速的学习和经验的广泛共享<br>公共组件：运行速度较快和短小精炼的，与系统设计工作并行进行</p>
<h3 id="数据的表现形式是编程的根本"><a href="#数据的表现形式是编程的根本" class="headerlink" title="数据的表现形式是编程的根本"></a>数据的表现形式是编程的根本</h3><p><strong>战略上突破常来自数据或表的重新表达</strong>（授权数据的重新设计）</p>
<p>回顾、 分析实际情况，仔细思考程序的数据</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/05/08/mq包更换/" itemprop="url">
                  mq包更换
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2020-05-08T13:48:49+08:00" content="2020-05-08">
              2020-05-08
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/工作日常/" itemprop="url" rel="index">
                    <span itemprop="name">工作日常</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/05/08/mq包更换/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/05/08/mq包更换/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><ol>
<li>封装http版本的包，现有的js tcp版包已不再更新，有兼容问题</li>
</ol>
<h3 id="设计点记录"><a href="#设计点记录" class="headerlink" title="设计点记录"></a>设计点记录</h3>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="https://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/05/08/rpc包更换/" itemprop="url">
                  rpc包更换
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2020-05-08T13:48:49+08:00" content="2020-05-08">
              2020-05-08
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/工作日常/" itemprop="url" rel="index">
                    <span itemprop="name">工作日常</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/05/08/rpc包更换/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/05/08/rpc包更换/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><ol>
<li>精简rpc包，剔除mq功能</li>
<li>使用egg agent,支持多worker启动（支持多worker意义不大，egg 3.0的milestone对docker的singleprocess会做优化，到时候再根据情况做调整）</li>
<li>提供尽量方便的配置性，支持开发自定义proto文件的同时不需要格外增加代码（屏蔽掉内部实现）</li>
</ol>
<h3 id="设计点记录"><a href="#设计点记录" class="headerlink" title="设计点记录"></a>设计点记录</h3><h4 id="client"><a href="#client" class="headerlink" title="client"></a>client</h4><ul>
<li>call</li>
</ul>
<p>连接断开: 连接断开后直接抛错，删掉记录的client，等待下次调用再发起连接,<strong>因为只有调用时才能执行建立连接</strong>,直接用调用方法重试容易出现死循环</p>
<p>报错: 通过判断response.body.code&lt;0,创建error,reject error</p>
<ul>
<li>stream</li>
</ul>
<p>连接断开: 连接断开后重试连接，通过监听error事件重试</p>
<h4 id="server"><a href="#server" class="headerlink" title="server"></a>server</h4><p>启动失败: 设计只支持发生在申请端口时，直接reject error</p>
<p>保存连接对应的client</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> <span class="built_in">key</span> = svcName + funcName + that._getRid();</div><div class="line"></div><div class="line">that.callHandle.<span class="built_in">set</span>(<span class="built_in">key</span>,client)</div></pre></td></tr></table></figure>
<p>触发rpcData时带上key</p>
<p>设置传输包大小</p>
<h3 id="改动范围"><a href="#改动范围" class="headerlink" title="改动范围"></a>改动范围</h3><h4 id="fx-rpc"><a href="#fx-rpc" class="headerlink" title="fx-rpc"></a>fx-rpc</h4><p>启动rpc服务,处理client发送的请求，调用本地方法</p>
<h5 id="传输格式"><a href="#传输格式" class="headerlink" title="传输格式"></a>传输格式</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">syntax = &quot;proto3&quot;;</div><div class="line"></div><div class="line">package fgrid;</div><div class="line"></div><div class="line">service Call &#123;</div><div class="line">  rpc Call (body) returns (body) &#123;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">message body &#123;</div><div class="line">  string body = 1;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="middle"><a href="#middle" class="headerlink" title="middle"></a>middle</h4><p>client发送rpc请求，格式参考部分JSON-RPC</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attribute">method</span>: targetArgs.<span class="built_in">join</span>(<span class="string">'.'</span>),</div><div class="line">  param: [ ...args, ctx.rpcCtx ],</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="https://schema.org/Person">
          <img class="site-author-image" src="http://wmtcore.com/uploads/avatar.png" alt="WMT" itemprop="image"/>
          <p class="site-author-name" itemprop="name">WMT</p>
        </div>
        <p class="site-description motion-element" itemprop="description">不扯犊子 -NOT ALONE</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">83</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">19</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">23</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/WMTcore" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015-12 - 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WMT</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"wmtcore"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     
     
  	  <script type="text/javascript">
  		var duoshuo_user_ID = 6224283662221837000
      var duoshuo_admin_nickname="作者"
  	  </script>
     
  	<script src="/js/ua-parser.min.js"></script>
  	<script src="/js/hook-duoshuo.js"></script>
  


    
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  

  
  

</body>
</html>
